-- Purpose: Advanced Minecraft-Style Admin Commands
-- Runs on: Server (ServerScriptService)
-- Public API: /give, /remove, /clear, /fly, /tp, /wallet, /bank
-- Security: Strict ID Whitelist, Anti-Duplicate logic, Secure Data Wiping

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- âš™ï¸ CONFIGURATION
local CarTools = ServerStorage:WaitForChild("CarTools") 
local FlyScriptTemplate = ServerStorage:WaitForChild("FlyClient", 5) 

-- âš ï¸ SECURITY: Add your UserID here
local ADMIN_USER_IDS = {
	[5512860740] = true, -- Your ID
}

local IS_STUDIO = RunService:IsStudio()
local CMD_DEBOUNCE = 0.3

-- ðŸ›¡ï¸ STATE
local AdminDebounces = {}
local ToolCache = nil
math.randomseed(os.time()) 

-- ðŸ”— API CONNECTION
local TycoonAdminAPI = ServerStorage:WaitForChild("TycoonAdminAPI", 10)

-- ============================================================================
-- ðŸ§  INTELLIGENT PARSING (Minecraft Style)
-- ============================================================================

local function getCleanID(rawName)
	if not rawName then return "" end
	local lower = rawName:lower()
	if lower:sub(-5) == " item" then return lower:sub(1, -6) end
	return lower
end

local function getAllTools()
	if ToolCache then return ToolCache end
	local tools = {}
	for _, t in pairs(CarTools:GetChildren()) do
		if t:IsA("Tool") then table.insert(tools, t) end
	end
	ToolCache = tools
	return tools
end
CarTools.ChildAdded:Connect(function() ToolCache = nil end)

-- Finds a tool by partial name (e.g. "civ" finds "Honda Civic")
local function matchTool(query)
	local target = getCleanID(query)
	local bestMatch = nil

	for _, tool in pairs(getAllTools()) do
		local id = getCleanID(tool.Name)
		
		-- 1. Exact Match (Highest Priority)
		if id == target then 
			return tool 
		end
		
		-- 2. Partial Match
		if id:find(target, 1, true) then
			bestMatch = tool
		end
	end
	return bestMatch
end

local function getOwnedSet(player)
	local set = {}
	local function scan(container)
		if not container then return end
		for _, t in pairs(container:GetChildren()) do
			if t:IsA("Tool") then 
				local id = t:GetAttribute("ToolId") or t.Name
				set[getCleanID(id)] = true 
			end
		end
	end
	scan(player:FindFirstChild("Backpack"))
	scan(player:FindFirstChild("StarterGear"))
	if player.Character then scan(player.Character) end
	return set
end

local function tagIssued(tool, realID)
	if not tool then return end
	tool:SetAttribute("IssuedByServer", true)
	tool:SetAttribute("IssuedAt", os.time())
	tool:SetAttribute("IssuedId", HttpService:GenerateGUID(false)) 
	tool:SetAttribute("ToolId", realID) 
	tool.CanBeDropped = false
end

-- ============================================================================
-- ðŸŽ¯ TARGET SELECTORS
-- ============================================================================
local function getTargets(speaker, selector)
	if not selector then return {} end
	selector = selector:lower()
	
	local allPlrs = Players:GetPlayers()
	
	if selector == "@s" or selector == "me" then 
		return {speaker} 
	elseif selector == "@a" or selector == "all" then 
		return allPlrs 
	elseif selector == "@r" or selector == "random" then
		return #allPlrs > 0 and {allPlrs[math.random(1, #allPlrs)]} or {}
	elseif selector == "@others" then
		local others = {}
		for _, p in pairs(allPlrs) do
			if p ~= speaker then table.insert(others, p) end
		end
		return others
	end

	-- Partial Name Match
	for _, p in pairs(allPlrs) do 
		if p.Name:lower() == selector or p.DisplayName:lower() == selector then return {p} end
	end
	for _, p in pairs(allPlrs) do 
		if p.Name:lower():sub(1, #selector) == selector then return {p} end
	end
	
	return {}
end

-- ============================================================================
-- âš¡ COMMAND ACTIONS
-- ============================================================================

local function Action_Give(player, tool, force)
	local backpack = player:WaitForChild("Backpack", 5)
	if not backpack then return false, "No Backpack" end
	local cleanID = getCleanID(tool.Name)
	local owned = getOwnedSet(player)

	-- If they already have it, warn the admin (unless forced)
	if owned[cleanID] and not force then 
		return false, "Already Owns Item" 
	end

	-- Give to Backpack
	local bpTool = tool:Clone()
	tagIssued(bpTool, tool.Name) 
	bpTool.Parent = backpack

	-- Give to StarterGear (Persistence)
	local sg = player:FindFirstChild("StarterGear")
	if sg then
		local sgTool = tool:Clone()
		tagIssued(sgTool, tool.Name)
		sgTool.Parent = sg
	end

	return true, "Given"
end

local function Action_Remove(player, toolName)
	local targetID = getCleanID(toolName)
	local count = 0

	local function scanAndDestroy(container)
		if not container then return end
		for _, t in pairs(container:GetChildren()) do
			if t:IsA("Tool") then
				local id = getCleanID(t:GetAttribute("ToolId") or t.Name)
				if id == targetID or (targetID == "all" or targetID == "*") then
					t:Destroy()
					count = count + 1
				end
			end
		end
	end

	scanAndDestroy(player:FindFirstChild("Backpack"))
	scanAndDestroy(player:FindFirstChild("StarterGear"))
	if player.Character then scanAndDestroy(player.Character) end

	return count > 0, count
end

local function Action_SetFlight(player, shouldFly)
	if not player.Character then return end
	local old = player.Character:FindFirstChild("FlyClient")
	
	if old then
		player.Character:SetAttribute("ForceStopFly", true)
		task.wait(0.1)
		old:Destroy()
		player.Character:SetAttribute("ForceStopFly", nil)
	end

	if shouldFly and FlyScriptTemplate then
		local scriptClone = FlyScriptTemplate:Clone()
		scriptClone.Name = "FlyClient"
		scriptClone.Parent = player.Character
		scriptClone.Disabled = false
	end
end

-- ============================================================================
-- ðŸ’¬ CHAT HANDLER
-- ============================================================================

Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)
		if not (IS_STUDIO or ADMIN_USER_IDS[player.UserId]) then return end

		-- Debounce
		local lastCmd = AdminDebounces[player.UserId] or 0
		if (os.clock() - lastCmd) < CMD_DEBOUNCE then return end
		AdminDebounces[player.UserId] = os.clock()

		if message:sub(1,1) ~= "/" then return end

		local args = message:split(" ")
		local command = args[1]:lower()

		-- ðŸŸ¢ /give [player] [item]
		if command == "/give" then
			local selector = args[2]
			local itemName = table.concat(args, " ", 3)
			if not selector or itemName == "" then return end

			local targets = getTargets(player, selector)
			
			-- âœ… SPECIAL LOGIC: /give [player] all
			if itemName:lower() == "all" then
				local allTools = getAllTools()
				for _, t in pairs(targets) do
					local count = 0
					for _, tool in pairs(allTools) do
						local success, _ = Action_Give(t, tool, false)
						if success then count = count + 1 end
					end
					print(string.format("ðŸŽ [Admin] Given %d NEW items to %s", count, t.Name))
				end
				return -- Stop here so we don't run the single item match
			end

			-- Normal Single Item Logic
			local tool = matchTool(itemName)

			if not tool then
				print("âŒ [Admin] Unknown Item: " .. itemName)
				return 
			end

			for _, t in pairs(targets) do
				local success, reason = Action_Give(t, tool, false)
				if success then
					print(string.format("âœ… Given [%s] to %s", tool.Name, t.Name))
				else
					print(string.format("âš ï¸ Failed to give [%s] to %s: %s", tool.Name, t.Name, reason))
				end
			end

		-- ðŸ”´ /remove [player] [item] (NEW)
		elseif command == "/remove" or command == "/take" then
			local selector = args[2]
			local itemName = table.concat(args, " ", 3)
			if not selector or itemName == "" then return end

			local targets = getTargets(player, selector)
			
			for _, t in pairs(targets) do
				local success, count = Action_Remove(t, itemName)
				if success then
					print(string.format("ðŸ—‘ï¸ Removed %d instance(s) of '%s' from %s", count, itemName, t.Name))
				else
					print(string.format("âš ï¸ %s does not have item: %s", t.Name, itemName))
				end
			end

		-- ðŸŸ¢ /clearinventory [player] (Keeps Money/Data, Wipes Tools)
		elseif command == "/clearinventory" or command == "/ci" then
			local selector = args[2]
			local targets = getTargets(player, selector)
			for _, t in pairs(targets) do
				Action_Remove(t, "all")
				print("ðŸ—‘ï¸ Cleared inventory of " .. t.Name)
			end

		-- âœˆï¸ /fly & /unfly
		elseif command == "/fly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do Action_SetFlight(t, true) end
			print("âœˆï¸ Flight Enabled")

		elseif command == "/unfly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do Action_SetFlight(t, false) end
			print("âœˆï¸ Flight Disabled")

		-- ðŸ’° /wallet & /bank [player] [amount]
		elseif command == "/wallet" or command == "/bank" then
			local selector = args[2]
			local amount = tonumber(args[3])
			if not selector or not amount then return end
			
			local statName = (command == "/bank") and "Cash" or "Wallet"
			local targets = getTargets(player, selector)

			for _, t in pairs(targets) do
				local ls = t:FindFirstChild("leaderstats")
				local stat = ls and ls:FindFirstChild(statName)
				if stat then
					stat.Value = stat.Value + amount
					print(string.format("ðŸ’° Added $%d to %s's %s", amount, t.Name, statName))
				end
			end

		-- ðŸ’£ /clear [player] (FULL WIPE)
		elseif command == "/clear" or command == "/wipe" then
			local selector = args[2]
			if not selector then return end
			local targets = getTargets(player, selector)
			
			if TycoonAdminAPI then
				for _, t in pairs(targets) do
					TycoonAdminAPI:Invoke("ForceWipe", t)
					print("ðŸ’€ FULL WIPE EXECUTED: " .. t.Name)
				end
			else
				warn("âŒ TycoonAdminAPI missing")
			end
			
		-- ðŸ“‹ /list (See available cars)
		elseif command == "/list" then
			print("ðŸš— Available Cars:")
			for _, t in pairs(getAllTools()) do
				print(" - " .. getCleanID(t.Name))
			end
		end
	end)
end)
