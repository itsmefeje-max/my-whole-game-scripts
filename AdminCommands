-- ( SERVER SCRIPT: AdminCommands )
-- Mimics Minecraft Bedrock's /give command syntax.
-- Usage: /give <target> <item_name> [amount]
-- Example: /give @s Centurion
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")

-- âš™ï¸ CONFIGURATION
local CarTools = ServerStorage:WaitForChild("CarTools") -- Where your tools live
local ADMIN_USER_IDS = {
	[5512860740] = true, -- REPLACE with your actual UserId
	-- [--] = true, -- Add friends here
}
local ALLOW_STUDIO_ADMIN = true -- Automatically admin if testing in Studio

-- ============================================================================
-- ğŸ¯ TARGET SELECTOR LOGIC (@s, @p, @a, @r, Name)
-- ============================================================================
local function getTargets(speaker, selector)
	local targets = {}
	local allPlayers = Players:GetPlayers()

	if selector == "@s" then
		-- Self
		table.insert(targets, speaker)

	elseif selector == "@a" then
		-- All Players
		targets = allPlayers

	elseif selector == "@r" then
		-- Random Player
		if #allPlayers > 0 then
			table.insert(targets, allPlayers[math.random(1, #allPlayers)])
		end

	elseif selector == "@p" then
		-- Nearest Player
		if not speaker.Character or not speaker.Character.PrimaryPart then return {} end
		local myPos = speaker.Character.PrimaryPart.Position
		local closestDist = math.huge
		local closestPlayer = nil

		for _, p in pairs(allPlayers) do
			if p ~= speaker and p.Character and p.Character.PrimaryPart then
				local dist = (p.Character.PrimaryPart.Position - myPos).Magnitude
				if dist < closestDist then
					closestDist = dist
					closestPlayer = p
				end
			end
		end
		-- If nobody else is near, @p usually defaults to self in MC, but strict nearest logic:
		if closestPlayer then 
			table.insert(targets, closestPlayer) 
		else
			table.insert(targets, speaker) -- Fallback to self if solo
		end

	else
		-- Specific Player Name (Partial Match Support)
		for _, p in pairs(allPlayers) do
			if p.Name:lower():sub(1, #selector) == selector:lower() then
				table.insert(targets, p)
				break -- Stop after finding first match
			end
		end
	end

	return targets
end

-- ============================================================================
-- ğŸ’ ITEM GIVING LOGIC
-- ============================================================================
local function giveItem(player, itemName, quantity)
	-- 1. Try to find the tool. Supports "CarName" and "CarName Item"
	local tool = CarTools:FindFirstChild(itemName) 
		or CarTools:FindFirstChild(itemName .. " Item")
		or CarTools:FindFirstChild(itemName .. "Item")

	if tool then
		for i = 1, quantity do
			-- Clone to Backpack (Inventory)
			local clone = tool:Clone()
			clone.Parent = player.Backpack

			-- Clone to StarterGear (Persists after death)
			local gearClone = tool:Clone()
			gearClone.Parent = player.StarterGear
		end
		return true, tool.Name
	else
		return false, nil
	end
end

-- ============================================================================
-- ğŸ’¬ CHAT PARSER
-- ============================================================================
Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)

		-- ğŸ›¡ï¸ 1. CHECK PERMISSIONS
		local isAdmin = ADMIN_USER_IDS[player.UserId] or (ALLOW_STUDIO_ADMIN and game.PlaceId == 0) -- 0 = Studio
		if not isAdmin then return end

		-- âœ‚ï¸ 2. SPLIT MESSAGE
		-- Pattern: /give <target> <item> [amount]
		local args = message:split(" ")
		if args[1]:lower() ~= "/give" then return end

		-- ğŸ›‘ 3. VALIDATE ARGUMENTS
		local selector = args[2]
		local itemName = args[3]
		local amount = tonumber(args[4]) or 1 -- Default to 1 if missing

		if not selector or not itemName then
			warn("âŒ Usage: /give <target> <item> [amount]")
			return
		end

		-- ğŸ¯ 4. GET TARGETS
		local targetPlayers = getTargets(player, selector)
		if #targetPlayers == 0 then
			warn("âŒ No targets found for selector: " .. selector)
			return
		end

		-- ğŸ 5. GIVE ITEMS
		for _, target in pairs(targetPlayers) do
			local success, realName = giveItem(target, itemName, amount)
			if success then
				print("âœ… Gave " .. amount .. "x [" .. realName .. "] to " .. target.Name)
			else
				warn("âŒ Could not find item in CarTools: " .. itemName)
			end
		end
	end)
end)
