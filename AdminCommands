-- [[ SERVER SCRIPT: AdminCommands (V9 Universal Fix) ]]
-- FEATURES: Works on ALL Chat Systems, Smart Caching, Safe Flight
-- LOCATION: ServerScriptService > Script
-- FIXED: 'ToolId' Attribute now uses Exact Case-Sensitive Names (Prevents Deletion by Security)

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- ‚öôÔ∏è CONFIGURATION
local CarTools = ServerStorage:WaitForChild("CarTools") 
local FlyScriptTemplate = ServerStorage:WaitForChild("FlyClient", 5) 

local ADMIN_USER_IDS = {
	[5512860740] = true, -- Your ID
}

local IS_STUDIO = RunService:IsStudio()
local MAX_INVENTORY_SIZE = 500
local CMD_DEBOUNCE = 0.5 

-- üõ°Ô∏è STATE
local AdminDebounces = {}
local ToolCache = nil
math.randomseed(os.time()) 

if IS_STUDIO then
	print("‚ö†Ô∏è [AdminCommands]: Studio Mode - Everyone is Admin!")
end

if not FlyScriptTemplate then
	warn("‚ùå CRITICAL: 'FlyClient' missing in ServerStorage!")
end

-- ============================================================================
-- üõ°Ô∏è HELPERS
-- ============================================================================

local function getCleanID(rawName)
	if not rawName then return "" end
	local lower = rawName:lower()
	if lower:sub(-5) == " item" then return lower:sub(1, -6) end
	return lower
end

local function getToolIDFromObject(tool)
	-- ‚úÖ FIX: Force normalize ID for internal checking
	-- Even if the Attribute is Case-Sensitive (e.g. "Delta"), we return "delta"
	-- so the Admin script correctly detects duplicates.
	local id = tool:GetAttribute("ToolId")
	if id then return getCleanID(id) end
	return getCleanID(tool.Name)
end

-- ‚úÖ CACHE: Validates /give all performance
local function getAllTools()
	if ToolCache then return ToolCache end
	local tools = {}
	for _, t in pairs(CarTools:GetChildren()) do
		if t:IsA("Tool") then table.insert(tools, t) end
	end
	ToolCache = tools
	return tools
end
CarTools.ChildAdded:Connect(function() ToolCache = nil end)
CarTools.ChildRemoved:Connect(function() ToolCache = nil end)

local function getOwnedSet(player)
	local set = {}
	local function scan(container)
		if not container then return end
		for _, t in pairs(container:GetChildren()) do
			if t:IsA("Tool") then set[getToolIDFromObject(t)] = true end
		end
	end
	scan(player:FindFirstChild("Backpack"))
	scan(player:FindFirstChild("StarterGear"))
	if player.Character then scan(player.Character) end
	return set
end

local function countSetSize(set)
	local count = 0
	for _ in pairs(set) do count += 1 end
	return count
end

local function tagIssued(tool, realID)
	if not tool then return end
	tool:SetAttribute("IssuedByServer", true)
	tool:SetAttribute("IssuedAt", os.time())
	tool:SetAttribute("ToolId", realID) -- ‚úÖ USES EXACT NAME NOW
	tool.CanBeDropped = false
end

local function findTool(itemName)
	local target = getCleanID(itemName)
	for _, tool in pairs(CarTools:GetChildren()) do
		if tool:IsA("Tool") then
			local tID = getCleanID(tool.Name)
			if tID == target then return tool end
		end
	end
	return nil
end

local function getTargets(speaker, selector)
	if not selector then return {} end
	selector = selector:lower()
	if selector == "@s" or selector == "me" then return {speaker} end
	if selector == "@a" or selector == "all" then return Players:GetPlayers() end
	if selector == "@r" or selector == "random" then
		local plrs = Players:GetPlayers()
		return #plrs > 0 and {plrs[math.random(1, #plrs)]} or {}
	end
	local candidates = Players:GetPlayers()
	for _, p in pairs(candidates) do 
		if p.Name:lower() == selector or p.DisplayName:lower() == selector then return {p} end
	end
	for _, p in pairs(candidates) do 
		if p.Name:lower():sub(1, #selector) == selector then return {p} end
	end
	return {}
end

-- ============================================================================
-- ‚ö° ACTIONS
-- ============================================================================

local function setFlight(player, shouldFly)
	if not player.Character then return end

	-- ‚úÖ SAFETY: Only warn, don't break if user forgot to make it a LocalScript
	if shouldFly and FlyScriptTemplate and not FlyScriptTemplate:IsA("LocalScript") then
		warn("‚ö†Ô∏è [Admin]: 'FlyClient' in ServerStorage should be a LocalScript!")
	end

	local old = player.Character:FindFirstChild("FlyClient")
	if old then
		player.Character:SetAttribute("ForceStopFly", true)
		task.wait(0.1)
		old:Destroy()
		player.Character:SetAttribute("ForceStopFly", nil)
	end

	if shouldFly and FlyScriptTemplate then
		local scriptClone = FlyScriptTemplate:Clone()
		scriptClone.Name = "FlyClient"
		scriptClone.Parent = player.Character
		scriptClone.Disabled = false
	end
end

local function giveItem(player, tool, cleanID, optionalOwnedSet)
	local backpack = player:WaitForChild("Backpack", 5)
	if not backpack then return false end

	-- Check duplicates using lowercase ID (Internal Logic)
	if optionalOwnedSet then
		if optionalOwnedSet[cleanID] then return false end
	else
		local currentSet = getOwnedSet(player)
		if currentSet[cleanID] then return false end
	end

	local bpTool = tool:Clone()

	-- ‚úÖ FIX: Pass tool.Name (Exact Case) instead of cleanID (Lowercase)
	-- This ensures TycoonDataHandler accepts the tool as valid.
	tagIssued(bpTool, tool.Name) 

	bpTool.Parent = backpack
	local sg = player:FindFirstChild("StarterGear")
	if sg then
		local sgTool = tool:Clone()
		tagIssued(sgTool, tool.Name)
		sgTool.Parent = sg
	end
	return true
end

local function clearInventory(player, forceAll)
	local function wipe(container)
		if not container then return end
		for _, item in pairs(container:GetChildren()) do
			if item:IsA("Tool") then
				if forceAll or item:GetAttribute("IssuedByServer") then
					item:Destroy()
				end
			end
		end
	end
	wipe(player:FindFirstChild("Backpack"))
	wipe(player:FindFirstChild("StarterGear"))
	if player.Character then wipe(player.Character) end
end

-- ============================================================================
-- üí¨ CHAT HANDLER (UNIVERSAL - WORKS EVERYWHERE)
-- ============================================================================

Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)
		if not (IS_STUDIO or ADMIN_USER_IDS[player.UserId]) then return end

		-- Debounce
		local lastCmd = AdminDebounces[player.UserId] or 0
		if (os.clock() - lastCmd) < CMD_DEBOUNCE then return end
		AdminDebounces[player.UserId] = os.clock()

		if message:sub(1,1) ~= "/" then return end

		local args = message:split(" ")
		local command = args[1]:lower()

		-- [[ /give ]]
		if command == "/give" then
			local selector = args[2]
			local itemName = table.concat(args, " ", 3)
			if not selector or itemName == "" then return end

			local targets = getTargets(player, selector)
			if #targets == 0 then return end

			if itemName:lower() == "all" or itemName:lower() == "everything" then
				local allTools = getAllTools()
				for _, t in pairs(targets) do
					local ownedSet = getOwnedSet(t)
					local currentCount = countSetSize(ownedSet)
					local seenIDs = {}
					local newToolsCount = 0

					for _, tool in pairs(allTools) do
						local id = getCleanID(tool.Name)
						if not seenIDs[id] then
							seenIDs[id] = true
							if not ownedSet[id] then newToolsCount += 1 end
						end
					end

					if (currentCount + newToolsCount) <= MAX_INVENTORY_SIZE then
						local givenThisLoop = {}
						for _, tool in pairs(allTools) do
							local id = getCleanID(tool.Name)
							if not givenThisLoop[id] then
								givenThisLoop[id] = true
								if giveItem(t, tool, id, ownedSet) then ownedSet[id] = true end
							end
						end
						print("‚úÖ [Admin] Given ALL to " .. t.Name)
					else
						warn("‚ùå [Admin] Inventory full for " .. t.Name)
					end
				end
				return
			end

			local tool = findTool(itemName)
			if tool then
				local cleanID = getCleanID(tool.Name)
				for _, t in pairs(targets) do
					local ownedSet = getOwnedSet(t)
					local currentCount = countSetSize(ownedSet)
					if (not ownedSet[cleanID]) and (currentCount + 1 > MAX_INVENTORY_SIZE) then
						warn("‚ùå [Admin] Inventory full for " .. t.Name)
					else
						giveItem(t, tool, cleanID, ownedSet)
						print("‚úÖ [Admin] Given " .. tool.Name .. " to " .. t.Name)
					end
				end
			end

			-- [[ /fly & /unfly ]]
		elseif command == "/fly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do
				setFlight(t, true)
				print("‚úàÔ∏è Flight Enabled: " .. t.Name)
			end

		elseif command == "/unfly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do
				setFlight(t, false)
				print("üõë Flight Disabled: " .. t.Name)
			end

			-- [[ /clear & /clearall ]]
		elseif command == "/clear" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do
				clearInventory(t, false)
				print("üóëÔ∏è Cleared admin items: " .. t.Name)
			end

		elseif command == "/clearall" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do
				clearInventory(t, true)
				print("‚ö†Ô∏è WIPED Inventory: " .. t.Name)
			end
		end
	end)
end)
