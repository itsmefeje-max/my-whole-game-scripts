-- [[ LOCAL SCRIPT: TabletVisuals ]]
-- Purpose: Handles Tablet Logic.
-- Updated: Now finds ClaimGUI inside 'ClaimPart' to match the Server Script.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local TabletEvent = ReplicatedStorage:WaitForChild("TabletEvent")
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- ‚öôÔ∏è CONFIGURATION
local HOVER_SCALE = 1.1
local HOVER_SPEED = 0.2
local CLICK_SOUND_ID = "rbxassetid://9083627113" 
local HOVER_SOUND_ID = "rbxassetid://6895079853" 
local HOVER_VOLUME = 0.5

-- üõ†Ô∏è HELPER: The "Z-Offset" Fix
local function enableClicking(gui, part)
	if not gui then return end

	-- 1. Move to PlayerGui
	if gui.Parent ~= playerGui then
		gui.Adornee = part 
		gui.Parent = playerGui 
	end

	gui.Active = true
	gui.Enabled = true
	gui.ResetOnSpawn = false

	-- üö´ TURN OFF OVERLAY (Fixes character clipping)
	gui.AlwaysOnTop = false 

	-- ‚úÖ TURN ON Z-OFFSET (Fixes clicking issues)
	gui.ZOffset = 100 

	-- Lighting
	gui.LightInfluence = 0.5 
end

-- üõ†Ô∏è ANIMATION TWEENS
local function addHoverEffect(button)
	if not button:IsA("GuiButton") then return end

	button.Active = true
	button.ZIndex = 50 -- Ensure button is above its own background

	local originalSize = button.Size

	-- Target Size (Centered Growth)
	local targetSize = UDim2.new(
		originalSize.X.Scale * HOVER_SCALE, 
		originalSize.X.Offset * HOVER_SCALE, 
		originalSize.Y.Scale * HOVER_SCALE, 
		originalSize.Y.Offset * HOVER_SCALE
	)

	-- HOVER ENTER
	button.MouseEnter:Connect(function()
		TweenService:Create(button, TweenInfo.new(HOVER_SPEED, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = targetSize}):Play()

		if HOVER_SOUND_ID ~= "" and HOVER_SOUND_ID ~= "rbxassetid://0" then
			local sound = Instance.new("Sound")
			sound.SoundId = HOVER_SOUND_ID
			sound.Volume = HOVER_VOLUME
			sound.Parent = SoundService
			sound:Play()
			game.Debris:AddItem(sound, 1)
		end
	end)

	-- HOVER LEAVE
	button.MouseLeave:Connect(function()
		TweenService:Create(button, TweenInfo.new(HOVER_SPEED, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = originalSize}):Play()
	end)

	-- CLICK
	button.MouseButton1Down:Connect(function()
		local sound = Instance.new("Sound")
		sound.SoundId = CLICK_SOUND_ID
		sound.Volume = 0.5
		sound.Parent = SoundService
		sound:Play()
		game.Debris:AddItem(sound, 1)
	end)
end

-- ============================================================================
-- üïµÔ∏è MONITOR & CONNECT
-- ============================================================================
local function setupClientTablet(plot)
	local model = plot:WaitForChild("ClaimEarnings", 30)
	if not model then return end

	-- [[ UPDATE: Look for ClaimPart instead of Earnings ]] --
	local claimPart = model:WaitForChild("ClaimPart", 10)
	
	-- Fallback: If ClaimPart isn't there, try the old one just in case
	if not claimPart then 
		claimPart = model:WaitForChild("Earnings", 1)
	end
	
	if not claimPart then return end

	local claimGui = claimPart:WaitForChild("ClaimGUI", 10)
	if not claimGui then return end

	-- ‚ö° APPLY THE FIX (Uses ClaimPart as the Adornee now)
	enableClicking(claimGui, claimPart)

	local btnNormal = claimGui:WaitForChild("ClaimButton", 10)
	local btn2X = claimGui:WaitForChild("ClaimButton2X", 10)

	if btnNormal then addHoverEffect(btnNormal) end
	if btn2X then addHoverEffect(btn2X) end

	if btnNormal then
		btnNormal.MouseButton1Click:Connect(function()
			btnNormal.ImageTransparency = 0.5
			task.delay(0.1, function() btnNormal.ImageTransparency = 0 end)
			TabletEvent:FireServer("Claim", plot.Name)
		end)
	end

	if btn2X then
		btn2X.MouseButton1Click:Connect(function()
			TabletEvent:FireServer("Prompt2X", plot.Name)
		end)
	end
end

task.wait(2) 
for _, plot in pairs(TycoonFolder:GetChildren()) do
	task.spawn(function() setupClientTablet(plot) end)
end

TycoonFolder.ChildAdded:Connect(function(plot)
	task.spawn(function() setupClientTablet(plot) end)
end)
