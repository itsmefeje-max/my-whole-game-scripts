-- [[ LOCAL SCRIPT: TabletVisuals ]]
-- Purpose: Handles Hover Animations, Click Detection, and SFX for the Tablet.
-- FIX: Automatically moves GUIs to PlayerGui to ensure clicking ALWAYS works.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local TabletEvent = ReplicatedStorage:WaitForChild("TabletEvent")
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- ‚öôÔ∏è CONFIGURATION
local HOVER_SCALE = 1.05 
local HOVER_SPEED = 0.2
local CLICK_SOUND_ID = "rbxassetid://9083627113"

-- üõ†Ô∏è HELPER: Make GUI Clickable (The "Adornee" Fix)
local function enableClicking(gui, part)
	if not gui then return end
	
	-- 1. Check if it's already fixed
	if gui.Parent == playerGui then return end
	
	-- 2. Clone/Move logic
	-- We reparent the GUI from Workspace -> PlayerGui
	-- This wakes up the buttons so they can receive input.
	gui.Adornee = part -- Tells it to "stick" visually to the tablet part
	gui.Parent = playerGui -- Moves logic to the player (Clickable!)
	
	-- 3. Ensure properties are correct for interaction
	gui.Active = true
	gui.Enabled = true
	-- Note: We DON'T use AlwaysOnTop unless you want it seeing through walls
end

-- üõ†Ô∏è ANIMATION TWEENS
local function addHoverEffect(button)
	if not button:IsA("GuiButton") then return end
	
	-- Ensure button is active
	button.Active = true
	
	local originalSize = button.Size
	local targetSize = UDim2.new(
		originalSize.X.Scale * HOVER_SCALE, originalSize.X.Offset,
		originalSize.Y.Scale * HOVER_SCALE, originalSize.Y.Offset
	)

	button.MouseEnter:Connect(function()
		TweenService:Create(button, TweenInfo.new(HOVER_SPEED), {Size = targetSize}):Play()
	end)

	button.MouseLeave:Connect(function()
		TweenService:Create(button, TweenInfo.new(HOVER_SPEED), {Size = originalSize}):Play()
	end)

	button.MouseButton1Down:Connect(function()
		local sound = Instance.new("Sound")
		sound.SoundId = CLICK_SOUND_ID
		sound.Volume = 0.5
		sound.Parent = SoundService
		sound:Play()
		game.Debris:AddItem(sound, 1)
	end)
end

-- ============================================================================
-- üïµÔ∏è MONITOR & CONNECT
-- ============================================================================
local function setupClientTablet(plot)
	local model = plot:WaitForChild("ClaimEarnings", 30)
	if not model then return end
	
	local part = model:WaitForChild("Earnings", 10)
	if not part then return end
	
	local claimGui = part:WaitForChild("ClaimGUI", 10)
	if not claimGui then return end

	-- ‚ö° APPLY THE FIX: Move GUI to PlayerGui
	enableClicking(claimGui, part)

	-- Find Buttons (Now they are inside PlayerGui, so we search safely)
	local btnNormal = claimGui:WaitForChild("ClaimButton", 10)
	local btn2X = claimGui:WaitForChild("ClaimButton2X", 10)

	-- 1. APPLY ANIMATIONS
	if btnNormal then addHoverEffect(btnNormal) end
	if btn2X then addHoverEffect(btn2X) end

	-- 2. HANDLE CLICKS (Fire Server)
	if btnNormal then
		btnNormal.MouseButton1Click:Connect(function()
			-- Visual feedback
			btnNormal.ImageTransparency = 0.5
			task.delay(0.1, function() btnNormal.ImageTransparency = 0 end)
			
			TabletEvent:FireServer("Claim", plot.Name)
		end)
	end

	if btn2X then
		btn2X.MouseButton1Click:Connect(function()
			TabletEvent:FireServer("Prompt2X", plot.Name)
		end)
	end
end

-- Initialize
task.wait(2) -- Wait for Tycoons to load fully
for _, plot in pairs(TycoonFolder:GetChildren()) do
	task.spawn(function() setupClientTablet(plot) end)
end

TycoonFolder.ChildAdded:Connect(function(plot)
	task.spawn(function() setupClientTablet(plot) end)
end)
