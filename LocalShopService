-- [[ SERVER SCRIPT: LocalShopService (Sound Fix) ]]
-- UPDATED: Sends a "Reason" tag ("Auto", "Reroll", "Purchase") so Client knows which sound to play.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- âš™ï¸ CONFIGURATION
local SHOP_CARS = {"Delta", "Iva", "Atom", "Windsor", "Senator", "Riva"}
local CAR_WEIGHTS = {Delta = 50, Iva = 20, Atom = 15, Windsor = 9, Senator = 5, Riva = 1}

local ALWAYS_STOCK = {["Delta"] = true, ["Iva"] = true}
local RESTOCK_INTERVAL = 300 
local DEFAULT_LIMIT = 999999 -- Unlimited

-- ðŸ“‚ REMOTE SETUP
local Remotes = ReplicatedStorage:FindFirstChild("ShopRemotes")
if not Remotes then
	Remotes = Instance.new("Folder"); Remotes.Name = "ShopRemotes"; Remotes.Parent = ReplicatedStorage
end
local function getRemote(name, class)
	local r = Remotes:FindFirstChild(name)
	if not r then r = Instance.new(class); r.Name = name; r.Parent = Remotes end
	return r
end
local RemoteOpen = getRemote("OpenLocalShop", "RemoteEvent")
local RemoteUpdate = getRemote("ShopUpdate", "RemoteEvent")
local FuncGetState = getRemote("GetShopState", "RemoteFunction")
local FuncBuyCar = getRemote("BuyLocalCar", "RemoteFunction")

-- ðŸ”— BINDABLE FUNCTION (ServerStorage)
local RerollBindable = ServerStorage:FindFirstChild("ShopRerollFunction")
if not RerollBindable then
	RerollBindable = Instance.new("BindableFunction")
	RerollBindable.Name = "ShopRerollFunction"
	RerollBindable.Parent = ServerStorage
end

-- ðŸ“‚ DATA
local PlayerSessions = {} 

-- LOGIC
local function getGlobalSeedID() return math.floor(os.time() / RESTOCK_INTERVAL) end

local function generateStockFromSeed(seedValue)
	local rng = Random.new(seedValue)
	local r = rng:NextInteger(1, 100)
	local targetCount = (r > 90 and 3) or (r > 55 and 2) or 1
	local featured = {}
	for name, _ in pairs(ALWAYS_STOCK) do featured[name] = true end
	local featuredCount, safety = 0, 0
	while featuredCount < targetCount and safety < 50 do
		safety += 1
		local totalWeight = 0; for _, w in pairs(CAR_WEIGHTS) do totalWeight += w end
		local roll = rng:NextInteger(1, totalWeight)
		local current = 0; local picked = nil
		for car, w in pairs(CAR_WEIGHTS) do current += w; if roll <= current then picked = car; break end end
		if picked and not featured[picked] then featured[picked] = true; featuredCount += 1 end
	end
	return featured
end

local function validateSession(player)
	local uid = player.UserId; local currentGlobalID = getGlobalSeedID()
	if not PlayerSessions[uid] then PlayerSessions[uid] = {SeedVersion = currentGlobalID, LocalSeed = nil, Purchased = {}} end
	local session = PlayerSessions[uid]
	if session.SeedVersion ~= currentGlobalID then
		session.SeedVersion = currentGlobalID; session.LocalSeed = nil; session.Purchased = {}
		-- ðŸ”Š REASON: AUTO RESTOCK
		RemoteUpdate:FireClient(player, {
			Featured = generateStockFromSeed(currentGlobalID), Purchased = {},
			NextRestock = (currentGlobalID + 1) * RESTOCK_INTERVAL, IsGlobal = true,
			Reason = "Auto" -- âœ… TAG ADDED
		})
	end
	return session
end

-- HANDLERS
FuncGetState.OnServerInvoke = function(player)
	local session = validateSession(player)
	return {
		Featured = generateStockFromSeed(session.LocalSeed or session.SeedVersion),
		Purchased = session.Purchased,
		NextRestock = (getGlobalSeedID() + 1) * RESTOCK_INTERVAL,
		IsGlobal = (session.LocalSeed == nil)
	}
end

FuncBuyCar.OnServerInvoke = function(player, carName)
	local session = validateSession(player)
	local currentStock = generateStockFromSeed(session.LocalSeed or session.SeedVersion)
	local CarStats = require(ReplicatedStorage.CarStats); local carData = CarStats.Cars[carName]

	if not carData then return false, "Invalid Car" end
	if not currentStock[carName] then return false, "Not In Stock" end

	local cash = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Cash")
	if not cash or cash.Value < carData.Price then return false, "Insufficient Funds" end

	cash.Value -= carData.Price
	local tool = ServerStorage:FindFirstChild("CarTools") and ServerStorage.CarTools:FindFirstChild(carName) or ServerStorage.CarTools:FindFirstChild(carName.." Item")
	if tool then
		tool:Clone().Parent = player.Backpack; tool:Clone().Parent = player.StarterGear
	else
		cash.Value += carData.Price; return false, "Tool Missing"
	end

	if not ALWAYS_STOCK[carName] then session.Purchased[carName] = true end

	-- ðŸ”Š REASON: PURCHASE
	RemoteUpdate:FireClient(player, {
		Featured = currentStock, Purchased = session.Purchased,
		NextRestock = (getGlobalSeedID() + 1) * RESTOCK_INTERVAL, IsGlobal = (session.LocalSeed == nil),
		Reason = "Purchase" -- âœ… TAG ADDED
	})
	return true, "Success"
end

-- ðŸ”— REROLL HANDLER
function RerollBindable.OnInvoke(player)
	if not player then return false end
	local session = validateSession(player)
	session.LocalSeed = math.random(1, 999999999)
	session.Purchased = {} 

	-- ðŸ”Š REASON: PAID REROLL
	RemoteUpdate:FireClient(player, {
		Featured = generateStockFromSeed(session.LocalSeed),
		Purchased = session.Purchased,
		NextRestock = (getGlobalSeedID() + 1) * RESTOCK_INTERVAL,
		IsGlobal = false,
		Reason = "Reroll" -- âœ… TAG ADDED
	})
	return true
end

-- GLOBAL LOOP
task.spawn(function()
	local lastGlobalID = getGlobalSeedID()
	while true do
		task.wait(1)
		local currentID = getGlobalSeedID()
		if currentID ~= lastGlobalID then
			lastGlobalID = currentID
			print("ðŸ”„ GLOBAL SHOP ROTATION")
			for _, player in ipairs(Players:GetPlayers()) do validateSession(player) end
		end
	end
end)
Players.PlayerRemoving:Connect(function(player) PlayerSessions[player.UserId] = nil end)
