-- [[ LOCAL SCRIPT: GiftUIController (MAX LEVEL) ]]
-- Purpose: The "Brain" of the Gifting System. Handles UI, Animation, Logic, and Feedback.
-- Location: StarterPlayerScripts

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- üì° REMOTES (Wait slightly to prevent "Silent Freeze" if loading slowly)
local Remotes = ReplicatedStorage:WaitForChild("GiftRemotes", 10)
if not Remotes then 
	warn("‚ö†Ô∏è GiftUIController: 'GiftRemotes' folder missing in ReplicatedStorage!") 
	return 
end
local SetIntentEvent = Remotes:WaitForChild("SetGiftIntent")

-- ‚öôÔ∏è CONFIGURATION
local UI_NAME = "UniversalGiftUI"
local TWEEN_INFO = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local HOVER_COLOR = Color3.fromRGB(200, 200, 200) -- Dim color
local NORMAL_COLOR = Color3.fromRGB(255, 255, 255) -- Normal color

-- üîä SOUNDS (Create on the fly for reliability)
local Audio = {
	Open = Instance.new("Sound", SoundService),
	Click = Instance.new("Sound", SoundService),
	Success = Instance.new("Sound", SoundService),
	Error = Instance.new("Sound", SoundService)
}
Audio.Open.SoundId = "rbxassetid://6895079853" -- Pop
Audio.Click.SoundId = "rbxassetid://4210586953" -- Click
Audio.Success.SoundId = "rbxassetid://2619623062" -- Chime
Audio.Error.SoundId = "rbxassetid://1526487928" -- Error buzz

-- üíæ STATE
local currentProductId = nil
local currentTargetName = "" 
local mainFrame = nil
local screenGui = nil
local mainScale = nil
local mainCanvasGroup = nil

-- ============================================================================
-- üé® ANIMATION ENGINE
-- ============================================================================
local function AnimateOpen()
	if not mainFrame or not screenGui then return end
	screenGui.Enabled = true
	mainFrame.Visible = true

	if mainScale then
		mainScale.Scale = 0.8
		TweenService:Create(mainScale, TWEEN_INFO, {Scale = 1}):Play()
	end

	if mainCanvasGroup then
		mainCanvasGroup.GroupTransparency = 1
		TweenService:Create(mainCanvasGroup, TWEEN_INFO, {GroupTransparency = 0}):Play()
	end

	Audio.Open:Play()
end

local function AnimateClose()
	if not mainFrame or not screenGui then return end

	local closeTween = nil
	if mainScale then
		closeTween = TweenService:Create(mainScale, TWEEN_INFO, {Scale = 0.8})
		closeTween:Play()
	end

	if mainCanvasGroup then
		TweenService:Create(mainCanvasGroup, TWEEN_INFO, {GroupTransparency = 1}):Play()
	end

	local function finishClose()
		mainFrame.Visible = false
		screenGui.Enabled = false
	end

	if closeTween then
		closeTween.Completed:Once(finishClose)
	else
		finishClose()
	end
end

local function AnimateButton(btn, isHovering)
	local target = isHovering and HOVER_COLOR or NORMAL_COLOR
	TweenService:Create(btn, TweenInfo.new(0.2), {ImageColor3 = target}):Play()
end

-- ============================================================================
-- üí° INDICATOR LOGIC
-- ============================================================================
local function SetIndicator(msg, color)
	if mainFrame then
		local indicator = mainFrame:FindFirstChild("Indicator")
		if indicator then
			indicator.Text = msg
			indicator.TextColor3 = color
			indicator.Visible = true

			-- Gentle pulse effect
			local originalSize = indicator.TextSize
			indicator.TextSize = originalSize * 1.2
			TweenService:Create(indicator, TweenInfo.new(0.5, Enum.EasingStyle.Bounce), {TextSize = originalSize}):Play()
		end
	end
end

local function ResetIndicator()
	if mainFrame then
		local indicator = mainFrame:FindFirstChild("Indicator")
		if indicator then
			indicator.Text = "Select a player to gift"
			indicator.TextColor3 = Color3.fromRGB(255, 255, 255)
			indicator.Visible = true
		end
	end
end

-- ============================================================================
-- üîÑ UI REFRESH LOGIC (THE SLOT SYSTEM)
-- ============================================================================
local function UpdateSlots()
	if not mainFrame then return end

	-- 1. Find all eligible players (Everyone except ME)
	local validPlayers = {}
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= player then
			table.insert(validPlayers, p)
		end
	end

	-- 2. Loop through Static Slots (Player1 -> Player5)
	for i = 1, 5 do
		local slotName = "Player" .. i
		local slotFrame = mainFrame:FindFirstChild(slotName)

		if slotFrame then
			local target = validPlayers[i]

			if target then
				-- ‚úÖ PLAYER FOUND: SHOW SLOT
				slotFrame.Visible = true

				local nameLbl = slotFrame:FindFirstChild("PlayerName")
				local avatarImg = slotFrame:FindFirstChild("PlayerAvatar")
				local giftBtn = slotFrame:FindFirstChild("GiftThePlayer")

				-- Update Info
				if nameLbl then nameLbl.Text = target.Name end
				if avatarImg then 
					avatarImg.Image = "rbxthumb://type=AvatarHeadShot&id=" .. target.UserId .. "&w=150&h=150"
				end

				-- Connect Button (Disconnecting old events via cloning is safer for repeated use)
				if giftBtn then
					-- Hack: Clone button to wipe old connections, then replace
					local newBtn = giftBtn:Clone()
					newBtn.Parent = slotFrame
					giftBtn:Destroy()
					giftBtn = newBtn

					-- Hover
					giftBtn.MouseEnter:Connect(function() AnimateButton(giftBtn, true) end)
					giftBtn.MouseLeave:Connect(function() AnimateButton(giftBtn, false) end)

					-- CLICK TO GIFT
					giftBtn.MouseButton1Click:Connect(function()
						if currentProductId then
							Audio.Click:Play()

							-- 1. Save Target Name for the Indicator
							currentTargetName = target.Name
							SetIndicator("Processing...", Color3.fromRGB(255, 255, 100)) -- Yellow

							-- 2. Tell Server Intent
							SetIntentEvent:FireServer(target.UserId)

							-- 3. Prompt Purchase
							MarketplaceService:PromptProductPurchase(player, currentProductId)
						end
					end)
				end
			else
				-- ‚ùå NO PLAYER: HIDE SLOT
				slotFrame.Visible = false
			end
		end
	end
end

-- ============================================================================
-- üßæ PURCHASE FEEDBACK
-- ============================================================================
MarketplaceService.PromptProductPurchaseFinished:Connect(function(userId, productId, isPurchased)
	if userId ~= player.UserId then return end

	-- Only react if the UI is open or was just used
	if productId == currentProductId then
		if isPurchased then
			-- ‚úÖ SUCCESS
			SetIndicator("Gift sent to " .. currentTargetName .. "!", Color3.fromRGB(85, 255, 127)) -- Green
			Audio.Success:Play()

			-- Auto-close after 2 seconds
			task.delay(2.5, function()
				if screenGui.Enabled then AnimateClose() end
			end)
		else
			-- ‚ùå CANCELLED / FAILED
			SetIndicator("Purchase Cancelled", Color3.fromRGB(255, 85, 85)) -- Red
			Audio.Error:Play()
		end
	end
end)

-- ============================================================================
-- üöÄ INIT & PUBLIC API
-- ============================================================================
local function Init()
	screenGui = PlayerGui:WaitForChild(UI_NAME)
	mainFrame = screenGui:WaitForChild("MainFrame")

	-- Ensure components for animation exist
	mainScale = mainFrame:FindFirstChildOfClass("UIScale")
	if not mainScale then
		mainScale = Instance.new("UIScale")
		mainScale.Parent = mainFrame
	end

	mainCanvasGroup = mainFrame:FindFirstChildOfClass("CanvasGroup")

	-- Setup Exit Button
	local exitBtn = mainFrame:FindFirstChild("ExitButton")
	if exitBtn then
		exitBtn.MouseButton1Click:Connect(function()
			Audio.Click:Play()
			AnimateClose()
		end)
	end
end

-- Global Function called by your Shops
_G.OpenGiftMenu = function(productId)
	if not mainFrame or not screenGui then Init() end
	if not mainFrame or not screenGui then
		warn("‚ùå Gift UI failed to initialize")
		return
	end

	currentProductId = productId
	ResetIndicator()
	UpdateSlots()
	AnimateOpen()
end

return {}
