-- [[ SERVER SCRIPT: PadController (Final Secure Edition) ]]
-- -- Indicating what the script is for: Manages car placement, anti-duplication, and secure pickup.
-- FEATURES: Server-Side Distance Check, StarterGear Cleaning, Anti-Data Loss.

local ServerStorage = game:GetService("ServerStorage")
local Workspace = game:GetService("Workspace")
local StarterPack = game:GetService("StarterPack")
local Debris = game:GetService("Debris")

-- === ‚öôÔ∏è TUNING ===
local VERTICAL_OFFSET = -1
local PROMPT_RANGE = 14      -- Interaction distance
local MAX_CHECK_DIST = 20    -- Security Limit (Prevents "Long Arms" exploit)
local SAFETY_JUMP_HEIGHT = 8 -- Eject height
-- =================

local CarModels = ServerStorage:WaitForChild("CarModels")
local CarTools = ServerStorage:WaitForChild("CarTools")
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- üõ†Ô∏è HELPER: Find Plot Folder
local function getPlotFolder(obj)
	local current = obj
	while current and current.Parent do
		if current.Parent == TycoonFolder then return current end
		current = current.Parent
	end
	return nil
end

-- üõ†Ô∏è HELPER: Get Main Part safely
local function getMainPart(obj)
	if obj:IsA("BasePart") then return obj end
	if obj:IsA("Model") then
		return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

-- üõ†Ô∏è HELPER: Security Distance Check
local function isCloseEnough(player, padPart)
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return false end
	local dist = (player.Character.HumanoidRootPart.Position - padPart.Position).Magnitude
	return dist <= MAX_CHECK_DIST
end

-- üõ†Ô∏è MAIN LOGIC
local function setupPad(padObject)
	local padPart = getMainPart(padObject)
	if not padPart then return end

	-- Cleanup old prompts
	for _, child in pairs(padPart:GetChildren()) do
		if child:IsA("ProximityPrompt") and child.Name == "ProximityPrompt" then child:Destroy() end
	end

	-- Setup Values
	local occupiedVal = padPart:FindFirstChild("IsOccupied") or Instance.new("BoolValue", padPart)
	occupiedVal.Name = "IsOccupied"
	
	local linkedCarVal = padPart:FindFirstChild("LinkedCar") or Instance.new("ObjectValue", padPart)
	linkedCarVal.Name = "LinkedCar"

	-- Setup Prompts
	local placePrompt = padPart:FindFirstChild("PlacePrompt") or Instance.new("ProximityPrompt", padPart)
	placePrompt.Name = "PlacePrompt"; placePrompt.ActionText = "Place Car"; placePrompt.ObjectText = "Car Pad"
	placePrompt.HoldDuration = 0.5; placePrompt.MaxActivationDistance = PROMPT_RANGE; placePrompt.RequiresLineOfSight = false

	local pickupPrompt = padPart:FindFirstChild("PickupPrompt") or Instance.new("ProximityPrompt", padPart)
	pickupPrompt.Name = "PickupPrompt"; pickupPrompt.ActionText = "Pick Up"; pickupPrompt.ObjectText = "Occupied Pad"
	pickupPrompt.HoldDuration = 0.5; pickupPrompt.MaxActivationDistance = PROMPT_RANGE; pickupPrompt.RequiresLineOfSight = false
	pickupPrompt.Enabled = false

	-- Sync State
	if occupiedVal.Value == true then
		placePrompt.Enabled = false; pickupPrompt.Enabled = true
	else
		placePrompt.Enabled = true; pickupPrompt.Enabled = false
	end

	local isProcessing = false

	-- ========================================================================
	-- üü¢ PLACE LOGIC (Secure)
	-- ========================================================================
	placePrompt.Triggered:Connect(function(player)
		if isProcessing or occupiedVal.Value then return end
		isProcessing = true

		-- 1. Security Checks
		local thisPlot = getPlotFolder(padObject)
		if not thisPlot or player:GetAttribute("OccupiedPlot") ~= thisPlot.Name then
			isProcessing = false; return
		end
		
		if not isCloseEnough(player, padPart) then
			warn("‚ö†Ô∏è PadController: Possible exploit attempt (Distance) by " .. player.Name)
			isProcessing = false; return
		end

		-- 2. Tool Logic
		local tool = player.Character:FindFirstChildWhichIsA("Tool")
		if tool then
			-- Normalize name (Remove " Item" suffix if present to find the Model)
			local cleanName = tool.Name:gsub(" Item", ""):gsub("Item", "")
			local realCar = CarModels:FindFirstChild(cleanName)

			if realCar then
				occupiedVal.Value = true
				placePrompt.Enabled = false
				pickupPrompt.Enabled = true
				
				-- üõ°Ô∏è SECURITY FIX: REMOVE TOOL FROM CHARACTER AND STARTERGEAR
				local toolName = tool.Name -- Save name
				tool:Destroy() -- Remove from hand
				
				-- Aggressively remove duplicates from StarterGear (Fixes Infinite Money Glitch)
				if player:FindFirstChild("StarterGear") then
					for _, gTool in pairs(player.StarterGear:GetChildren()) do
						if gTool.Name == toolName then
							gTool:Destroy()
						end
					end
				end

				-- 3. Spawn Car
				local placedCar = realCar:Clone()
				local padTop = padPart.CFrame * CFrame.new(0, (padPart.Size.Y / 2) + VERTICAL_OFFSET + 1, 0)
				placedCar:PivotTo(padTop)
				
				local carFolder = thisPlot:FindFirstChild("PlacedCars")
				if carFolder then placedCar.Parent = carFolder else placedCar.Parent = thisPlot end

				-- Solidify
				for _, part in pairs(placedCar:GetDescendants()) do
					if part:IsA("BasePart") then part.Anchored = true; part.CanCollide = true end
				end
				
				-- Eject Player
				if player.Character then
					player.Character:PivotTo(player.Character:GetPivot() + Vector3.new(0, SAFETY_JUMP_HEIGHT, 0))
				end

				linkedCarVal.Value = placedCar
				
				-- SFX
				local sFolder = game.ReplicatedStorage:FindFirstChild("GameSounds")
				if sFolder and sFolder:FindFirstChild("PlaceSound") then
					local s = sFolder.PlaceSound:Clone(); s.Parent = padPart; s:Play(); Debris:AddItem(s, 2)
				end
			else
				warn("‚ùå Car Model '"..cleanName.."' not found in ServerStorage.CarModels!")
			end
		end
		task.wait(0.2)
		isProcessing = false
	end)

	-- ========================================================================
	-- üî¥ PICKUP LOGIC (Safe)
	-- ========================================================================
	pickupPrompt.Triggered:Connect(function(player)
		if isProcessing then return end
		isProcessing = true

		-- 1. Security Checks
		local thisPlot = getPlotFolder(padObject)
		if not thisPlot or player:GetAttribute("OccupiedPlot") ~= thisPlot.Name then
			isProcessing = false; return
		end
		
		if not isCloseEnough(player, padPart) then
			warn("‚ö†Ô∏è PadController: Possible exploit attempt (Distance) by " .. player.Name)
			isProcessing = false; return
		end

		local carToRemove = linkedCarVal.Value
		
		-- üõ°Ô∏è RECOVERY LOGIC (Prevents Item Loss)
		if carToRemove then
			local carName = carToRemove.Name
			local foundTool = nil
			-- Try exact match, then with " Item" suffix
			local possibleNames = {carName, carName .. " Item", carName .. "Item"}

			for _, name in ipairs(possibleNames) do
				local t = CarTools:FindFirstChild(name)
				if t then foundTool = t:Clone(); break end
			end

			if not foundTool then
				-- Fallback to StarterPack
				for _, name in ipairs(possibleNames) do
					local t = StarterPack:FindFirstChild(name)
					if t then foundTool = t:Clone(); break end
				end
			end

			if foundTool then
				-- Give back to user
				foundTool.Parent = player.Backpack
				foundTool:Clone().Parent = player.StarterGear
				
				-- Only destroy car if we successfully gave the tool back
				carToRemove:Destroy()
				
				-- Reset Pad
				occupiedVal.Value = false
				linkedCarVal.Value = nil
				placePrompt.Enabled = true
				pickupPrompt.Enabled = false
				
				local sFolder = game.ReplicatedStorage:FindFirstChild("GameSounds")
				if sFolder and sFolder:FindFirstChild("EquipSound") then
					local s = sFolder.EquipSound:Clone(); s.Parent = padPart; s:Play(); Debris:AddItem(s, 2)
				end
			else
				-- ‚ö†Ô∏è CRITICAL SAFETY: Tool is missing from game files!
				-- We DO NOT destroy the car, so the player doesn't lose their item.
				warn("‚ö†Ô∏è CRITICAL: Could not find Tool for '" .. carName .. "'. Pickup aborted to prevent item loss.")
				
				-- Feedback to dev/player
				local h = Instance.new("Hint", Workspace)
				h.Text = "SYSTEM ERROR: Tool missing for this car. Cannot pick up."; Debris:AddItem(h, 3)
			end
		else
			-- Pad thinks it's occupied, but car is gone (Glitch). Force reset.
			occupiedVal.Value = false
			linkedCarVal.Value = nil
			placePrompt.Enabled = true
			pickupPrompt.Enabled = false
		end

		task.wait(0.2)
		isProcessing = false
	end)
end

-- Initialize
for _, plot in pairs(TycoonFolder:GetChildren()) do
	local padsFolder = plot:FindFirstChild("Pads")
	if padsFolder then
		for _, pad in pairs(padsFolder:GetChildren()) do setupPad(pad) end
	end
end
