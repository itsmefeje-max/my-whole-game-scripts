-- [[ SERVER SCRIPT: PadController (V3 - Visual Sync & Progression Aware) ]]
-- Purpose: Handles placing/picking up cars AND manages Prompt Visibility based on unlocks.
-- Runs on: Server
-- Key Upgrade: Checks 'HighestUnlockedPad' to hide prompts on locked pads.

local ServerStorage = game:GetService("ServerStorage")
local Workspace = game:GetService("Workspace")
local StarterPack = game:GetService("StarterPack")
local Debris = game:GetService("Debris")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ‚öôÔ∏è CONFIGURATION
local CONSTANTS = {
	VERTICAL_OFFSET = 5,
	PROMPT_RANGE = 14,
	MAX_CHECK_DIST = 20,
	EJECT_HEIGHT = 5,
	EJECT_DISTANCE = 4,
	RETRY_DELAY = 0.2,
	HOLD_DURATION = 1.5 
}

-- üìÇ ASSETS
local CarModels = ServerStorage:WaitForChild("CarModels")
local CarTools = ServerStorage:WaitForChild("CarTools")
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- üìö MODULES
local CarStats
pcall(function() CarStats = require(ReplicatedStorage:WaitForChild("CarStats", 5)) end)

-- üõ°Ô∏è STATE MANAGEMENT
local processingTracks = {} 

-- ============================================================================
-- üõ†Ô∏è HELPER FUNCTIONS
-- ============================================================================

-- ‚úÖ Helper: Get Pad Number from Name (e.g. "Pad5" -> 5)
local function getPadNumber(padObject)
	local num = padObject.Name:match("Pad(%d+)")
	return tonumber(num) or 1 -- Default to 1 if name format is weird
end

local function FindModelNameFromTool(toolName)
	local clean = toolName:gsub(" Item", ""):gsub("Item", "")
	if CarModels:FindFirstChild(clean) then return clean end
	if CarStats and CarStats.Cars and CarStats.Cars[clean] then
		local stats = CarStats.Cars[clean]
		if CarModels:FindFirstChild(stats.Name) then return stats.Name end
	end
	return nil
end

local function FindToolFromModelName(modelName)
	if CarTools:FindFirstChild(modelName) then return CarTools[modelName] end
	if CarTools:FindFirstChild(modelName.." Item") then return CarTools[modelName.." Item"] end
	if CarStats and CarStats.Cars then
		for key, stats in pairs(CarStats.Cars) do
			if stats.Name == modelName then
				if CarTools:FindFirstChild(key) then return CarTools[key] end
				if CarTools:FindFirstChild(key.." Item") then return CarTools[key.." Item"] end
			end
		end
	end
	return nil
end

local function getMainPart(obj)
	if obj:IsA("BasePart") then return obj end
	if obj:IsA("Model") then
		return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

local function getPlotFolder(obj)
	local current = obj
	while current and current.Parent do
		if current.Parent == TycoonFolder then return current end
		current = current.Parent
	end
	return nil
end

local function isCloseEnough(player, padPart)
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return false end
	local dist = (player.Character.HumanoidRootPart.Position - padPart.Position).Magnitude
	return dist <= CONSTANTS.MAX_CHECK_DIST
end

-- ============================================================================
-- üß† SMART VALIDATION (The Fix)
-- ============================================================================
local function validatePadState(padObject, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)
	-- 1. Get Plot & Owner
	local plot = getPlotFolder(padObject)
	local ownerName = plot and plot:FindFirstChild("Owner") and plot.Owner.Value
	local ownerPlayer = Players:FindFirstChild(ownerName or "")
	
	-- 2. Check Progression (Is this pad unlocked?)
	local isUnlocked = false
	if ownerPlayer then
		local level = ownerPlayer:GetAttribute("HighestUnlockedPad") or 1
		local padNum = getPadNumber(padObject)
		if padNum <= level then isUnlocked = true end
	elseif not ownerName or ownerName == "" then
		-- No owner? Only unlock Pad 1 (or lock all to be safe)
		if getPadNumber(padObject) == 1 then isUnlocked = true end
	end

	-- 3. APPLY VISIBILITY LOGIC
	if not isUnlocked then
		-- üîí LOCKED: Disable prompts so players can't interact
		placePrompt.Enabled = false
		pickupPrompt.Enabled = false
		return
	end

	-- üîì UNLOCKED: Normal Logic
	local car = linkedCarVal.Value
	
	if occupiedVal.Value == true and (not car or not car.Parent) then
		-- Ghost Lock Detected (Fix it)
		occupiedVal.Value = false
		linkedCarVal.Value = nil
		placePrompt.Enabled = true
		pickupPrompt.Enabled = false
		
	elseif occupiedVal.Value == true then
		-- Car is placed
		placePrompt.Enabled = false
		pickupPrompt.Enabled = true
		
	else
		-- Pad is empty
		placePrompt.Enabled = true
		pickupPrompt.Enabled = false
	end
end

-- ============================================================================
-- üì¶ TRANSACTION FUNCTIONS
-- ============================================================================
local function removeToolFromPlayer(player, toolName)
	local found = false
	local charTool = player.Character and player.Character:FindFirstChild(toolName)
	if charTool then
		charTool:Destroy()
		found = true
	else
		local backpackTool = player.Backpack:FindFirstChild(toolName)
		if backpackTool then
			backpackTool:Destroy()
			found = true
		end
	end
	local gearTool = player.StarterGear:FindFirstChild(toolName)
	if gearTool then gearTool:Destroy() end
	return found
end

local function spawnCarOnPad(padPart, carModel, plot)
	local placedCar = carModel:Clone()
	local padTop = padPart.CFrame * CFrame.new(0, (padPart.Size.Y / 2) + CONSTANTS.VERTICAL_OFFSET + 1, 0)
	placedCar:PivotTo(padTop)

	local carFolder = plot:FindFirstChild("PlacedCars")
	if not carFolder then
		carFolder = Instance.new("Folder", plot)
		carFolder.Name = "PlacedCars"
	end
	placedCar.Parent = carFolder

	for _, part in pairs(placedCar:GetDescendants()) do
		if part:IsA("BasePart") then 
			part.Anchored = true
			part.CanCollide = true 
		end
	end
	return placedCar
end

local function playSound(name, parent)
	local sFolder = game.ReplicatedStorage:FindFirstChild("GameSounds")
	if sFolder and sFolder:FindFirstChild(name) then
		local s = sFolder[name]:Clone()
		s.Parent = parent
		s:Play()
		Debris:AddItem(s, 2)
	end
end

-- ============================================================================
-- üéÆ INTERACTION LOGIC
-- ============================================================================

local function AttemptPlace(player, padObject, padPart, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)
	if occupiedVal.Value then return end
	
	-- Double Check: Is it unlocked? (Security Layer)
	local padNum = getPadNumber(padObject)
	local level = player:GetAttribute("HighestUnlockedPad") or 1
	if padNum > level then return end

	local thisPlot = getPlotFolder(padObject)
	if not thisPlot or player:GetAttribute("OccupiedPlot") ~= thisPlot.Name then return end
	if not isCloseEnough(player, padPart) then return end

	local tool = player.Character:FindFirstChildWhichIsA("Tool")
	if not tool then return end

	local realModelName = FindModelNameFromTool(tool.Name)
	local realCar = realModelName and CarModels:FindFirstChild(realModelName)

	if realCar then
		local toolName = tool.Name
		local removed = removeToolFromPlayer(player, toolName)

		if removed then
			local success, result = pcall(function()
				return spawnCarOnPad(padPart, realCar, thisPlot)
			end)

			if success and result then
				occupiedVal.Value = true
				linkedCarVal.Value = result
				result:SetAttribute("OwnerUserId", player.UserId)
				result:SetAttribute("CarGUID", tostring(player.UserId) .. "_" .. tostring(os.time()) .. "_" .. tostring(math.random(1000,9999)))

				-- Update State immediately
				validatePadState(padObject, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)

				if player.Character then
					local edgeOffset = (padPart.Size.Z / 2) + CONSTANTS.EJECT_DISTANCE
					local safeSpot = padPart.CFrame * CFrame.new(0, CONSTANTS.EJECT_HEIGHT, edgeOffset)
					local lookAtCar = CFrame.lookAt(safeSpot.Position, padPart.Position)
					player.Character:PivotTo(lookAtCar)
				end
				playSound("PlaceSound", padPart)
			else
				warn("‚ö†Ô∏è Spawn Failed! Refunding item to " .. player.Name)
				local originalTool = CarTools:FindFirstChild(toolName) or StarterPack:FindFirstChild(toolName)
				if originalTool then
					local backpackClone = originalTool:Clone()
					local gearClone = originalTool:Clone()
					for _, clone in ipairs({backpackClone, gearClone}) do
						clone:SetAttribute("IssuedByServer", true)
						clone:SetAttribute("IssuedAt", os.time())
						clone:SetAttribute("IssuedId", HttpService:GenerateGUID(false))
						clone:SetAttribute("ToolId", originalTool.Name)
						clone.CanBeDropped = false
					end
					backpackClone.Parent = player.Backpack
					gearClone.Parent = player.StarterGear
				end
			end
		end
	else
		warn("‚ö†Ô∏è Invalid Car Tool: " .. tool.Name)
	end
end

local function AttemptPickup(player, padObject, padPart, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)
	local thisPlot = getPlotFolder(padObject)
	if not thisPlot or player:GetAttribute("OccupiedPlot") ~= thisPlot.Name then return end
	if not isCloseEnough(player, padPart) then return end

	local carToRemove = linkedCarVal.Value
	if not carToRemove then 
		validatePadState(padObject, occupiedVal, linkedCarVal, placePrompt, pickupPrompt) 
		return 
	end

	local carName = carToRemove.Name
	local foundTool = FindToolFromModelName(carName)

	if foundTool then
		local backpackClone = foundTool:Clone()
		local gearClone = foundTool:Clone()
		for _, clone in ipairs({backpackClone, gearClone}) do
			clone:SetAttribute("IssuedByServer", true)
			clone:SetAttribute("IssuedAt", os.time())
			clone:SetAttribute("IssuedId", HttpService:GenerateGUID(false))
			clone:SetAttribute("ToolId", foundTool.Name)
			clone.CanBeDropped = false
		end
		backpackClone.Parent = player.Backpack
		gearClone.Parent = player.StarterGear 

		carToRemove:Destroy()

		occupiedVal.Value = false
		linkedCarVal.Value = nil
		
		-- Update State immediately
		validatePadState(padObject, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)

		playSound("EquipSound", padPart)
	else
		warn("‚ùå CRITICAL: Tool not found for " .. carName)
	end
end

-- ============================================================================
-- üöÄ SETUP
-- ============================================================================
local function setupPad(padObject)
	local padPart = getMainPart(padObject)
	if not padPart then return end

	for _, child in pairs(padPart:GetChildren()) do
		if child:IsA("ProximityPrompt") then child:Destroy() end
	end

	local occupiedVal = padPart:FindFirstChild("IsOccupied") or Instance.new("BoolValue", padPart)
	occupiedVal.Name = "IsOccupied"
	local linkedCarVal = padPart:FindFirstChild("LinkedCar") or Instance.new("ObjectValue", padPart)
	linkedCarVal.Name = "LinkedCar"

	local placePrompt = Instance.new("ProximityPrompt", padPart)
	placePrompt.Name = "PlacePrompt"; placePrompt.ActionText = "Place Car"; placePrompt.ObjectText = "Car Pad"
	placePrompt.MaxActivationDistance = CONSTANTS.PROMPT_RANGE; placePrompt.RequiresLineOfSight = false
	placePrompt.HoldDuration = CONSTANTS.HOLD_DURATION

	local pickupPrompt = Instance.new("ProximityPrompt", padPart)
	pickupPrompt.Name = "PickupPrompt"; pickupPrompt.ActionText = "Pick Up"; pickupPrompt.ObjectText = "Occupied Pad"
	pickupPrompt.MaxActivationDistance = CONSTANTS.PROMPT_RANGE; pickupPrompt.RequiresLineOfSight = false
	pickupPrompt.HoldDuration = CONSTANTS.HOLD_DURATION; pickupPrompt.Enabled = false

	-- Initial Validation
	validatePadState(padObject, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)

	placePrompt.Triggered:Connect(function(player)
		if processingTracks[player.UserId] then return end
		processingTracks[player.UserId] = true
		AttemptPlace(player, padObject, padPart, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)
		task.wait(CONSTANTS.RETRY_DELAY)
		processingTracks[player.UserId] = nil
	end)

	pickupPrompt.Triggered:Connect(function(player)
		if processingTracks[player.UserId] then return end
		processingTracks[player.UserId] = true
		AttemptPickup(player, padObject, padPart, occupiedVal, linkedCarVal, placePrompt, pickupPrompt)
		task.wait(CONSTANTS.RETRY_DELAY)
		processingTracks[player.UserId] = nil
	end)
end

-- Initialize Existing Tycoons
for _, plot in pairs(TycoonFolder:GetChildren()) do
	local padsFolder = plot:FindFirstChild("Pads")
	if padsFolder then
		for _, pad in pairs(padsFolder:GetChildren()) do setupPad(pad) end
	end
end

-- üîÑ MAINTENANCE LOOP (Updated to check visual state constantly)
task.spawn(function()
	while true do
		task.wait(5) -- Runs every 5 seconds to keep states valid
		for _, plot in pairs(TycoonFolder:GetChildren()) do
			local padsFolder = plot:FindFirstChild("Pads")
			if padsFolder then
				for _, padObject in pairs(padsFolder:GetChildren()) do
					local padPart = getMainPart(padObject)
					if padPart then
						local occ = padPart:FindFirstChild("IsOccupied")
						local lnk = padPart:FindFirstChild("LinkedCar")
						local pl = padPart:FindFirstChild("PlacePrompt")
						local pk = padPart:FindFirstChild("PickupPrompt")
						if occ and lnk and pl and pk then
							-- Checks progression + ghost locks
							validatePadState(padObject, occ, lnk, pl, pk)
						end
					end
				end
			end
		end
	end
end)
