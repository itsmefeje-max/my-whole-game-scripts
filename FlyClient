-- [[ LOCAL SCRIPT: FlyClient (Final Polish) ]]
-- FEATURES: Smart Collision Restore, Modern Physics, Auto-Cleanup
-- STATUS: Production Ready

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- ‚úÖ PERFORMANCE: Cache Controls ONCE
local PlayerModule = require(player.PlayerScripts:WaitForChild("PlayerModule"))
local Controls = PlayerModule:GetControls()

-- ‚öôÔ∏è SETTINGS
local SPEED_NORMAL = 100
local SPEED_BOOST = 150
local SMOOTHNESS = 0.2
local BANK_ANGLE = 15

-- üõ†Ô∏è STATE
local isFlying = true
local currentSpeed = SPEED_NORMAL
local noclipConnection = nil 
local affectedParts = {} -- Tracks parts we turned non-collidable

-- üì¶ PHYSICS CONTAINERS
local runtimeFolder = nil 
local flightAttachment = nil 

-- 1. SETUP FOLDER (For Constraints Only)
runtimeFolder = Instance.new("Folder")
runtimeFolder.Name = "FlyRuntime"
runtimeFolder.Parent = rootPart 

-- 2. SETUP ATTACHMENT (Must be in RootPart)
flightAttachment = Instance.new("Attachment")
flightAttachment.Name = "FlyAttachment"
flightAttachment.Parent = rootPart 

-- 3. SETUP CONSTRAINTS
local alignPos = Instance.new("LinearVelocity")
alignPos.Attachment0 = flightAttachment
alignPos.MaxForce = math.huge
alignPos.VectorVelocity = Vector3.zero
alignPos.VelocityConstraintMode = Enum.VelocityConstraintMode.Vector
alignPos.Parent = runtimeFolder

local alignRot = Instance.new("AlignOrientation")
alignRot.Attachment0 = flightAttachment
alignRot.Mode = Enum.OrientationAlignmentMode.OneAttachment
alignRot.RigidityEnabled = false 
alignRot.Responsiveness = 20
alignRot.Parent = runtimeFolder

-- üö´ ANIMATION & NO-CLIP
humanoid.PlatformStand = true

noclipConnection = RunService.Stepped:Connect(function()
	if not character then return end
	
	-- Strict Noclip: Disable collision on all parts
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") and part.CanCollide == true then
			part.CanCollide = false
			affectedParts[part] = true -- Remember this part so we can restore it later
		end
	end
end)

-- üõë STOP FUNCTION
function stopFlying()
	if not isFlying then return end
	isFlying = false

	-- 1. Disconnect Loop
	if noclipConnection then 
		noclipConnection:Disconnect() 
		noclipConnection = nil
	end

	-- 2. Clean Physics Objects
	if runtimeFolder then runtimeFolder:Destroy() end
	if flightAttachment then flightAttachment:Destroy() end

	-- 3. Restore Humanoid
	if humanoid and humanoid.Parent then
		humanoid.PlatformStand = false
	end
	
	-- 4. Restore Collisions (The Fix)
	-- Only restore parts we actually touched, plus the RootPart for safety
	if rootPart then rootPart.CanCollide = true end
	
	for part, _ in pairs(affectedParts) do
		if part and part.Parent then -- Check if part still exists
			part.CanCollide = true
		end
	end
	table.clear(affectedParts)

	-- 5. Stop Momentum (Modern Physics Fix)
	if rootPart then
		rootPart.AssemblyLinearVelocity = Vector3.zero
		rootPart.AssemblyAngularVelocity = Vector3.zero
	end

	-- 6. Self-Destruct
	if script and script.Parent then
		script:Destroy()
	end
end

-- üîÅ UPDATE LOOP
local function update(dt)
	if not isFlying or not rootPart.Parent then return end

	local inputMove = Controls:GetMoveVector()

	local yAxis = 0
	if UserInputService:IsKeyDown(Enum.KeyCode.Space) then yAxis = 1 end
	if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then yAxis = -1 end

	currentSpeed = UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and SPEED_BOOST or SPEED_NORMAL

	local camCFrame = camera.CFrame
	local moveDir = (camCFrame.RightVector * inputMove.X) + (camCFrame.LookVector * -inputMove.Z)
	local targetVelocity = (moveDir * currentSpeed) + Vector3.new(0, yAxis * currentSpeed, 0)

	if alignPos and alignPos.Parent then
		alignPos.VectorVelocity = alignPos.VectorVelocity:Lerp(targetVelocity, SMOOTHNESS)
	end

	if alignRot and alignRot.Parent then
		local tiltZ = -inputMove.X * BANK_ANGLE
		local targetCFrame = camCFrame * CFrame.Angles(0, 0, math.rad(tiltZ))
		alignRot.CFrame = targetCFrame
	end
end

-- üëÇ LISTENERS
script.AncestryChanged:Connect(function()
	if not script.Parent then stopFlying() end
end)

character:GetAttributeChangedSignal("ForceStopFly"):Connect(function()
	if character:GetAttribute("ForceStopFly") then stopFlying() end
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.KeyCode == Enum.KeyCode.X then stopFlying() end
end)

RunService.RenderStepped:Connect(update)
