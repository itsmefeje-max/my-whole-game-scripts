-- Purpose: FOV Punch, Success Messages, and "Multi-Template" Confetti Mix. Supports Tycoon Pads & Base Upgrades.
-- Runs on: Client
-- Location: StarterPlayerScripts
-- Dependencies: ReplicatedStorage, TweenService, Workspace
-- Public API: None (Listens to PadUnlockEvent)
-- Networking: Receives PadUnlockEvent (Server -> Client)
-- Security: Purely visual. Trusts the server's event trigger.
-- Performance: Reuses UI elements, utilizes task.spawn for particle loop, Thread-safe notifications.
-- Notes: Dynamically intercepts and rewrites "Base" strings to say "pads".

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local camera = Workspace.CurrentCamera

-- üì° REMOTE EVENT
local PadUnlockEvent = ReplicatedStorage:WaitForChild("PadUnlockEvent")

-- ‚öôÔ∏è CONFIGURATION
local FOV_PUNCH_AMOUNT = 10      
local FOV_TIME_IN = 0.15         
local FOV_TIME_OUT = 0.5         
local NOTIFICATION_DURATION = 3.5 

-- üéâ CONFETTI CONFIG
local CONFETTI_COUNT = 99      
local EXPLOSION_RADIUS = 999    
local ANIMATION_DURATION = 4.5  

-- üé® COLORS
local COLOR_SUCCESS = Color3.fromRGB(85, 255, 127) 
local COLOR_FAIL    = Color3.fromRGB(255, 85, 85)  

-- ============================================================================
-- 1. GET YOUR EXISTING GUI
-- ============================================================================
local notificationsGui = playerGui:WaitForChild("Notifications")
local padLabel = notificationsGui:WaitForChild("PadNotification")
local templatesFolder = notificationsGui:WaitForChild("ConfettiAssets") 

padLabel.TextTransparency = 1
padLabel.Visible = true 

local initialStroke = padLabel:FindFirstChildOfClass("UIStroke")
if initialStroke then initialStroke.Transparency = 1 end

-- üõ°Ô∏è STATE TRACKING
local notificationId = 0 

-- ============================================================================
-- 2. ANIMATION FUNCTIONS
-- ============================================================================

local function explodeConfetti()
	local templates = templatesFolder:GetChildren()

	if #templates == 0 then
		warn("No templates found in ConfettiAssets folder!")
		return
	end

	for i = 1, CONFETTI_COUNT do
		task.spawn(function()
			local randomTemplate = templates[math.random(1, #templates)]

			if randomTemplate:IsA("ImageLabel") then
				local clone = randomTemplate:Clone()
				clone.Name = "Confetti_Particle"

				clone.Parent = randomTemplate.Parent 
				clone.Visible = true
				clone.ZIndex = 100 

				clone.Position = randomTemplate.Position
				clone.Size = UDim2.new(0, 0, 0, 0) 
				clone.Rotation = math.random(0, 360)

				local angle = math.rad(math.random(0, 360))
				local distance = math.random(50, EXPLOSION_RADIUS)

				local endX = (math.cos(angle) * distance)
				local endY = (math.sin(angle) * distance)

				local targetPos = randomTemplate.Position + UDim2.new(0, endX, 0, endY + math.random(50, 150))

				local tweenInfo = TweenInfo.new(
					math.random(ANIMATION_DURATION * 0.8, ANIMATION_DURATION * 1.2), 
					Enum.EasingStyle.Quad, 
					Enum.EasingDirection.Out
				)

				local goal = {
					Position = targetPos,
					Size = randomTemplate.Size,
					Rotation = clone.Rotation + math.random(-180, 180),
					ImageTransparency = 1 
				}

				local tween = TweenService:Create(clone, tweenInfo, goal)
				tween:Play()

				tween.Completed:Connect(function()
					clone:Destroy()
				end)
			end
		end)
	end
end

local function playNotification(isSuccess, data)
	notificationId += 1
	local currentId = notificationId 

	local uiStroke = padLabel:FindFirstChildOfClass("UIStroke")

	-- 1. Dynamic Text Formatting
	if isSuccess then
		padLabel.TextColor3 = COLOR_SUCCESS
		local isNumber = tonumber(data)

		if isNumber then
			-- It's a regular Tycoon Pad (e.g., 2)
			padLabel.Text = "Purchase Completed! You now own Pad " .. tostring(data)
		else
			-- üõë FIX: Automatically strips the word "Base" if the server sent it, and formats exactly as requested.
			local rawString = tostring(data)
			local cleanName = string.gsub(rawString, " Base", "") 
			padLabel.Text = "You finally own " .. cleanName .. " pads!"
		end
	else
		padLabel.TextColor3 = COLOR_FAIL
		local formattedMoney = tostring(data):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
		padLabel.Text = "Insufficient Funds! You need $" .. formattedMoney .. " more."
	end

	-- 2. Fade In
	local tInfoIn = TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
	TweenService:Create(padLabel, tInfoIn, {TextTransparency = 0}):Play()
	if uiStroke then TweenService:Create(uiStroke, tInfoIn, {Transparency = 0}):Play() end

	-- 3. Wait safely
	task.wait(NOTIFICATION_DURATION)

	-- 4. Only fade out if another notification hasn't started!
	if notificationId == currentId then
		local tInfoOut = TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
		TweenService:Create(padLabel, tInfoOut, {TextTransparency = 1}):Play()
		if uiStroke then TweenService:Create(uiStroke, tInfoOut, {Transparency = 1}):Play() end
	end
end

local function punchFOV()
	local originalFOV = 70 
	local tPunch = TweenService:Create(camera, TweenInfo.new(FOV_TIME_IN, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
		FieldOfView = originalFOV + FOV_PUNCH_AMOUNT
	})
	local tReturn = TweenService:Create(camera, TweenInfo.new(FOV_TIME_OUT, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {
		FieldOfView = originalFOV
	})
	tPunch:Play()
	tPunch.Completed:Connect(function() tReturn:Play() end)
end

-- ============================================================================
-- 3. LISTENER
-- ============================================================================
PadUnlockEvent.OnClientEvent:Connect(function(isSuccess, data)
	if isSuccess then
		punchFOV() 
		explodeConfetti() 
		playNotification(true, data)

		local s = Instance.new("Sound")
		s.SoundId = "rbxassetid://6042054006"
		s.Volume = 0.6
		s.Parent = playerGui
		s:Play()
		Debris:AddItem(s, 2)
	else
		playNotification(false, data)
	end
end)
