-- When a player joins
--ServerScriptService
--Finds a free plos
--Marks it as theirs
--Teleports them to that plot‚Äôs spawn point
--Does it safely so they don‚Äôt fall, clip, or bug
--When the player respawns
--Teleports them back to their own plot again
--When the player leaves
--Resets the plot (owner cleared, cars removed, pads reset)
--Makes it available for the next player

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- üßπ CLEANUP (Runs when player leaves)
local function wipePlot(plot)
	if plot:FindFirstChild("Owner") then plot.Owner.Value = "" end
	if plot:FindFirstChild("PlacedCars") then plot.PlacedCars:ClearAllChildren() end
	if plot:FindFirstChild("Pads") then
		for _, padObj in pairs(plot.Pads:GetChildren()) do
			local padPart = padObj:IsA("Model") and (padObj.PrimaryPart or padObj:FindFirstChildWhichIsA("BasePart")) or padObj
			if padPart then
				local occupied = padPart:FindFirstChild("IsOccupied")
				if occupied then occupied.Value = false end
				local placePrompt = padPart:FindFirstChild("PlacePrompt")
				local pickupPrompt = padPart:FindFirstChild("PickupPrompt")
				if placePrompt then placePrompt.Enabled = true end
				if pickupPrompt then pickupPrompt.Enabled = false end
			end
		end
	end
end

-- ü§ù THE FIXED ASSIGN FUNCTION
local function assignPlot(player)
	for _, plot in pairs(TycoonFolder:GetChildren()) do
		local ownerVal = plot:FindFirstChild("Owner")

		if ownerVal and ownerVal.Value == "" then
			ownerVal.Value = player.Name
			player:SetAttribute("OccupiedPlot", plot.Name)

			-- This function handles the teleport safely
			local function onCharacterAdded(character)
				local spawnPart = plot:WaitForChild("SpawnPoint", 10)
				local hrp = character:WaitForChild("HumanoidRootPart", 10)

				if spawnPart and hrp then
					-- 1. PHYSICS LOCK: Stop the character from falling or moving
					hrp.Anchored = true 

					-- 2. POSITIONING: Move them high enough to clear any grass/props
					-- We use PivotTo because it moves the whole model correctly
					character:PivotTo(spawnPart.CFrame + Vector3.new(0, 10, 0))

					-- 3. LOAD DELAY: Give the engine a moment to render the floor
					task.wait(1.5) 

					-- 4. RELEASE: Character is now safe to walk
					hrp.Anchored = false
				end
			end

			-- Connect to future spawns
			player.CharacterAdded:Connect(onCharacterAdded)

			-- Handle current spawn (Studio fix)
			if player.Character then
				task.spawn(onCharacterAdded, player.Character)
			end

			return
		end
	end
end

-- üëÇ EVENTS
Players.PlayerAdded:Connect(assignPlot)

Players.PlayerRemoving:Connect(function(player)
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName then
		local plot = TycoonFolder:FindFirstChild(plotName)
		if plot then wipePlot(plot) end
	end
end)

-- Studio testing loop
for _, player in pairs(Players:GetPlayers()) do
	assignPlot(player)
end
