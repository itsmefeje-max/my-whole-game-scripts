-- [[ SERVER SCRIPT: Universal Car Tool ]]
-- Fix: Prevents "Infinite Weld" stacking lag.

local Tool = script.Parent
local Handle = Tool:WaitForChild("Handle")

-- === SETTINGS ===
local HEIGHT_OFFSET = 2
-- =================

local isSetup = false -- üõë DEBOUNCE: Ensures we only weld once

local function weldModel(model, primaryPart)
	for _, part in pairs(model:GetDescendants()) do
		if part:IsA("BasePart") and part ~= primaryPart then
			if not part:FindFirstChildWhichIsA("WeldConstraint") then
				local weld = Instance.new("WeldConstraint")
				weld.Part0 = primaryPart
				weld.Part1 = part
				weld.Parent = primaryPart
			end
		end
	end
end

local function makeGhost(model)
	for _, part in pairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Massless = true
			part.CanCollide = false
			part.CanTouch = false
			part.Anchored = false
			part.CanQuery = false 
		end
	end
end

Tool.Equipped:Connect(function()
	-- üõë STOP IF ALREADY DONE (The Fix)
	if isSetup then return end 

	if Handle then
		Handle.CanCollide = false
		Handle.CanTouch = false
		Handle.CanQuery = false 
		Handle.Transparency = 1 
	end

	local CarModel = Tool:FindFirstChildWhichIsA("Model")

	if CarModel then
		if CarModel.PrimaryPart then
			isSetup = true -- ‚úÖ Mark as done immediately

			-- A. GLUE
			weldModel(CarModel, CarModel.PrimaryPart)

			-- B. GHOST
			makeGhost(CarModel)

			-- C. MOVE
			local targetCFrame = Handle.CFrame * CFrame.new(0, HEIGHT_OFFSET, 0)
			CarModel:PivotTo(targetCFrame)

			-- D. LOCK
			local Weld = Instance.new("WeldConstraint")
			Weld.Part0 = Handle
			Weld.Part1 = CarModel.PrimaryPart
			Weld.Parent = Handle
		else
			warn("‚ö†Ô∏è Model '" .. CarModel.Name .. "' has no PrimaryPart!")
		end
	end
end)

-- Reset setup if tool is dropped/respawned (Optional but safe)
Tool.Unequipped:Connect(function()
	-- We keep isSetup = true because the welds persist in the tool until destroyed.
end)
