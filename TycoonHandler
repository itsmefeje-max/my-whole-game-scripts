-- [[ SERVER SCRIPT: TycoonHandler (Final Verified Fix) ]]
-- Updated: Clears Owner Name on leave (to free plot) but leaves Data for DataHandler.
-- Wipe happens ONLY when the NEXT player claims.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- üßπ CLEANUP FUNCTION (Runs when a NEW player claims)
local function wipePlot(plot)
	-- Reset Owner Name
	if plot:FindFirstChild("Owner") then plot.Owner.Value = "" end
	
	-- Reset Money (Safe to do now, as previous owner is long gone)
	local pending = plot:FindFirstChild("PendingEarnings")
	if pending then pending.Value = 0 end

	-- Clear Cars
	if plot:FindFirstChild("PlacedCars") then plot.PlacedCars:ClearAllChildren() end
	
	-- Reset Pads
	if plot:FindFirstChild("Pads") then
		for _, padObj in pairs(plot.Pads:GetChildren()) do
			local padPart = padObj:IsA("Model") and (padObj.PrimaryPart or padObj:FindFirstChildWhichIsA("BasePart")) or padObj
			if padPart then
				local occupied = padPart:FindFirstChild("IsOccupied")
				if occupied then occupied.Value = false end
				
				local linkedCar = padPart:FindFirstChild("LinkedCar")
				if linkedCar then linkedCar.Value = nil end

				local placePrompt = padPart:FindFirstChild("PlacePrompt")
				local pickupPrompt = padPart:FindFirstChild("PickupPrompt")
				if placePrompt then placePrompt.Enabled = true end
				if pickupPrompt then pickupPrompt.Enabled = false end
			end
		end
	end
end

-- ü§ù ASSIGN PLOT
local function assignPlot(player)
	for _, plot in pairs(TycoonFolder:GetChildren()) do
		local ownerVal = plot:FindFirstChild("Owner")

		-- We look for a plot where the name is empty (Freed by PlayerRemoving)
		if ownerVal and ownerVal.Value == "" then
			
			-- üõë CRITICAL: Wipe the plot NOW. 
			-- This cleans up the "Ghost Data" left behind by the previous owner.
			wipePlot(plot)
			
			ownerVal.Value = player.Name
			player:SetAttribute("OccupiedPlot", plot.Name)

			-- Teleport Safety
			local function onCharacterAdded(character)
				local spawnPart = plot:WaitForChild("SpawnPoint", 10)
				local hrp = character:WaitForChild("HumanoidRootPart", 10)

				if spawnPart and hrp then
					hrp.Anchored = true 
					character:PivotTo(spawnPart.CFrame + Vector3.new(0, 10, 0))
					task.wait(1.5) 
					hrp.Anchored = false
				end
			end

			player.CharacterAdded:Connect(onCharacterAdded)
			if player.Character then task.spawn(onCharacterAdded, player.Character) end

			return
		end
	end
end

Players.PlayerAdded:Connect(assignPlot)

-- üö™ LEAVE LOGIC (The Safe "Unlock")
Players.PlayerRemoving:Connect(function(player)
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName then
		local plot = TycoonFolder:FindFirstChild(plotName)
		if plot and plot:FindFirstChild("Owner") then
			-- ‚úÖ ACTION: We ONLY clear the name.
			-- We leave the Cars and PendingMoney intact.
			-- This allows TycoonDataHandler to read them calmly.
			-- They will be wiped when the NEXT player calls 'assignPlot'.
			plot.Owner.Value = "" 
		end
	end
end)

-- Studio testing
for _, player in pairs(Players:GetPlayers()) do
	assignPlot(player)
end
