-- [[ LOCAL SCRIPT: AfraiC4tLogic ]]
-- -- Indicating what the script is for: Handles Camera and Logic for AfraiC4t, using YOUR custom UI.
-- LOCATION: StarterPlayer > StarterPlayerScripts

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local playerGui = player:WaitForChild("PlayerGui")

-- ============================================================================
-- ‚öôÔ∏è CONFIGURATION (Must match your GUI & NPC)
-- ============================================================================
-- 1. NPC Settings
local NPC_FOLDER_NAME = "NPCS"
local NPC_NAME = "AfraiC4t"            
local CAMERA_PART_NAME = "CameraAimPart" 
local PROMPT_NAME = "ProximityPrompt"    

-- 2. YOUR GUI NAMES (Make sure your GUI matches these!)
local GUI_NAME = "ATM_NPC_GUI"         -- The ScreenGui you made
local CONTAINER_NAME = "MainFrame"     -- The Frame holding everything
local TEXT_LABEL_NAME = "DialogueText" -- The TextLabel for NPC speech
local BTN_1_NAME = "Option1"           -- Withdraw Button
local BTN_2_NAME = "Option2"           -- Inquiry Button
local BTN_3_NAME = "Option3"           -- Leave Button

-- 3. Visuals
local TWEEN_INFO = TweenInfo.new(1.2, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
local BLUR_SIZE = 15 

-- ============================================================================
-- üõ†Ô∏è SETUP & VARIABLES
-- ============================================================================
local isTalking = false
local controls = require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()
local blurEffect = Instance.new("BlurEffect", camera)
blurEffect.Size = 0
blurEffect.Enabled = false

-- Event for the Bank Script
local OpenATMEvent = ReplicatedStorage:FindFirstChild("OpenATMEvent")
if not OpenATMEvent then
	OpenATMEvent = Instance.new("BindableEvent")
	OpenATMEvent.Name = "OpenATMEvent"
	OpenATMEvent.Parent = ReplicatedStorage
end

-- ============================================================================
-- üé¨ INTERACTION FUNCTIONS
-- ============================================================================

local function endInteraction()
	if not isTalking then return end
	
	-- 1. Find your GUI and Hide it
	local myGui = playerGui:FindFirstChild(GUI_NAME)
	if myGui then
		myGui.Enabled = false -- Close the container
	end

	-- 2. Restore Camera & Controls
	camera.CameraType = Enum.CameraType.Custom
	TweenService:Create(blurEffect, TWEEN_INFO, {Size = 0}):Play()
	
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = false
	end
	if controls then controls:Enable() end
	
	task.wait(0.5)
	blurEffect.Enabled = false
	isTalking = false
end

local function startInteraction(npcModel)
	if isTalking then return end
	isTalking = true

	-- 1. Camera Logic
	local camPart = npcModel:FindFirstChild(CAMERA_PART_NAME)
	if not camPart then
		warn("‚ùå Logic Error: Missing '"..CAMERA_PART_NAME.."' inside AfraiC4t!")
		isTalking = false
		return
	end

	-- Freeze Player
	if controls then controls:Disable() end
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = true 
	end

	-- Move Camera
	camera.CameraType = Enum.CameraType.Scriptable
	blurEffect.Enabled = true
	TweenService:Create(blurEffect, TWEEN_INFO, {Size = BLUR_SIZE}):Play()
	TweenService:Create(camera, TWEEN_INFO, {CFrame = camPart.CFrame}):Play()

	-- 2. OPEN YOUR CONTAINER
	local myGui = playerGui:WaitForChild(GUI_NAME, 5)
	if not myGui then
		warn("‚ùå UI Error: Could not find ScreenGui named '" .. GUI_NAME .. "' in PlayerGui.")
		endInteraction()
		return
	end

	local mainFrame = myGui:FindFirstChild(CONTAINER_NAME)
	if not mainFrame then
		warn("‚ùå UI Error: Could not find Frame named '" .. CONTAINER_NAME .. "' inside " .. GUI_NAME)
		return
	end

	-- Reset Text
	local dialogueLabel = mainFrame:FindFirstChild(TEXT_LABEL_NAME)
	if dialogueLabel then
		dialogueLabel.Text = "Welcome. I handle the ATM services. How can I help?"
	end

	-- 3. CONNECT YOUR BUTTONS
	-- We disconnect old connections to prevent double-clicking issues
	for _, btnName in pairs({BTN_1_NAME, BTN_2_NAME, BTN_3_NAME}) do
		local btn = mainFrame:FindFirstChild(btnName)
		if btn then
			-- Remove old connections (simple way)
			local newBtn = btn:Clone()
			newBtn.Parent = btn.Parent
			btn:Destroy()
			btn = newBtn -- refresh variable
		end
	end

	-- Re-find buttons after refresh
	local btn1 = mainFrame:FindFirstChild(BTN_1_NAME) -- Withdraw
	local btn2 = mainFrame:FindFirstChild(BTN_2_NAME) -- Info
	local btn3 = mainFrame:FindFirstChild(BTN_3_NAME) -- Leave

	-- OPTION 1: WITHDRAW
	if btn1 then
		btn1.MouseButton1Click:Connect(function()
			endInteraction() -- Close dialogue first
			print("üèß Opening ATM Bank UI...")
			OpenATMEvent:Fire() -- Triggers the Bank Script
		end)
	end

	-- OPTION 2: INQUIRY (The "Other" Choice)
	if btn2 then
		btn2.MouseButton1Click:Connect(function()
			if dialogueLabel then
				-- Typewriter effect or instant text change
				dialogueLabel.Text = "I ensure your cash is safe. You can withdraw your Tycoon earnings here to spend in the city."
			end
		end)
	end

	-- OPTION 3: LEAVE
	if btn3 then
		btn3.MouseButton1Click:Connect(function()
			endInteraction()
		end)
	end

	-- Show GUI
	myGui.Enabled = true
end

-- ============================================================================
-- ‚ö° INITIALIZATION
-- ============================================================================
local function setupNPC()
	local folder = Workspace:WaitForChild(NPC_FOLDER_NAME)
	local npc = folder:WaitForChild(NPC_NAME, 10)

	if npc then
		local prompt = npc:FindFirstChild(PROMPT_NAME) or npc:FindFirstChildWhichIsA("ProximityPrompt", true)
		if prompt then
			print("‚úÖ AfraiC4t Logic Connected.")
			prompt.Triggered:Connect(function()
				startInteraction(npc)
			end)
		end
	else
		warn("‚ùå Could not find AfraiC4t in Workspace.")
	end
end

setupNPC()
