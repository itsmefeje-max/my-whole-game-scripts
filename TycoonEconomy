-- [[ SERVER SCRIPT: TycoonEconomy - FIXED & CLEANED ]]
-- Handles: Cash Generation Loop & CPS Calculation
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- ðŸ› ï¸ Load Module Safely
local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- âš™ï¸ SETTINGS
local PAY_INTERVAL = 1 -- Seconds

-- ðŸ› ï¸ HELPER: Find the 'LinkedCar' Value anywhere inside the pad
local function getLinkedCarValue(pad)
	-- 1. Check directly (if pad is a Part)
	local direct = pad:FindFirstChild("LinkedCar")
	if direct then return direct.Value end

	-- 2. Check PrimaryPart (if pad is a Model)
	if pad:IsA("Model") and pad.PrimaryPart then
		local prim = pad.PrimaryPart:FindFirstChild("LinkedCar")
		if prim then return prim.Value end
	end

	-- 3. Fallback: Scan children
	for _, child in pairs(pad:GetChildren()) do
		local val = child:FindFirstChild("LinkedCar")
		if val then return val.Value end
	end

	return nil
end

-- ðŸ’° MAIN ECONOMY LOOP
task.spawn(function()
	print("ðŸ’° TycoonEconomy: System Active & Monitoring...")

	while true do
		task.wait(PAY_INTERVAL)

		for _, plot in pairs(TycoonFolder:GetChildren()) do
			-- Ensure plot handles exist
			local pendingValue = plot:FindFirstChild("PendingEarnings")
			local padsFolder = plot:FindFirstChild("Pads")

			if pendingValue and padsFolder then
				local plotTotalIncome = 0

				-- Scan all pads
				for _, pad in pairs(padsFolder:GetChildren()) do
					local linkedCar = getLinkedCarValue(pad)

					if linkedCar and linkedCar.Parent then
						local stats = CarStats.Cars[linkedCar.Name]
						if stats then
							plotTotalIncome = plotTotalIncome + stats.CPS
						else
							if not pad:GetAttribute("WarnedMissing") then
								warn("âš ï¸ Economy Warning: No stats found for '" .. linkedCar.Name .. "'")
								pad:SetAttribute("WarnedMissing", true)
							end
						end
					end
				end

				-- 1. Deposit earnings (INTEGER SAFE)
				if plotTotalIncome > 0 then
					pendingValue.Value = pendingValue.Value + math.floor(plotTotalIncome)
				end

				-- 2. Save CPS for the Display Script
				plot:SetAttribute("CurrentCPS", plotTotalIncome)
			end
		end
	end
end)
