-- [[ SERVER SCRIPT: TabletServerHandler (Secure & Fixed) ]]
-- -- Indicating what the script is for: Handles Tablet Owner Info, Secure Claiming, Cooldowns, SFX, and Safe DevProduct Processing.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local Debris = game:GetService("Debris")

-- ‚öôÔ∏è CONFIGURATION
local DEV_PRODUCT_ID = 3509697462
local TYCOON_FOLDER_NAME = "Tycoons"
local CLAIM_COOLDOWN = 1.5 

-- üîä SOUND CONFIGURATION
local SUCCESS_SOUND = "rbxassetid://140072726814802" 
local FAIL_SOUND = "rbxassetid://3779045779" 

-- üìÇ REFERENCES
local TycoonFolder = Workspace:WaitForChild(TYCOON_FOLDER_NAME)
local TabletEvent = ReplicatedStorage:FindFirstChild("TabletEvent") 

if not TabletEvent then
	TabletEvent = Instance.new("RemoteEvent")
	TabletEvent.Name = "TabletEvent"
	TabletEvent.Parent = ReplicatedStorage
end

-- üõ°Ô∏è STATE MANAGEMENT
local playerCooldowns = {}

-- üìä ABBREVIATION HELPER
local SUFFIXES = {"K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"}
local function formatNumber(n)
	n = tonumber(n) or 0
	if n < 1000 then return tostring(math.floor(n)) end
	local i = math.floor(math.log(n, 1000))
	local v = math.pow(1000, i)
	local suffix = SUFFIXES[i] or "?"
	return string.format("%.2f%s", n / v, suffix)
end

-- üßπ HELPER: REMOVE CONSTRAINT
local function nukeConstraints(obj)
	if not obj then return end
	for _, child in pairs(obj:GetChildren()) do
		if child:IsA("UITextSizeConstraint") then
			child:Destroy()
		end
	end
end

-- üîä HELPER: PLAY SOUND
local function playSound(part, soundId, volume)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = volume or 1
	sound.RollOffMaxDistance = 50 
	sound.Parent = part
	sound:Play()
	Debris:AddItem(sound, 2)
end

-- ============================================================================
-- üõ†Ô∏è TABLET SETUP FUNCTION (Visuals on Server)
-- ============================================================================
local function setupTablet(plot)
	task.spawn(function()
		local model = plot:WaitForChild("ClaimEarnings", 30)
		if not model then return end

		-- 1. SETUP TOTAL CPS DISPLAY
		local cpsPart = model:WaitForChild("TotalEarningsPerSecond", 5)
		if cpsPart then
			local cpsGui = cpsPart:WaitForChild("EarningsAmountGUI", 5)
			if cpsGui then
				local cpsLabel = cpsGui:WaitForChild("Value", 5)
				if cpsLabel then
					nukeConstraints(cpsLabel)
					local function updateCPS()
						local currentCPS = plot:GetAttribute("CurrentCPS") or 0
						cpsLabel.Text = "$ " .. formatNumber(currentCPS) .. "/s"
					end
					plot:GetAttributeChangedSignal("CurrentCPS"):Connect(updateCPS)
					updateCPS() 
				end
			end
		end

		local mainPart = model:WaitForChild("Earnings", 10)
		local claimPart = model:WaitForChild("ClaimPart", 10)
		if not mainPart or not claimPart then return end

		-- Anchor Parts
		mainPart.Anchored = true; mainPart.CanCollide = true; mainPart.Velocity = Vector3.zero
		claimPart.Anchored = true; claimPart.CanCollide = true; claimPart.Velocity = Vector3.zero

		-- 2. GET AVATAR & USERNAME GUIS
		local avatarGui = mainPart:WaitForChild("AvatarGUI", 10)
		local usernameGui = mainPart:WaitForChild("UsernameGUI", 10)

		-- Get Revenue GUI
		local revenueGui = mainPart:FindFirstChild("RevenueGUI")
		if not revenueGui and model:FindFirstChild("Revenue-indicator") then
			revenueGui = model["Revenue-indicator"]:FindFirstChild("RevenueGUI")
		end

		if not (avatarGui and usernameGui and revenueGui) then return end

		-- 3. GET LABELS & VALUES
		local avatarLabel = avatarGui:WaitForChild("Avatar-Label")
		local usernameLabel = usernameGui:WaitForChild("Username")
		local revenueLabel = revenueGui:WaitForChild("Total-Revenue")

		local ownerVal = plot:WaitForChild("Owner", 10)
		local pendingVal = plot:WaitForChild("PendingEarnings", 10)

		nukeConstraints(revenueLabel)
		nukeConstraints(avatarLabel)
		nukeConstraints(usernameLabel)

		-- üîß AUTO-FIX: SEPARATE "$" FROM NUMBER
		if revenueLabel:IsA("TextLabel") then
			local dollarLabel = revenueGui:FindFirstChild("Dollar-Static")
			if not dollarLabel then
				dollarLabel = revenueLabel:Clone()
				dollarLabel.Name = "Dollar-Static"
				dollarLabel.Parent = revenueGui
				nukeConstraints(dollarLabel)
				dollarLabel.Text = "$"
				dollarLabel.Size = UDim2.new(0.25, 0, 1, 0)
				dollarLabel.Position = UDim2.new(0, 0, 0, 0)
				dollarLabel.TextXAlignment = Enum.TextXAlignment.Center

				revenueLabel.Size = UDim2.new(0.75, 0, 1, 0)
				revenueLabel.Position = UDim2.new(0.25, 0, 0, 0)
				revenueLabel.TextXAlignment = Enum.TextXAlignment.Left
			else
				nukeConstraints(dollarLabel)
			end
		end

		-- 4. UPDATE FUNCTIONS
		local function updateOwnerInfo()
			local playerName = ownerVal.Value
			if playerName and playerName ~= "" then
				usernameLabel.Text = playerName
				local success, userId = pcall(function() return Players:GetUserIdFromNameAsync(playerName) end)
				if success and userId then
					local content, isReady = Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
					avatarLabel.Image = isReady and content or ""
				else
					avatarLabel.Image = "" 
				end
			else
				usernameLabel.Text = "Vacant"
				avatarLabel.Image = "" 
			end
		end

		local function updateRevenue()
			revenueLabel.Text = formatNumber(pendingVal.Value) 
		end

		-- 5. LISTENERS
		ownerVal.Changed:Connect(updateOwnerInfo)
		pendingVal.Changed:Connect(updateRevenue)

		updateOwnerInfo()
		updateRevenue()
	end)
end

-- Initialize Existing Tycoons
for _, plot in pairs(TycoonFolder:GetChildren()) do setupTablet(plot) end
TycoonFolder.ChildAdded:Connect(setupTablet)

-- ============================================================================
-- üì° REMOTE HANDLING (CLAIM LOGIC)
-- ============================================================================
TabletEvent.OnServerEvent:Connect(function(player, action, plotName)
	local plot = TycoonFolder:FindFirstChild(plotName)
	if not plot then return end

	-- Security Check
	if plot.Owner.Value ~= player.Name then return end

	local pendingVal = plot:FindFirstChild("PendingEarnings")
	local model = plot:FindFirstChild("ClaimEarnings")
	local claimPart = nil
	if model then claimPart = model:FindFirstChild("ClaimPart") end

	if not pendingVal or not claimPart then return end

	if action == "Claim" then
		-- Cooldown
		local lastClaim = playerCooldowns[player.UserId] or 0
		if (os.clock() - lastClaim) < CLAIM_COOLDOWN then return end

		local amount = pendingVal.Value

		if amount > 0 then
			pendingVal.Value = 0 
			local ls = player:FindFirstChild("leaderstats")
			if ls and ls:FindFirstChild("Cash") then 
				ls.Cash.Value += amount 
			end
			playerCooldowns[player.UserId] = os.clock()
			playSound(claimPart, SUCCESS_SOUND, 1.0)
		else
			playerCooldowns[player.UserId] = os.clock()
			playSound(claimPart, FAIL_SOUND, 0.8)
		end

	elseif action == "Prompt2X" then
		local amount = pendingVal.Value
		if amount <= 0 then return end 
		MarketplaceService:PromptProductPurchase(player, DEV_PRODUCT_ID)
	end
end)

-- ============================================================================
-- üí∞ DEV PRODUCT PROCESSOR (SECURE & FIXED)
-- ============================================================================
MarketplaceService.ProcessReceipt = function(receiptInfo)
	if receiptInfo.ProductId == DEV_PRODUCT_ID then
		local player = Players:GetPlayerByUserId(receiptInfo.PlayerId)
		
		-- 1. Player Crashed/Left? Retry later.
		-- Logic: If we return 'PurchaseGranted' now, they lose Robux and get nothing.
		if not player then 
			return Enum.ProductPurchaseDecision.NotProcessedYet 
		end

		local myPlotName = player:GetAttribute("OccupiedPlot")
		local plot = TycoonFolder:FindFirstChild(myPlotName or "")

		-- 2. Player Online, but Plot not loaded yet?
		-- Logic: Wait for the plot to load. Returning 'NotProcessedYet' makes Roblox try again automatically.
		if not plot or not plot:FindFirstChild("PendingEarnings") then
			warn("‚è≥ Transaction Delayed: " .. player.Name .. " has no plot loaded yet.")
			return Enum.ProductPurchaseDecision.NotProcessedYet
		end

		local pendingVal = plot.PendingEarnings
		local amount = pendingVal.Value
		
		if amount > 0 then
			pendingVal.Value = 0
			local ls = player:FindFirstChild("leaderstats")
			if ls and ls:FindFirstChild("Cash") then 
				ls.Cash.Value += (amount * 2) 
			end
			-- Transaction Successful
			return Enum.ProductPurchaseDecision.PurchaseGranted
		else
			-- 3. Edge Case: Player has a plot, but $0 earnings.
			-- We MUST grant the purchase here, or Roblox will retry infinitely for a transaction that will never do anything.
			return Enum.ProductPurchaseDecision.PurchaseGranted
		end
	end
	
	return Enum.ProductPurchaseDecision.NotProcessedYet
end
