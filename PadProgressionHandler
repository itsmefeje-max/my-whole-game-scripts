-- -- Purpose: Handles Pad Unlocking, Visibility, and Purchasing
-- -- Runs on: Server
-- -- Location: ServerScriptService.PadProgressionHandler

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TycoonFolder = Workspace:WaitForChild("Tycoons")
local Debris = game:GetService("Debris") -- Added for sound cleanup

-- ============================================================================
-- üîä SOUND CONFIGURATION (Edit Here)
-- ============================================================================
-- Change this ID to whatever Sound Effect you want for buying a pad
local PURCHASE_SOUND_ID = "rbxassetid://14810387808" 
local PURCHASE_VOLUME = 0.5

print("üü¢ PadProgressionHandler: Loaded & Ready")

-- ============================================================================
-- 1. VISUAL HANDLER (UPDATED FIX)
-- ============================================================================
local function toggleVisual(obj, isVisible, canTouch)
	local transparency = isVisible and 0 or 1
	local collide = isVisible 

	local function applyToPart(part)
		if part:IsA("BasePart") then
			part.Transparency = transparency
			part.CanCollide = collide
			part.CanTouch = canTouch
			part.CanQuery = canTouch
			part.Anchored = true -- Prevents falling buttons
			-- ‚úÖ FIX: Handles BillboardGui (BuyInfo/LockedLabel) and SurfaceGui
		elseif part:IsA("BillboardGui") or part:IsA("SurfaceGui") then
			part.Enabled = isVisible
		end
	end

	-- 1. Apply to the main object itself (The BuyButton Part)
	applyToPart(obj)

	-- 2. Apply to ALL descendants (Finds BuyInfo/LockedLabel inside the Part)
	-- This runs regardless of whether 'obj' is a Model or a BasePart
	for _, child in pairs(obj:GetDescendants()) do 
		applyToPart(child) 
	end
end

local function updatePadVisuals(plot, unlockedLevel)
	unlockedLevel = tonumber(unlockedLevel) or 1
	-- print("üé® DEBUG: Updating " .. plot.Name .. " Visuals for Level " .. unlockedLevel)

	local padsFolder = plot:FindFirstChild("Pads")
	if not padsFolder then return end 

	for i = 1, 14 do
		local padName = "Pad" .. i
		local padModel = padsFolder:FindFirstChild(padName)

		if padModel then
			local geometry = padModel:FindFirstChild("Geometry")
			local buyButton = padModel:FindFirstChild("BuyButton")

			if i <= unlockedLevel then
				-- STATE: OWNED (Show Geometry, Hide Button)
				if geometry then toggleVisual(geometry, true, true) end
				if buyButton then toggleVisual(buyButton, false, false) end

			elseif i == unlockedLevel + 1 then
				-- STATE: NEXT TO BUY (Hide Geometry, Show Button)
				if geometry then toggleVisual(geometry, false, false) end
				if buyButton then toggleVisual(buyButton, true, true) end

			else
				-- STATE: LOCKED (Hide Both)
				if geometry then toggleVisual(geometry, false, false) end
				if buyButton then toggleVisual(buyButton, false, false) end
			end
		end
	end
end

-- ============================================================================
-- 2. SIMPLE BUY FUNCTION
-- ============================================================================
local function setupBuyButton(plot, padModel, padNumber)
	local buyButton = padModel:FindFirstChild("BuyButton")
	if not buyButton then return end 

	if buyButton:GetAttribute("Connected") then return end
	buyButton:SetAttribute("Connected", true)

	local function attemptBuy(player)
		-- 1. Check Owner
		if plot.Owner.Value ~= player.Name then return end

		-- 2. Check Sequence
		local currentLevel = tonumber(player:GetAttribute("HighestUnlockedPad")) or 1
		if padNumber ~= (currentLevel + 1) then return end

		-- 3. Check Money
		-- ‚úÖ FIX: Force tonumber() to prevent "string <= number" errors if Attribute is wrong type
		local cost = tonumber(padModel:GetAttribute("Cost")) or 500

		local leaderstats = player:FindFirstChild("leaderstats")

		-- ‚úÖ CHANGED: We now look for 'Wallet' instead of 'Cash'
		-- This ensures the BalanceManager detects the change and plays the floating text animation.
		local wallet = leaderstats and leaderstats:FindFirstChild("Wallet")

		if wallet and wallet.Value >= cost then
			wallet.Value -= cost -- Deduct from Wallet (Physical Cash)

			player:SetAttribute("HighestUnlockedPad", padNumber) -- Update Data
			updatePadVisuals(plot, padNumber) -- Update Visuals
			print("‚úÖ " .. player.Name .. " Purchased Pad " .. padNumber)

			-- ‚úÖ OPTIONAL: Play Sound (Matches Shop Feel)
			-- MODIFIED: Now uses the Configuration Variables from the top
			local s = Instance.new("Sound")
			s.SoundId = PURCHASE_SOUND_ID 
			s.Volume = PURCHASE_VOLUME
			s.Parent = buyButton:IsA("BasePart") and buyButton or buyButton.PrimaryPart
			s:Play()
			Debris:AddItem(s, 2)
		end
	end

	local function onTouch(hit)
		local player = Players:GetPlayerFromCharacter(hit.Parent)
		if player then attemptBuy(player) end
	end

	if buyButton:IsA("BasePart") then
		buyButton.Touched:Connect(onTouch)
	elseif buyButton:IsA("Model") then
		for _, part in pairs(buyButton:GetDescendants()) do
			if part:IsA("BasePart") then part.Touched:Connect(onTouch) end
		end
	end
end

-- ============================================================================
-- 3. PLOT SETUP
-- ============================================================================
local function setupPlot(plot)
	task.spawn(function()
		local ownerVal = plot:WaitForChild("Owner", 10)
		if not ownerVal then return end

		local function onOwnerChange(newOwner)
			if newOwner == "" then 
				updatePadVisuals(plot, 1) 
			else
				-- üõ°Ô∏è RACE CONDITION FIX: Retry loop to find player
				local player = Players:FindFirstChild(newOwner)
				local retries = 0

				-- If player is nil, wait and try again (up to 5 seconds)
				while not player and retries < 20 do
					task.wait(0.25)
					player = Players:FindFirstChild(newOwner)
					retries += 1
				end

				if player then
					-- Found you! Now we can safely check your level
					local savedLevel = tonumber(player:GetAttribute("HighestUnlockedPad")) or 1
					print("üîé Player Found: " .. newOwner .. " | Loading Pads Level: " .. savedLevel)

					updatePadVisuals(plot, savedLevel)

					-- Listen for future upgrades
					player:GetAttributeChangedSignal("HighestUnlockedPad"):Connect(function()
						local newLevel = tonumber(player:GetAttribute("HighestUnlockedPad")) or 1
						updatePadVisuals(plot, newLevel)
					end)
				else
					warn("‚ùå Critical: Assigned owner '"..newOwner.."' but Player object never loaded.")
				end
			end
		end

		ownerVal.Changed:Connect(onOwnerChange)

		local pads = plot:WaitForChild("Pads", 30)
		if pads then
			for i = 2, 14 do 
				local p = pads:WaitForChild("Pad"..i, 5)
				if p then setupBuyButton(plot, p, i) end
			end
		end

		-- Run immediately if owner is already set
		if ownerVal.Value ~= "" then 
			onOwnerChange(ownerVal.Value) 
		else 
			updatePadVisuals(plot, 1) 
		end
	end)
end

for _, p in pairs(TycoonFolder:GetChildren()) do setupPlot(p) end
TycoonFolder.ChildAdded:Connect(setupPlot)
