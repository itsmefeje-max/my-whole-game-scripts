-- [[ SERVER SIDE: TycoonDataHandler (Step 3: Safety Refund) ]]
-- -- Indicating what the script is for: Saves player data and REFUNDS uncollected ATM money on leave.

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local DataStoreService = game:GetService("DataStoreService")
local Workspace = game:GetService("Workspace")

-- üîí DATABASE CONFIG
local DATA_KEY = "TycoonData_Economy_V3" 
local PlayerDataStore = DataStoreService:GetDataStore(DATA_KEY)

-- üìÇ STORAGE
local CarTools = ServerStorage:WaitForChild("CarTools") 
local TycoonFolder = Workspace:WaitForChild("Tycoons") 
local STARTER_CAR_NAME = "Delta Item" 

-- ============================================================================
-- üõ†Ô∏è HELPER FUNCTIONS
-- ============================================================================

local function giveTool(player, toolName)
	if not player or not player.Parent then return end
	if player.Backpack:FindFirstChild(toolName) or player.StarterGear:FindFirstChild(toolName) then return end

	local tool = CarTools:FindFirstChild(toolName)
	if tool then
		tool:Clone().Parent = player.Backpack
		tool:Clone().Parent = player.StarterGear
	end
end

local function findPlayerPlot(player)
	-- 1. Check Attribute
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName and TycoonFolder:FindFirstChild(plotName) then
		return TycoonFolder[plotName]
	end
	-- 2. Fallback Search
	for _, plot in pairs(TycoonFolder:GetChildren()) do
		local ownerVal = plot:FindFirstChild("Owner") 
		if ownerVal and (ownerVal.Value == player or ownerVal.Value == player.Name) then
			return plot
		end
	end
	return nil
end

-- Pushes restored money back to the Tycoon Sign
local function pushMoneyToPlot(player)
	local amount = player:GetAttribute("RestoredPending")
	if not amount or amount <= 0 then return end

	local plot = findPlayerPlot(player)
	if plot then
		local pendingVal = plot:FindFirstChild("PendingEarnings")
		if pendingVal then
			pendingVal.Value = pendingVal.Value + amount
			player:SetAttribute("RestoredPending", 0) -- Clear memory so we don't add it twice
			print("üí∞ Restored $" .. amount .. " to " .. player.Name .. "'s Tycoon Sign.")
		end
	end
end

-- ============================================================================
-- üì• JOIN LOGIC
-- ============================================================================
Players.PlayerAdded:Connect(function(player)
	local leaderstats = Instance.new("Folder"); leaderstats.Name = "leaderstats"; leaderstats.Parent = player
	local bank = Instance.new("IntValue"); bank.Name = "Cash"; bank.Parent = leaderstats
	local wallet = Instance.new("IntValue"); wallet.Name = "Wallet"; wallet.Value = 0; wallet.Parent = leaderstats

	-- Initialize Attributes
	player:SetAttribute("PendingATM", 0)

	local playerKey = "User_" .. player.UserId
	local savedData = nil

	local success, errorMessage = pcall(function() 
		savedData = PlayerDataStore:GetAsync(playerKey) 
	end)

	if success then
		player:SetAttribute("DataLoaded", true)

		if savedData then
			print("‚úÖ Loaded Data for " .. player.Name)
			bank.Value = savedData.Bank or 0
			wallet.Value = savedData.Wallet or 0

			if savedData.Inventory then
				for _, tName in pairs(savedData.Inventory) do giveTool(player, tName) end
			end

			-- Handle Tycoon Earnings Restoration
			if savedData.PendingEarnings and savedData.PendingEarnings > 0 then
				player:SetAttribute("RestoredPending", savedData.PendingEarnings)
				pushMoneyToPlot(player)
			end
		else
			print("üÜï New Player: " .. player.Name)
			bank.Value = 0
			wallet.Value = 0
			giveTool(player, STARTER_CAR_NAME) 
		end
	else
		warn("‚ö†Ô∏è DATA LOAD ERROR: " .. tostring(errorMessage))
		player:Kick("Data failed to load. Please rejoin.")
	end

	-- Listen for plot assignment
	player:GetAttributeChangedSignal("OccupiedPlot"):Connect(function()
		pushMoneyToPlot(player)
	end)
end)

-- ============================================================================
-- üíæ LEAVE LOGIC (With Safety Refund)
-- ============================================================================
local function savePlayerData(player)
	if not player:GetAttribute("DataLoaded") then return end

	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	-- üõ°Ô∏è [NEW SAFETY FIX] üõ°Ô∏è
	-- Check if they have money stuck in "PendingATM"
	local pendingATM = player:GetAttribute("PendingATM") or 0
	local totalBank = leaderstats.Cash.Value

	if pendingATM > 0 then
		print("üîÑ REFUNDING: " .. player.Name .. " left with $" .. pendingATM .. " uncollected. Returning to Bank.")
		totalBank = totalBank + pendingATM -- Safely add it back to the saved value
	end
	-- üõ°Ô∏è [END SAFETY FIX] üõ°Ô∏è

	local inventoryTable = {}
	if player:FindFirstChild("StarterGear") then
		for _, tool in pairs(player.StarterGear:GetChildren()) do
			if CarTools:FindFirstChild(tool.Name) then table.insert(inventoryTable, tool.Name) end
		end
	end

	-- Capture Pending Earnings (Tycoon)
	local currentPending = 0
	local plot = findPlayerPlot(player)
	if plot then
		local pendingVal = plot:FindFirstChild("PendingEarnings")
		if pendingVal then currentPending = pendingVal.Value end
	end

	local memoryPending = player:GetAttribute("RestoredPending") or 0
	if memoryPending > 0 then
		currentPending = currentPending + memoryPending
	end

	local playerKey = "User_" .. player.UserId
	local success, err = pcall(function()
		PlayerDataStore:UpdateAsync(playerKey, function(oldData)
			return {
				Bank = totalBank, -- Uses the Refunded Amount
				Wallet = leaderstats.Wallet.Value,
				Inventory = inventoryTable,
				PendingEarnings = currentPending 
			}
		end)
	end)

	if success then print("üíæ Saved Data safely for " .. player.Name)
	else warn("‚ö†Ô∏è Save Failed: " .. tostring(err)) end
end

Players.PlayerRemoving:Connect(savePlayerData)
game:BindToClose(function() 
	for _, p in pairs(Players:GetPlayers()) do task.spawn(function() savePlayerData(p) end) end 
	task.wait(3) 
end)
