-- [[ SERVER SIDE: TycoonDataHandler (V14: FORCE RESTORE DEBUG) ]]
-- [[ FIXES: Forces cars to spawn even if Backpack is empty/loading ]]

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local DataStoreService = game:GetService("DataStoreService")
local Workspace = game:GetService("Workspace")

local DATA_KEY = "TycoonData_Production_V14_ForceRestore"
local PlayerDataStore = DataStoreService:GetDataStore(DATA_KEY)

local CarTools = ServerStorage:WaitForChild("CarTools")
local CarModels = ServerStorage:WaitForChild("CarModels")
local TycoonFolder = Workspace:WaitForChild("Tycoons")
local STARTER_CAR_NAME = "Delta Item"

-- ============================================================================
-- ðŸ› ï¸ HELPER: GET MAIN PART (Matches PadController)
-- ============================================================================
local function getMainPart(obj)
	if obj:IsA("BasePart") then return obj end
	if obj:IsA("Model") then
		return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

-- ============================================================================
-- ðŸ§  NAME MATCHING
-- ============================================================================
local function FindToolNameFromModel(modelName)
	if CarTools:FindFirstChild(modelName) then return modelName end
	if CarTools:FindFirstChild(modelName .. " Item") then return modelName .. " Item" end
	local clean = modelName:gsub(" Item", ""):gsub("Item", "")
	for _, t in pairs(CarTools:GetChildren()) do
		if t.Name:gsub(" Item", "") == clean then return t.Name end
	end
	return nil
end

local function FindModelNameFromTool(toolName)
	local clean = toolName:gsub(" Item", ""):gsub("Item", "")
	if CarModels:FindFirstChild(clean) then return clean end
	return nil
end

local function giveTool(player, toolName)
	if not player.Parent then return end
	if player.Backpack:FindFirstChild(toolName) or player.StarterGear:FindFirstChild(toolName) then return end
	
	local tool = CarTools:FindFirstChild(toolName)
	if not tool then
		local rec = FindToolNameFromModel(toolName)
		if rec then tool = CarTools:FindFirstChild(rec) end
	end
	if tool then
		tool:Clone().Parent = player.Backpack
		tool:Clone().Parent = player.StarterGear
	end
end

-- ============================================================================
-- ðŸ—ï¸ RESTORE LAYOUT (V14: FORCE MODE)
-- ============================================================================
local function RestoreLayout(player, plot, layoutData)
	if not layoutData then return end
	
	local padsFolder = plot:WaitForChild("Pads", 10)
	local placedCarsFolder = plot:WaitForChild("PlacedCars", 10)
	
	print("ðŸ—ï¸ [RESTORE START]: Attempting to restore " .. #layoutData .. " cars.")

	for _, data in pairs(layoutData) do
		local toolName = data.Tool
		local padName = data.Pad
		
		-- 1. Find the Pad
		local pad = padsFolder:FindFirstChild(padName)
		if pad then
			local padPart = getMainPart(pad)
			if padPart then
				local isOccupied = padPart:FindFirstChild("IsOccupied")
				
				-- 2. Force Place Check
				-- We place it even if we can't find the tool in the bag (we trust the save data)
				if isOccupied and not isOccupied.Value then
					local realModelName = FindModelNameFromTool(toolName)
					local carModel = CarModels:FindFirstChild(realModelName)
					
					if carModel then
						print("   âœ… Placing '" .. realModelName .. "' on " .. padName)
						
						-- A. CLEANUP INVENTORY (Anti-Dupe)
						-- We aggressively search and destroy the tool so they don't have 2 copies
						local bagTool = player.Backpack:FindFirstChild(toolName)
						if bagTool then bagTool:Destroy() end
						
						local gearTool = player.StarterGear:FindFirstChild(toolName)
						if gearTool then gearTool:Destroy() end
						
						-- B. SPAWN CAR
						local newCar = carModel:Clone()
						local padTop = padPart.CFrame * CFrame.new(0, (padPart.Size.Y/2) + 5, 0)
						newCar:PivotTo(padTop)
						newCar.Parent = placedCarsFolder
						
						-- C. LOCK PAD
						isOccupied.Value = true
						local linked = padPart:FindFirstChild("LinkedCar")
						if linked then linked.Value = newCar end
						
						-- D. ANCHOR & PROMPTS
						for _, p in pairs(newCar:GetDescendants()) do
							if p:IsA("BasePart") then p.Anchored = true; p.CanCollide = true end
						end
						
						if padPart:FindFirstChild("PlacePrompt") then padPart.PlacePrompt.Enabled = false end
						if padPart:FindFirstChild("PickupPrompt") then padPart.PickupPrompt.Enabled = true end
					else
						warn("   âŒ Car Model missing for tool: " .. toolName)
					end
				else
					warn("   âš ï¸ Pad " .. padName .. " is already occupied or missing 'IsOccupied' value.")
				end
			else
				warn("   âš ï¸ Pad " .. padName .. " has no Main Part!")
			end
		else
			warn("   âš ï¸ Could not find Pad: " .. tostring(padName))
		end
	end
end

-- ============================================================================
-- ðŸ“¥ LOADING
-- ============================================================================
Players.PlayerAdded:Connect(function(player)
	local ls = Instance.new("Folder"); ls.Name = "leaderstats"; ls.Parent = player
	local cash = Instance.new("IntValue"); cash.Name = "Cash"; cash.Parent = ls
	local wallet = Instance.new("IntValue"); wallet.Name = "Wallet"; wallet.Parent = ls
	local atm = Instance.new("IntValue"); atm.Name = "ATMBalance"; atm.Parent = ls

	local key = "User_V14_" .. player.UserId
	local data = nil
	local success, err = pcall(function() data = PlayerDataStore:GetAsync(key) end)

	if success then
		player:SetAttribute("DataLoaded", true)
		if data then
			cash.Value = data.Bank or 0
			wallet.Value = data.Wallet or 0
			atm.Value = data.ATMBalance or 0
			
			-- 1. Restore Inventory
			if data.Inventory then
				for _, name in pairs(data.Inventory) do giveTool(player, name) end
			end
			
			-- 2. Restore Pending
			if data.PendingEarnings then
				player:SetAttribute("RestoredPending", data.PendingEarnings)
			end
			
			-- 3. Restore Layout
			if data.Layout then
				print("ðŸ“¥ [DATA]: Found Layout Data. Waiting for plot...")
				player:GetAttributeChangedSignal("OccupiedPlot"):Connect(function()
					local plotName = player:GetAttribute("OccupiedPlot")
					local plot = TycoonFolder:FindFirstChild(plotName)
					if plot then
						task.wait(2) -- Allow plot to load/wipe
						RestoreLayout(player, plot, data.Layout)
					end
				end)
			end
		else
			giveTool(player, STARTER_CAR_NAME)
		end
	else
		player:Kick("âš ï¸ Data Load Error. Please Rejoin.")
	end
	
	player:GetAttributeChangedSignal("OccupiedPlot"):Connect(function() 
		local amount = player:GetAttribute("RestoredPending")
		if amount and amount > 0 then
			local plot = TycoonFolder:FindFirstChild(player:GetAttribute("OccupiedPlot"))
			if plot and plot:FindFirstChild("PendingEarnings") then
				plot.PendingEarnings.Value += amount
				player:SetAttribute("RestoredPending", 0)
			end
		end
	end)
end)

-- ============================================================================
-- ðŸ’¾ SAVING (NO CHANGES NEEDED, LOGIC IS SOLID)
-- ============================================================================
local function save(player)
	if not player:GetAttribute("DataLoaded") then return end
	
	local inventory = {}
	local layout = {}
	local seen = {}
	local totalPending = player:GetAttribute("RestoredPending") or 0
	
	local function add(name)
		if not seen[name] then table.insert(inventory, name); seen[name] = true end
	end

	-- 1. Save Inventory
	for _, t in pairs(player.Backpack:GetChildren()) do if CarTools:FindFirstChild(t.Name) then add(t.Name) end end
	if player:FindFirstChild("StarterGear") then
		for _, t in pairs(player.StarterGear:GetChildren()) do if CarTools:FindFirstChild(t.Name) then add(t.Name) end end
	end
	
	-- 2. Save Plot Layout
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName and TycoonFolder:FindFirstChild(plotName) then
		local plot = TycoonFolder[plotName]
		
		if plot:FindFirstChild("PendingEarnings") then 
			totalPending = totalPending + plot.PendingEarnings.Value 
		end
		
		local pads = plot:FindFirstChild("Pads")
		if pads then
			for _, pad in pairs(pads:GetChildren()) do
				local padPart = getMainPart(pad)
				
				if padPart then
					local linked = padPart:FindFirstChild("LinkedCar")
					if linked and linked.Value then
						local tName = FindToolNameFromModel(linked.Value.Name)
						if tName then
							-- Save exact location
							table.insert(layout, {Tool = tName, Pad = pad.Name})
							add(tName) -- Ensure ownership
						end
					end
				end
			end
		end
	end
	
	local key = "User_V14_" .. player.UserId
	pcall(function()
		PlayerDataStore:UpdateAsync(key, function()
			return {
				Bank = player.leaderstats.Cash.Value,
				Wallet = player.leaderstats.Wallet.Value,
				ATMBalance = player.leaderstats.ATMBalance.Value,
				Inventory = inventory,
				Layout = layout,
				PendingEarnings = totalPending
			}
		end)
	end)
	print("ðŸ’¾ [SAVED] " .. player.Name .. " | Cars: " .. #layout)
end

Players.PlayerRemoving:Connect(save)
game:BindToClose(function()
	for _, p in pairs(Players:GetPlayers()) do save(p) end
	task.wait(3)
end)
