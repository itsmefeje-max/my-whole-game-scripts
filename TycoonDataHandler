-- [[ SERVER SIDE: TycoonDataHandler (UpdateAsync Fix) ]]
-- Indicating what the script is for: Safe data saving using UpdateAsync, anti-wipe protection, and auto-plot detection.

local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local Workspace = game:GetService("Workspace")

-- CONFIGURATION
local DATA_KEY = "TycoonData_V1_Prod" -- Change this key to reset everyone's data if needed
local PlayerDataStore = DataStoreService:GetDataStore(DATA_KEY)

-- REFERENCES
-- Ensure these exist in your game!
local TycoonFolder = Workspace:WaitForChild("TycoonFolder") 
local CarTools = ServerStorage:WaitForChild("CarTools") -- Folder containing your Car Tools

-------------------------------------------------------------------------
-- HELPER FUNCTIONS
-------------------------------------------------------------------------

-- Find the player's plot even if attributes fail
local function findPlayerPlot(player)
	-- 1. Check Attribute (Fastest)
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName and TycoonFolder:FindFirstChild(plotName) then
		return TycoonFolder[plotName]
	end

	-- 2. Fallback: Search manually (Safety Net)
	for _, plot in pairs(TycoonFolder:GetChildren()) do
		local ownerVal = plot:FindFirstChild("Owner") -- Assuming you use an ObjectValue or StringValue for Owner
		if ownerVal and (ownerVal.Value == player or ownerVal.Value == player.Name) then
			return plot
		end
	end
	return nil
end

-------------------------------------------------------------------------
-- SAVING DATA
-------------------------------------------------------------------------

local function savePlayerData(player)
	-- ğŸ›‘ CRITICAL CHECK: Never save if data didn't load successfully
	if not player:GetAttribute("DataLoaded") then 
		warn("âš ï¸ PROTECTED: Prevented overwrite of empty data for " .. player.Name)
		return 
	end

	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	-- 1. Scan Inventory (StarterGear)
	local inventoryTable = {}
	-- We check StarterGear because Backpacker items might be equipped/missing
	if player:FindFirstChild("StarterGear") then
		for _, tool in pairs(player.StarterGear:GetChildren()) do
			-- Verify the tool exists in our game database (CarTools)
			if CarTools:FindFirstChild(tool.Name) then 
				table.insert(inventoryTable, tool.Name) 
			end
		end
	end

	-- 2. CAPTURE PENDING EARNINGS
	local currentPending = 0
	
	-- Check active plot
	local plot = findPlayerPlot(player)
	if plot then
		local pendingVal = plot:FindFirstChild("PendingEarnings")
		if pendingVal then 
			currentPending = pendingVal.Value 
		end
	end
	
	-- Check if we cached earnings (e.g. if plot was destroyed before player left)
	local cached = player:GetAttribute("CachedPending")
	if cached and cached > 0 then 
		-- Add cached to current if logic allows, or take the max. 
		-- Usually, if plot is gone, currentPending is 0, so this works.
		currentPending = currentPending + cached 
	end

	local playerKey = "User_" .. player.UserId
	
	-- 3. UPDATE ASYNC (The Safe Way)
	local success, err = pcall(function()
		PlayerDataStore:UpdateAsync(playerKey, function(oldData)
			-- Define the new data structure
			local newData = {
				Bank = leaderstats.Cash.Value,
				Wallet = leaderstats.Wallet.Value,
				Inventory = inventoryTable,
				PendingEarnings = currentPending
			}
			return newData
		end)
	end)

	if success then
		print("ğŸ’¾ Saved Data safely for " .. player.Name)
	else
		warn("âš ï¸ CRITICAL: Data Save Failed for " .. player.Name .. ": " .. tostring(err))
	end
end

-------------------------------------------------------------------------
-- LOADING DATA
-------------------------------------------------------------------------

local function loadPlayerData(player)
	-- 1. Create Leaderstats
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local cash = Instance.new("IntValue")
	cash.Name = "Cash" -- Bank
	cash.Parent = leaderstats
	
	local wallet = Instance.new("IntValue")
	wallet.Name = "Wallet"
	wallet.Parent = leaderstats

	local playerKey = "User_" .. player.UserId
	local data
	local success, err = pcall(function()
		data = PlayerDataStore:GetAsync(playerKey)
	end)

	if success then
		if data then
			-- LOAD EXISTING DATA
			cash.Value = data.Bank or 0
			wallet.Value = data.Wallet or 0
			
			-- Load Inventory
			if data.Inventory then
				for _, toolName in pairs(data.Inventory) do
					local originalTool = CarTools:FindFirstChild(toolName)
					if originalTool then
						originalTool:Clone().Parent = player.StarterGear
						originalTool:Clone().Parent = player.Backpack
					end
				end
			end
			
			-- Load Pending Earnings (Apply directly to Wallet or Cash? Or keep pending?)
			-- Usually we dump it into the wallet on load so they don't lose it.
			if data.PendingEarnings and data.PendingEarnings > 0 then
				wallet.Value = wallet.Value + data.PendingEarnings
				print("ğŸ’° Restored " .. data.PendingEarnings .. " pending cash to " .. player.Name)
			end
			
			print("âœ… Data Loaded for " .. player.Name)
		else
			-- NEW PLAYER
			print("ğŸ†• New Player detected: " .. player.Name)
			cash.Value = 0 -- Starting Cash
			wallet.Value = 0
		end
		
		-- ğŸ›‘ CRITICAL: MARK DATA AS LOADED
		player:SetAttribute("DataLoaded", true)
		
	else
		warn("âš ï¸ Error loading data for " .. player.Name .. ": " .. tostring(err))
		-- Do NOT set DataLoaded attribute. This prevents saving over their data with 0s.
		player:Kick("Data failed to load. Please rejoin to prevent data loss.") 
	end
end

-------------------------------------------------------------------------
-- EVENT LISTENERS
-------------------------------------------------------------------------

Players.PlayerAdded:Connect(loadPlayerData)

Players.PlayerRemoving:Connect(function(player)
	savePlayerData(player)
end)

-- Server Shutdown Safety
game:BindToClose(function()
	print("ğŸ›‘ Server Shutting Down - Saving All Players...")
	for _, player in pairs(Players:GetPlayers()) do
		task.spawn(function()
			savePlayerData(player)
		end)
	end
	task.wait(3) -- Give the server 3 seconds to finish saving requests
end)
