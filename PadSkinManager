-- [[ SERVER SCRIPT: PadSkinManager (SMART RESTORE) ]]
-- Purpose: Visual Handler. Paints Gold, but REMEMBERS original colors to restore them later.
-- Location: ServerScriptService

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local TycoonFolder = Workspace:WaitForChild("Tycoons")
local BaseSkinStats = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ðŸ’¾ MEMORY SYSTEM (To remember original colors)
-- Uses weak keys so it doesn't leak memory if parts are destroyed
local OriginalStateCache = {}
setmetatable(OriginalStateCache, {__mode = "k"}) 

-- ðŸ›‘ EXCLUSION CHECK
local function IsIgnored(part)
	if part.Name == "BuyButton" then return true end
	if part.Parent and part.Parent.Name == "BuyButton" then return true end
	if part.Name == "Price" or part.Name == "PriceLabel" then return true end
	if part.Transparency >= 1 then return true end -- Don't paint invisible triggers
	return false
end

-- ðŸŽ¨ THE SMART PAINT ENGINE
local function PaintPlot(plot, skinName)
	if not plot then return end

	local skinData = BaseSkinStats[skinName]
	local isDefault = (skinName == "Default" or skinName == nil)

	-- If not default and no data, stop
	if not isDefault and not skinData then return end

	local padsFolder = plot:FindFirstChild("Pads")
	if not padsFolder then return end

	print("ðŸŽ¨ Updating " .. plot.Name .. " to " .. (skinName or "Default"))

	for _, padModel in pairs(padsFolder:GetChildren()) do

		-- 1. GATHER PARTS
		local partsToPaint = {}

		-- Check model itself
		if padModel:IsA("BasePart") and not IsIgnored(padModel) then
			table.insert(partsToPaint, padModel)
		end

		-- Check children
		for _, part in pairs(padModel:GetDescendants()) do
			if part:IsA("BasePart") and not IsIgnored(part) then
				table.insert(partsToPaint, part)
			end
		end

		-- 2. CAPTURE ORIGINAL STATE (Before we change anything!)
		for _, part in ipairs(partsToPaint) do
			if not OriginalStateCache[part] then
				OriginalStateCache[part] = {
					Color = part.Color,
					Material = part.Material,
					Reflectance = part.Reflectance
				}
			end
		end

		-- 3. APPLY OR RESTORE
		if isDefault then
			-- ðŸ”™ RESTORE ORIGINALS (Cancel the Paint)
			for _, part in ipairs(partsToPaint) do
				local original = OriginalStateCache[part]
				if original then
					part.Color = original.Color
					part.Material = original.Material
					part.Reflectance = original.Reflectance
				end
			end
		else
			-- âœ¨ APPLY GOLD SKIN
			-- Sort: Biggest part gets Metal, small parts get Neon
			table.sort(partsToPaint, function(a, b)
				local volA = a.Size.X * a.Size.Y * a.Size.Z
				local volB = b.Size.X * b.Size.Y * b.Size.Z
				return volA > volB 
			end)

			for i, part in ipairs(partsToPaint) do
				part.Color = skinData.Color

				if i == 1 then
					-- Base = Shiny Metal
					part.Material = Enum.Material.Metal
					part.Reflectance = 0.4
				else
					-- Details = Neon
					part.Material = Enum.Material.Neon
					part.Reflectance = 0
				end
			end
		end
	end
end

-- ðŸ”„ PLAYER MONITOR
local function SetupPlayer(player)
	task.spawn(function()
		local plotName = player:GetAttribute("OccupiedPlot")
		while not plotName do
			player:GetAttributeChangedSignal("OccupiedPlot"):Wait()
			plotName = player:GetAttribute("OccupiedPlot")
		end

		local plot = TycoonFolder:WaitForChild(plotName, 10)
		if not plot then return end

		-- A. Initial Check (Will capture defaults if no skin equipped)
		local currentSkin = player:GetAttribute("EquippedSkin") or "Default"
		PaintPlot(plot, currentSkin)

		-- B. Live Listener
		player:GetAttributeChangedSignal("EquippedSkin"):Connect(function()
			local newSkin = player:GetAttribute("EquippedSkin")
			PaintPlot(plot, newSkin)
		end)
	end)
end

Players.PlayerAdded:Connect(SetupPlayer)
for _, p in pairs(Players:GetPlayers()) do SetupPlayer(p) end
