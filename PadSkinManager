-- [[ SERVER SCRIPT: PadSkinManager (ADDED SILVER SAFETY) ]]
-- Purpose: Visual Handler. Paints Silver/Gold/Diamond/Rainbow. 
-- Fixes: Uses Tags for Rainbows + Correct Materials + Safety Checks.
-- Location: ServerScriptService

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")

local TycoonFolder = Workspace:WaitForChild("Tycoons")
local BaseSkinStats = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ============================================================================
-- ðŸŽ¨ CONFIGURATION (THE "NORMAL" LOOK)
-- ============================================================================
local DEFAULT_COLOR = Color3.fromRGB(163, 162, 165) 
local DEFAULT_MATERIAL = Enum.Material.Plastic
local DEFAULT_REFLECTANCE = 0

-- ðŸ›‘ EXCLUSION CHECK
local function IsIgnored(part)
	if part.Name == "BuyButton" then return true end
	if part.Parent and part.Parent.Name == "BuyButton" then return true end
	if part.Name == "Price" or part.Name == "PriceLabel" then return true end
	if part.Transparency >= 1 then return true end 
	return false
end

-- ðŸ’¾ SAVE STATE (Updated for Silver Safety)
local function EnsureOriginalStateSaved(part)
	if part:GetAttribute("Skin_OrigColor") then return end 

	-- CHECK: Is it ALREADY a Skin?
	-- 1. Silver (192, 192, 192) âœ… NEW CHECK
	-- 2. Gold (255, 215, 0)
	-- 3. Diamond Cyan (85, 255, 255)
	-- 4. Rainbow White (255, 255, 255) 
	local isSuspect = (part.Material == Enum.Material.Metal or part.Material == Enum.Material.Neon) 
		and (part.Color == Color3.fromRGB(255, 215, 0) 
			or part.Color == Color3.fromRGB(85, 255, 255)
			or part.Color == Color3.fromRGB(255, 255, 255)
			or part.Color == Color3.fromRGB(192, 192, 192)) -- Silver Check

	if isSuspect then
		-- It looks like a skin. DO NOT save this as "Original".
		return
	end

	-- It looks normal, so save it!
	part:SetAttribute("Skin_OrigColor", part.Color)
	part:SetAttribute("Skin_OrigMat", part.Material.Name)
	part:SetAttribute("Skin_OrigRef", part.Reflectance)
end

-- ðŸŽ¨ THE PAINT ENGINE
local function PaintPlot(plot, skinName)
	if not plot then return end

	local skinData = BaseSkinStats[skinName]
	local isDefault = (skinName == "Default" or skinName == nil)

	if not isDefault and not skinData then return end

	local padsFolder = plot:FindFirstChild("Pads")
	if not padsFolder then return end

	print("ðŸŽ¨ Updating " .. plot.Name .. " to " .. (skinName or "Default"))

	for _, padModel in pairs(padsFolder:GetChildren()) do

		-- 1. GATHER PARTS
		local partsToPaint = {}
		if padModel:IsA("BasePart") and not IsIgnored(padModel) then
			table.insert(partsToPaint, padModel)
		end
		for _, part in pairs(padModel:GetDescendants()) do
			if part:IsA("BasePart") and not IsIgnored(part) then
				table.insert(partsToPaint, part)
			end
		end

		-- 2. SAVE ORIGINALS
		for _, part in ipairs(partsToPaint) do
			EnsureOriginalStateSaved(part)
		end

		-- 3. APPLY OR RESTORE
		if isDefault then
			-- ðŸ”™ RESTORE MODE
			for _, part in ipairs(partsToPaint) do
				-- ðŸ›‘ CLEANUP: Remove Rainbow Tag (Using CollectionService)
				if CollectionService:HasTag(part, "RainbowEffect") then
					CollectionService:RemoveTag(part, "RainbowEffect")
				end

				local origColor = part:GetAttribute("Skin_OrigColor")
				local origMat = part:GetAttribute("Skin_OrigMat")
				local origRef = part:GetAttribute("Skin_OrigRef")

				if origColor and origMat then
					part.Color = origColor
					part.Material = Enum.Material[origMat]
					part.Reflectance = origRef or 0
				else
					-- Fallback Fix
					part.Color = DEFAULT_COLOR
					part.Material = DEFAULT_MATERIAL
					part.Reflectance = DEFAULT_REFLECTANCE
				end
			end
		else
			-- âœ¨ SKIN MODE (SILVER, GOLD, DIAMOND, RAINBOW)

			-- Sort: Biggest part first (for Gold/Silver metal base)
			table.sort(partsToPaint, function(a, b)
				local volA = a.Size.X * a.Size.Y * a.Size.Z
				local volB = b.Size.X * b.Size.Y * b.Size.Z
				return volA > volB 
			end)

			for i, part in ipairs(partsToPaint) do
				-- Apply Base Color (Silver, Gold, Cyan, or White)
				part.Color = skinData.Color 

				-- ðŸŒˆ HANDLE RAINBOW (Animated)
				if skinData.IsRainbow then
					-- âœ… ADD TAG FOR CLIENT TO DETECT
					if not CollectionService:HasTag(part, "RainbowEffect") then
						CollectionService:AddTag(part, "RainbowEffect")
					end

					part.Material = Enum.Material.Neon
					part.Reflectance = 0
				else
					-- ðŸ’Ž HANDLE STATIC SKINS (Silver, Gold, Diamond)
					if CollectionService:HasTag(part, "RainbowEffect") then
						CollectionService:RemoveTag(part, "RainbowEffect")
					end

					if i == 1 then
						-- âœ… FIX: Use the Material from Stats (Metal for Silver/Gold, Neon for Diamond)
						part.Material = skinData.Material or Enum.Material.Metal 
						part.Reflectance = 0.4
					else
						part.Material = Enum.Material.Neon -- Details are Neon
						part.Reflectance = 0
					end
				end
			end
		end
	end
end

-- ðŸ”„ PLAYER MONITOR
local function SetupPlayer(player)
	task.spawn(function()
		local plotName = player:GetAttribute("OccupiedPlot")
		while not plotName do
			player:GetAttributeChangedSignal("OccupiedPlot"):Wait()
			plotName = player:GetAttribute("OccupiedPlot")
		end

		local plot = TycoonFolder:WaitForChild(plotName, 10)
		if not plot then return end

		local currentSkin = player:GetAttribute("EquippedSkin") or "Default"
		PaintPlot(plot, currentSkin)

		player:GetAttributeChangedSignal("EquippedSkin"):Connect(function()
			local newSkin = player:GetAttribute("EquippedSkin")
			PaintPlot(plot, newSkin)
		end)
	end)
end

Players.PlayerAdded:Connect(SetupPlayer)
for _, p in pairs(Players:GetPlayers()) do SetupPlayer(p) end

-- ðŸš‘ EMERGENCY CLEANUP
for _, p in pairs(Players:GetPlayers()) do SetupPlayer(p) end
