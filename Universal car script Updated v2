-- [[ LOCAL SCRIPT: UniversalNPCGaze (Super Slow Motion) ]]
-- -- Indicating what the script is for: Handles cinematic, heavy-weight head tracking.
-- TUNED FOR: Extremely slow, realistic head turns.

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local npcFolder = Workspace:WaitForChild("NPCS") -- ðŸ“ Ensure your NPCs are in this folder

-- âš™ï¸ SUPER SLOW TUNING
local MAX_DISTANCE = 35        -- Studs: Range to start looking
local RETURN_SPEED = 0.005     -- (Was 0.02) Extremely slow drift back (Heavy feel)
local TRACK_SPEED = 0.02       -- (Was 0.05) Gentle turn when looking at you
local SHOULDER_LIMIT = 85      -- Degrees: Angle where they stop looking
local VERTICAL_LIMIT = 40      -- Degrees: Max Up/Down angle

-- ðŸ› ï¸ MATH HELPER: Normalize angles
local function getGoalCFrame(rootPart, lookAtPos)
	-- Convert global position to local space relative to the NPC
	local relativePos = rootPart.CFrame:PointToObjectSpace(lookAtPos)

	-- 1. BEHIND CHECK: If Z is positive, the player is behind.
	if relativePos.Z > 0.5 then
		return CFrame.new() -- Return straight
	end

	-- 2. CALCULATE ANGLES
	local xAngle = math.atan2(relativePos.Y, -relativePos.Z)
	local yAngle = math.atan2(-relativePos.X, -relativePos.Z)

	-- 3. SHOULDER CHECK: Stop if turning head too far
	if math.abs(math.deg(yAngle)) > SHOULDER_LIMIT then
		return CFrame.new() -- Return straight
	end

	-- 4. CLAMP VERTICAL
	xAngle = math.clamp(xAngle, math.rad(-VERTICAL_LIMIT), math.rad(VERTICAL_LIMIT))

	-- 5. RETURN GOAL (Dampen X slightly for realism)
	return CFrame.Angles(xAngle / 1.5, yAngle, 0)
end

-- ðŸ”„ MAIN RENDER LOOP
RunService.RenderStepped:Connect(function()
	local myCharacter = player.Character
	if not myCharacter then return end
	local myHead = myCharacter:FindFirstChild("Head")
	if not myHead then return end

	for _, npc in pairs(npcFolder:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("Head") and npc:FindFirstChild("UpperTorso") then
			local head = npc.Head
			local neck = head:FindFirstChild("Neck")
			local torso = npc.UpperTorso

			if neck then
				-- Setup Original Position (Once)
				if not neck:GetAttribute("OriginalC0") then
					neck:SetAttribute("OriginalC0", neck.C0)
				end
				local originalC0 = neck:GetAttribute("OriginalC0")

				-- Calculate Logic
				local dist = (head.Position - myHead.Position).Magnitude
				local targetCFrame = CFrame.new()
				local currentAlpha = RETURN_SPEED 

				-- Active Tracking
				if dist < MAX_DISTANCE then
					local potentialGoal = getGoalCFrame(torso, myHead.Position)

					if potentialGoal == CFrame.new() then
						-- Player is in range but behind/out of angle -> Slow Return
						targetCFrame = CFrame.new()
						currentAlpha = RETURN_SPEED 
					else
						-- Player is in valid view -> Smooth Track
						targetCFrame = potentialGoal
						currentAlpha = TRACK_SPEED
					end
				else
					-- Player is far away -> Slow Return
					targetCFrame = CFrame.new()
					currentAlpha = RETURN_SPEED
				end

				-- ANIMATE: Soft Lerp
				neck.C0 = neck.C0:Lerp(originalC0 * targetCFrame, currentAlpha)
			end
		end
	end
end)
