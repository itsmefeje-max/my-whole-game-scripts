-- this script contains the Garage that controls the sign and to whoever the specific Garage belongs to
--ServerScriptService

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

-- CONFIGURATION
local tycoonsFolder = Workspace:WaitForChild("Tycoons")

-- ---------------------------------------------------------
-- HELPER: TOGGLE VISIBILITY
-- ---------------------------------------------------------
local function setSignVisibility(signPart, isVisible)
	-- 1. Control the Parts (The wood, the board, the stand)
	for _, child in ipairs(signPart:GetDescendants()) do
		if child:IsA("BasePart") then
			-- If Visible = 0 transparency (Solid). If Hidden = 1 transparency (Invisible)
			child.Transparency = isVisible and 0 or 1
			child.CanCollide = isVisible -- Turn off collision so you don't walk into invisible walls
		end

		-- 2. Control the UI (The Text and Image)
		if child:IsA("SurfaceGui") or child:IsA("BillboardGui") then
			child.Enabled = isVisible
		end
	end
end

-- ---------------------------------------------------------
-- UPDATE FUNCTION
-- ---------------------------------------------------------
local function updateSignVisuals(plot, playerName)
	local signPart = plot:WaitForChild("SignPart", 10)
	if not signPart then return end 

	-- A. CHECK IF EMPTY (Player left or nobody claimed yet)
	if playerName == nil or playerName == "" then
		-- HIDE THE SIGN
		setSignVisibility(signPart, false)
		print("ðŸ‘» Plot Empty: Hid sign for " .. plot.Name)
		return
	end

	-- B. SHOW THE SIGN (Because we have a player!)
	setSignVisibility(signPart, true)

	print("ðŸŽ¨ Loading Sign for: " .. playerName)
	local player = Players:FindFirstChild(playerName)
	local userId = player and player.UserId or 1 

	-- === 1. UPDATE FACE ===
	local facePart = signPart:FindFirstChild("OwnerFace")
	if facePart then
		local sGui = facePart:WaitForChild("SurfaceGui", 5)
		if sGui then
			local img = sGui:FindFirstChild("OwnerFace") or sGui:FindFirstChildWhichIsA("ImageLabel")
			if img then
				img.BackgroundTransparency = 1
				img.Size = UDim2.new(1, 0, 1, 0)

				task.spawn(function()
					local content = "rbxthumb://type=AvatarBust&id=" .. userId .. "&w=420&h=420"
					img.Image = content
				end)
			end
		end
	end

	-- === 2. UPDATE NAME ===
	local namePart = signPart:FindFirstChild("OwnerName")
	if namePart then
		local sGui = namePart:WaitForChild("SurfaceGui", 5)
		if sGui then
			local txt = sGui:FindFirstChild("TextLabel") or sGui:FindFirstChildWhichIsA("TextLabel")
			if txt then
				txt.Text = playerName .. "'s Plot"
				txt.TextScaled = true
			end
		end
	end
end

-- ---------------------------------------------------------
-- SETUP LOOP
-- ---------------------------------------------------------
local function setupPlot(plot)
	local ownerValue = plot:WaitForChild("Owner", 10)

	if ownerValue then
		-- 1. Initial Check (Run immediately when game starts)
		updateSignVisuals(plot, ownerValue.Value)

		-- 2. Listen for changes (Claiming OR Leaving)
		ownerValue.Changed:Connect(function(newOwnerName)
			updateSignVisuals(plot, newOwnerName)
		end)
	end
end

-- Apply to all existing plots
for _, plot in ipairs(tycoonsFolder:GetChildren()) do
	task.spawn(function() setupPlot(plot) end)
end

-- Apply to any new plots
tycoonsFolder.ChildAdded:Connect(function(child)
	task.spawn(function() setupPlot(child) end)
end)
