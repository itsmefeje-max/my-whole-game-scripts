-- [[ LOCAL SCRIPT: WithdrawLogic (Synced + Max Button Feature) ]]
-- VERSION: Pulse Animation + RemoteFunction Sync + Logic Fixes + MAX BUTTON
-- LOCATION: Inside the "Withdraw" Button (Child of the Frame)

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local withdrawBtn = script.Parent
local mainWindow = withdrawBtn.Parent -- The Frame holding the buttons

-- üîÑ REMOTE FUNCTION
local withdrawFunc = ReplicatedStorage:WaitForChild("WithdrawFunction")

-- üìÇ UI REFERENCES
-- The script looks for these siblings inside 'mainWindow'
local amountInput = mainWindow:WaitForChild("AmountInput", 5)
local VerifyLabel = mainWindow:WaitForChild("VerifyLabel", 5) 
local SuccessLabel = mainWindow:WaitForChild("SuccessLabel", 5)
local ErrorLabel = mainWindow:WaitForChild("ErrorLabel", 5)

-- üÜï MAX BUTTON REFERENCE
-- MUST be a direct child of 'mainWindow' (Same folder as AmountInput)
local maxBtn = mainWindow:WaitForChild("MaxButton", 5) 

-- üîä SOUND CONFIG
local CASH_SOUND_ID = "rbxassetid://140072726814802"
local ERROR_SOUND_ID = "rbxassetid://3779045779"
local CLICK_SOUND_ID = "rbxassetid://9083627113" 

-- ‚öôÔ∏è STATE VARIABLES
local currentVerifyTween = nil 
local isCoolingDown = false 

-- ============================================================================
-- üõ†Ô∏è ANIMATION FUNCTIONS (Unchanged)
-- ============================================================================

local function playSound(soundId)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = 1
	sound.Parent = SoundService 
	sound:Play()
	game.Debris:AddItem(sound, 3)
end

local function animateResult(uiObject)
	if not uiObject then return end

	-- 1. FORCE VISIBLE
	uiObject.Visible = true
	uiObject.ZIndex = 20 

	if uiObject:IsA("ImageLabel") then uiObject.ImageTransparency = 0 end
	if uiObject:IsA("TextLabel") then uiObject.TextTransparency = 0 end

	-- 2. Wait
	task.wait(2)

	-- 3. Fade Out
	local goals = {}
	if uiObject:IsA("ImageLabel") then goals.ImageTransparency = 1 end
	if uiObject:IsA("TextLabel") then goals.TextTransparency = 1 end

	local tweenOut = TweenService:Create(uiObject, TweenInfo.new(0.5), goals)
	tweenOut:Play()
	tweenOut.Completed:Wait()

	uiObject.Visible = false
end

local function startVerifying()
	if not VerifyLabel then return end

	VerifyLabel.Visible = true
	VerifyLabel.ZIndex = 20
	VerifyLabel.Rotation = 0 

	if VerifyLabel:IsA("ImageLabel") then VerifyLabel.ImageTransparency = 1 end
	if VerifyLabel:IsA("TextLabel") then VerifyLabel.TextTransparency = 1 end

	local pulseInfo = TweenInfo.new(0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	local goals = {}
	if VerifyLabel:IsA("ImageLabel") then goals.ImageTransparency = 0 end
	if VerifyLabel:IsA("TextLabel") then goals.TextTransparency = 0 end

	currentVerifyTween = TweenService:Create(VerifyLabel, pulseInfo, goals)
	currentVerifyTween:Play()
end

local function stopVerifying()
	if currentVerifyTween then
		currentVerifyTween:Cancel()
		currentVerifyTween = nil
	end
	if VerifyLabel then
		VerifyLabel.Visible = false
		if VerifyLabel:IsA("ImageLabel") then VerifyLabel.ImageTransparency = 0 end
	end
end

-- ============================================================================
-- üÜï MAX BUTTON LOGIC (Added Feature)
-- ============================================================================
if maxBtn then
	maxBtn.MouseButton1Click:Connect(function()
		-- 1. Get Current "Cash" (Bank Balance)
		local currentBank = 0
		if player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Cash") then
			currentBank = player.leaderstats.Cash.Value
		end

		-- 2. Aesthetic Click
		playSound(CLICK_SOUND_ID)

		-- 3. Auto-Fill Input
		if currentBank > 0 then
			-- We use math.floor to ensure no decimals break the transfer
			amountInput.Text = tostring(math.floor(currentBank))
			print("‚úÖ Max Amount Set: " .. amountInput.Text)
		else
			amountInput.Text = "0"
		end
	end)
else
	warn("‚ö†Ô∏è 'MaxButton' not found in Transfer UI. Max feature disabled.")
end

-- ============================================================================
-- üü¢ MAIN TRANSFER BUTTON LOGIC
-- ============================================================================
withdrawBtn.MouseButton1Click:Connect(function()

	-- üõë 1. CHECK COOLDOWN
	if isCoolingDown then return end
	isCoolingDown = true 

	-- 2. DISABLE BUTTON VISUALLY
	withdrawBtn.Active = false
	withdrawBtn.AutoButtonColor = false

	-- 3. START VFX (The Pulse)
	startVerifying()

	-- 4. WAIT 2 SECONDS (Simulate "Thinking")
	task.wait(2)

	-- 5. PREPARE DATA
	local rawText = amountInput.Text
	local amount = tonumber(rawText)
	local leaderstats = player:FindFirstChild("leaderstats")
	local cashValue = leaderstats and leaderstats:FindFirstChild("Cash")
	local currentBank = cashValue and cashValue.Value or 0

	-- 6. CLIENT-SIDE CHECK (Fast Fail)
	if (not amount) or (amount <= 0) or (amount > currentBank) then
		stopVerifying()
		print("‚ùå Invalid Input or Insufficient Funds")
		playSound(ERROR_SOUND_ID)
		task.spawn(function() animateResult(ErrorLabel) end)

		-- Reset Button
		task.wait(1)
		isCoolingDown = false
		withdrawBtn.Active = true
		withdrawBtn.AutoButtonColor = true
		return
	end

	-- 7. üîí SERVER REQUEST (The Sync)
	local success, msg = withdrawFunc:InvokeServer(amount, "Withdraw")

	-- 8. STOP VFX (Now that server replied)
	stopVerifying()

	if success then
		-- üü¢ REAL SUCCESS (Server approved it)
		print("‚úÖ Transaction Approved")
		playSound(CASH_SOUND_ID)
		amountInput.Text = "" -- Clear the box
		task.spawn(function() animateResult(SuccessLabel) end)
	else
		-- üî¥ REAL FAILURE (Server denied it)
		print("‚ùå Transaction Denied: " .. msg)
		playSound(ERROR_SOUND_ID)
		task.spawn(function() animateResult(ErrorLabel) end)
	end

	-- 9. RESET
	task.wait(1)
	isCoolingDown = false
	withdrawBtn.Active = true
	withdrawBtn.AutoButtonColor = true
end)

-- Initialize
if VerifyLabel then VerifyLabel.Visible = false end
if SuccessLabel then SuccessLabel.Visible = false end
if ErrorLabel then ErrorLabel.Visible = false end
