-- [[ SERVER SCRIPT: BaseUpgradeTransactionHandler ]]
-- Purpose: Verification for Buying AND Equipping/Unequipping Skins.
-- Location: ServerScriptService

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")
local TransactionFunc = Remotes:WaitForChild("BaseUpgradeTransaction")
local StatsModule = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ðŸ’° UNIFIED TRANSACTION & EQUIP FUNCTION
TransactionFunc.OnServerInvoke = function(player, skinName, actionType)
	local skinData = StatsModule[skinName]

	-- 1. READ OWNERSHIP
	local ownedRaw = player:GetAttribute("OwnedBaseSkins") or "[]"
	local ownedTable = {}
	pcall(function() ownedTable = HttpService:JSONDecode(ownedRaw) end)
	local ownsSkin = table.find(ownedTable, skinName)

	-- ========================================================================
	-- ðŸ› ï¸ EQUIP / UNEQUIP LOGIC (NEW)
	-- ========================================================================
	if actionType == "Equip" then
		if ownsSkin then
			player:SetAttribute("EquippedSkin", skinName)
			print("âœ… " .. player.Name .. " equipped " .. skinName)
			return true, "Equipped"
		else
			return false, "You do not own this!"
		end

	elseif actionType == "Unequip" then
		player:SetAttribute("EquippedSkin", "Default")
		print("ðŸš« " .. player.Name .. " unequipped " .. skinName)
		return true, "Unequipped"

		-- ========================================================================
		-- ðŸ’° BUYING LOGIC (EXISTING)
		-- ========================================================================
	elseif actionType == "Cash" then
		if not skinData then return false, "Invalid Skin" end
		if ownsSkin then return false, "Already Owned" end

		local leaderstats = player:FindFirstChild("leaderstats")
		local wallet = leaderstats and leaderstats:FindFirstChild("Wallet") 

		if wallet and wallet.Value >= skinData.PriceCash then
			-- A. Deduct Money
			wallet.Value = wallet.Value - skinData.PriceCash

			-- B. Grant Ownership
			table.insert(ownedTable, skinName)

			-- C. Update Attributes (Client sees this instantly)
			player:SetAttribute("OwnedBaseSkins", HttpService:JSONEncode(ownedTable))
			player:SetAttribute("EquippedSkin", skinName) -- Auto-Equip on buy

			print("âœ… " .. player.Name .. " bought " .. skinName .. " with Wallet Cash")
			return true, "Success"
		else
			return false, "Insufficient Wallet Cash"
		end

	elseif actionType == "Robux" then
		if not skinData then return false, "Invalid Skin" end
		if ownsSkin then return false, "Already Owned" end

		if skinData.ProductId > 0 then
			MarketplaceService:PromptProductPurchase(player, skinData.ProductId)
			return true, "Prompted"
		else
			return false, "No Product ID Configured"
		end
	end

	return false, "Invalid Action"
end
