-- [[ SERVER SCRIPT: BaseUpgradeTransactionHandler ]]
-- Purpose: Verification for Base Upgrades (Wallet Check & Robux Prompt)
-- Location: ServerScriptService

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")
local TransactionFunc = Remotes:WaitForChild("BaseUpgradeTransaction")
local StatsModule = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ðŸ’° UNIFIED BUY FUNCTION
TransactionFunc.OnServerInvoke = function(player, skinName, currencyType)
	local skinData = StatsModule[skinName]
	if not skinData then return false, "Invalid Skin" end

	-- 1. CHECK OWNERSHIP FIRST
	-- We read the attribute we created in TycoonDataHandler
	local ownedRaw = player:GetAttribute("OwnedBaseSkins") or "[]"
	local ownedTable = {}

	-- Safe Decode
	pcall(function()
		ownedTable = HttpService:JSONDecode(ownedRaw)
	end)

	if table.find(ownedTable, skinName) then
		return false, "Already Owned"
	end

	-- 2. HANDLE CASH (WALLET CHECK)
	if currencyType == "Cash" then
		local leaderstats = player:FindFirstChild("leaderstats")

		-- âœ… BUG FIX: Checking 'Wallet' (Hand) instead of 'Cash' (Bank)
		local wallet = leaderstats and leaderstats:FindFirstChild("Wallet") 

		if wallet and wallet.Value >= skinData.PriceCash then
			-- A. Deduct Money
			wallet.Value = wallet.Value - skinData.PriceCash

			-- B. Grant Ownership
			table.insert(ownedTable, skinName)

			-- C. Update Attributes (Client sees this instantly)
			player:SetAttribute("OwnedBaseSkins", HttpService:JSONEncode(ownedTable))
			player:SetAttribute("EquippedSkin", skinName)

			print("âœ… " .. player.Name .. " bought " .. skinName .. " with Wallet Cash")
			return true, "Success"
		else
			return false, "Insufficient Wallet Cash"
		end

		-- 3. HANDLE ROBUX (Trigger Prompt ONLY)
	elseif currencyType == "Robux" then
		if skinData.ProductId > 0 then
			-- We only prompt here. The success is handled by 'ReceiptRouter'.
			MarketplaceService:PromptProductPurchase(player, skinData.ProductId)
			return true, "Prompted" -- Client waits for prompt
		else
			return false, "No Product ID Configured"
		end
	end

	return false, "Invalid Currency"
end
