-- Purpose: Animates held tools (cars) with a floating effect without causing server lag.
-- Runs on: Client
-- Location: StarterPlayerScripts
-- Dependencies: RunService, Players
-- Public API: None
-- Networking: None (Purely local visual effect)
-- Security: Client-sided visuals only; cannot be exploited to move hitboxes server-side.
-- Performance: Modifies Weld C0 directly instead of rebuilding joints. Zero server network footprint.
-- Notes: Assumes the tool is held in the "Right Arm" (R6) or "RightHand" (R15).

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer

-- ‚öôÔ∏è CONFIGURATION
local FLOAT_HEIGHT = 3    -- Base height above hand
local BOB_SPEED = 2       -- How fast it goes up/down
local BOB_HEIGHT = 0.5    -- How far it travels

-- üõ°Ô∏è STATE
local currentTool = nil
local rightGripWeld = nil
local originalC0 = nil
local animConnection = nil

local function stopAnimation()
	if animConnection then
		animConnection:Disconnect()
		animConnection = nil
	end

	-- Restore the original grip offset safely if the weld still exists
	if rightGripWeld and rightGripWeld.Parent and originalC0 then
		rightGripWeld.C0 = originalC0
	end

	currentTool = nil
	rightGripWeld = nil
	originalC0 = nil
end

local function animateTool(character, tool)
	stopAnimation()

	-- Wait for the character's arm
	local arm = character:FindFirstChild("Right Arm") or character:FindFirstChild("RightHand")
	if not arm then return end

	-- Roblox automatically creates a "RightGrip" weld when a tool is equipped.
	-- We wait briefly for it to appear in the arm.
	rightGripWeld = arm:WaitForChild("RightGrip", 2)
	if not rightGripWeld or not rightGripWeld:IsA("Weld") then return end

	currentTool = tool
	originalC0 = rightGripWeld.C0

	animConnection = RunService.RenderStepped:Connect(function()
		-- Failsafe: if tool drops or weld is destroyed, stop animating
		if tool.Parent ~= character or not rightGripWeld.Parent then
			stopAnimation()
			return
		end

		local t = time()
		local bob = math.sin(t * BOB_SPEED) * BOB_HEIGHT

		-- Modifying C0 is instantly rendered and does NOT rebuild the joint.
		-- This stops the physics/network lag entirely.
		rightGripWeld.C0 = originalC0 * CFrame.new(0, FLOAT_HEIGHT + bob, 0)
	end)
end

local function onCharacterAdded(character)
	character.ChildAdded:Connect(function(child)
		if child:IsA("Tool") then
			-- Defer execution to ensure Roblox's backend has finished creating the RightGrip
			task.defer(function()
				if child.Parent == character then
					animateTool(character, child)
				end
			end)
		end
	end)

	character.ChildRemoved:Connect(function(child)
		if child == currentTool then 
			stopAnimation() 
		end
	end)
end

if player.Character then onCharacterAdded(player.Character) end
player.CharacterAdded:Connect(onCharacterAdded)
