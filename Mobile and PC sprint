-- [[ LOCAL SCRIPT: Universal Movement (Sprint + Walk) ]]
-- -- Indicating what the script is for: Handles Mobile Button, PC Shift, and Custom Walk/Run Animations.
-- UPDATED: Now supports YOUR custom Walk Animation ID + Sprint Animation.

local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local button = script.Parent -- The ImageButton

-- === ‚öôÔ∏è CONFIGURATION ===
local WALK_SPEED = 30      -- Normal Speed
local SPRINT_SPEED = 50    -- Sprint Speed

-- üé• ANIMATION IDS
local WALK_ANIM_ID = "rbxassetid://89191212294315"  -- ‚úÖ YOUR NEW WALK ID
local SPRINT_ANIM_ID = "rbxassetid://103489308479400" -- Previous Sprint ID (Change if needed)

-- === STATE ===
local isSprinting = false
local walkTrack = nil
local runTrack = nil

-- 1. VISIBILITY SETUP (Mobile Check)
if UserInputService.TouchEnabled then
	button.Visible = true
else
	button.Visible = false 
end

-- üõ†Ô∏è ANIMATION HANDLER (The Brain)
local function updateAnimation(humanoid)
	-- If not moving, stop everything (Let default Idle play)
	if humanoid.MoveDirection.Magnitude == 0 then
		if walkTrack and walkTrack.IsPlaying then walkTrack:Stop() end
		if runTrack and runTrack.IsPlaying then runTrack:Stop() end
		return
	end

	-- If Moving...
	if isSprinting then
		-- PLAY SPRINT, STOP WALK
		if runTrack and not runTrack.IsPlaying then runTrack:Play() end
		if walkTrack and walkTrack.IsPlaying then walkTrack:Stop() end
	else
		-- PLAY WALK, STOP SPRINT
		if walkTrack and not walkTrack.IsPlaying then walkTrack:Play() end
		if runTrack and runTrack.IsPlaying then runTrack:Stop() end
	end
end

-- üõ†Ô∏è SPEED HANDLER
local function updateSpeed()
	local character = player.Character
	if character then
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			-- üõë SAFETY CHECK: If holding a tool, NEVER sprint
			if character:FindFirstChildWhichIsA("Tool") then
				isSprinting = false
				humanoid.WalkSpeed = WALK_SPEED 
				
				-- Stop sprint animation immediately
				if runTrack and runTrack.IsPlaying then runTrack:Stop() end
				-- Let walk animation take over if moving
				updateAnimation(humanoid)
				
				-- Update Visuals
				button.ImageTransparency = 0
				if UserInputService.TouchEnabled then button.Visible = false end
				return
			end

			-- Apply Speed
			humanoid.WalkSpeed = isSprinting and SPRINT_SPEED or WALK_SPEED
			
			-- Update Visuals
			button.ImageTransparency = isSprinting and 0.5 or 0
			
			-- Update Animation
			updateAnimation(humanoid)
		end
	end
end

-- üõ°Ô∏è CHARACTER SETUP
local function setupCharacter(character)
	local humanoid = character:WaitForChild("Humanoid", 10)
	if not humanoid then return end
	
	local animator = humanoid:WaitForChild("Animator", 10)
	if not animator then return end

	-- 1. LOAD WALK ANIMATION
	local walkAnim = Instance.new("Animation")
	walkAnim.AnimationId = WALK_ANIM_ID
	walkTrack = animator:LoadAnimation(walkAnim)
	walkTrack.Priority = Enum.AnimationPriority.Movement -- Overrides default walk
	walkTrack.Looped = true

	-- 2. LOAD SPRINT ANIMATION
	local runAnim = Instance.new("Animation")
	runAnim.AnimationId = SPRINT_ANIM_ID
	runTrack = animator:LoadAnimation(runAnim)
	runTrack.Priority = Enum.AnimationPriority.Action -- Higher priority than walk
	runTrack.Looped = true

	-- 3. TOOL MONITORING
	local function checkTools()
		if character:FindFirstChildWhichIsA("Tool") then
			-- ‚úã PLAYER IS HOLDING A ITEM -> DISABLE SPRINT
			isSprinting = false
			updateSpeed()
		else
			-- ‚úÖ HANDS ARE EMPTY -> SHOW BUTTON (Mobile)
			if UserInputService.TouchEnabled then
				button.Visible = true
			end
		end
	end

	character.ChildAdded:Connect(checkTools)
	character.ChildRemoved:Connect(checkTools)
	
	-- 4. MOVEMENT MONITORING
	humanoid:GetPropertyChangedSignal("MoveDirection"):Connect(function()
		updateAnimation(humanoid)
	end)

	checkTools()
end

-- ============================================================================
-- üíª PC LOGIC (Tap Shift to Toggle)
-- ============================================================================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end 

	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	if input.KeyCode == Enum.KeyCode.LeftShift then
		isSprinting = not isSprinting
		updateSpeed()
	end
end)

-- ============================================================================
-- üì± MOBILE LOGIC (Tap Button to Toggle)
-- ============================================================================
button.MouseButton1Click:Connect(function()
	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	isSprinting = not isSprinting
	updateSpeed()
end)

-- üõ°Ô∏è RESET ON RESPAWN
player.CharacterAdded:Connect(function(char)
	isSprinting = false
	walkTrack = nil
	runTrack = nil
	
	if UserInputService.TouchEnabled then
		button.Visible = true
	else
		button.Visible = false
	end
	
	setupCharacter(char)
end)

-- Initial Setup
if player.Character then setupCharacter(player.Character) end
