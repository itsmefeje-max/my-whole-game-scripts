-- [[ LOCAL SCRIPT: Universal Sprint (Initialization Fix) ]]
-- -- Indicating what the script is for: Handles Mobile Button + PC Shift + Custom Running Animation.
-- -- UPDATE: Fixed bug where WalkSpeed (30) wasn't applying immediately on spawn.

local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local button = script.Parent -- The ImageButton

-- === CONFIGURATION ===
local WALK_SPEED = 30       -- Normal Speed
local SPRINT_SPEED = 50     -- Sprint Speed
local ANIMATION_ID = "rbxassetid://103489308479400" -- Your Animation ID

-- === STATE ===
local isSprinting = false
local runTrack = nil -- Stores the loaded animation track

-- 1. VISIBILITY SETUP (Mobile Check)
if UserInputService.TouchEnabled then
	button.Visible = true
else
	button.Visible = false 
end

-- üõ†Ô∏è ANIMATION HANDLER
local function updateAnimation(humanoid)
	if not runTrack then return end

	-- Check if moving AND sprinting
	if isSprinting and humanoid.MoveDirection.Magnitude > 0 then
		if not runTrack.IsPlaying then
			runTrack:Play()
		end
	else
		if runTrack.IsPlaying then
			runTrack:Stop()
		end
	end
end

-- üõ†Ô∏è SPEED HANDLER
local function updateSpeed()
	local character = player.Character
	if character then
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			-- üõë SAFETY CHECK: If holding a tool, NEVER sprint
			if character:FindFirstChildWhichIsA("Tool") then
				isSprinting = false
				humanoid.WalkSpeed = WALK_SPEED 

				-- Stop animation since we forced walk
				if runTrack and runTrack.IsPlaying then runTrack:Stop() end

				-- Update Visuals
				button.ImageTransparency = 0
				if UserInputService.TouchEnabled then button.Visible = false end
				return
			end

			-- Apply Speed
			humanoid.WalkSpeed = isSprinting and SPRINT_SPEED or WALK_SPEED

			-- Update Visuals
			button.ImageTransparency = isSprinting and 0.5 or 0

			-- Update Animation
			updateAnimation(humanoid)
		end
	end
end

-- üõ°Ô∏è CHARACTER SETUP
local function setupCharacter(character)
	local humanoid = character:WaitForChild("Humanoid", 10)
	if not humanoid then return end

	local animator = humanoid:WaitForChild("Animator", 10)
	if not animator then return end

	-- 1. LOAD ANIMATION
	local newAnim = Instance.new("Animation")
	newAnim.AnimationId = ANIMATION_ID
	runTrack = animator:LoadAnimation(newAnim)
	runTrack.Priority = Enum.AnimationPriority.Action
	runTrack.Looped = true

	-- 2. TOOL MONITORING
	local function checkTools()
		if character:FindFirstChildWhichIsA("Tool") then
			-- ‚úã PLAYER IS HOLDING A ITEM -> DISABLE SPRINT
			isSprinting = false
			updateSpeed()
		else
			-- ‚úÖ HANDS ARE EMPTY -> SHOW BUTTON (Mobile)
			if UserInputService.TouchEnabled then
				button.Visible = true
			end
			-- Re-apply speed in case we just dropped a tool
			updateSpeed()
		end
	end

	character.ChildAdded:Connect(checkTools)
	character.ChildRemoved:Connect(checkTools)

	-- 3. MOVEMENT MONITORING
	humanoid:GetPropertyChangedSignal("MoveDirection"):Connect(function()
		updateAnimation(humanoid)
	end)

	-- 4. INITIALIZATION (The Fix)
	checkTools()   -- Checks if we have tools
	updateSpeed()  -- üî• FORCES the WalkSpeed to 30 immediately!
end

-- ============================================================================
-- üíª PC LOGIC (Tap Shift to Toggle)
-- ============================================================================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end 

	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	if input.KeyCode == Enum.KeyCode.LeftShift then
		isSprinting = not isSprinting
		updateSpeed()
	end
end)

-- ============================================================================
-- üì± MOBILE LOGIC (Tap Button to Toggle)
-- ============================================================================
button.MouseButton1Click:Connect(function()
	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	isSprinting = not isSprinting
	updateSpeed()
end)

-- üõ°Ô∏è RESET ON RESPAWN
player.CharacterAdded:Connect(function(char)
	isSprinting = false
	runTrack = nil -- Reset track

	if UserInputService.TouchEnabled then
		button.Visible = true
	else
		button.Visible = false
	end

	setupCharacter(char)
end)

-- Initial Setup
if player.Character then setupCharacter(player.Character) end
