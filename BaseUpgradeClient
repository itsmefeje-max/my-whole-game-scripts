-- Purpose: Shop UI, Feedback, Sounds, EQUIP/UNEQUIP, and GIFTING connection.
-- Runs on: Client
-- Location: StarterPlayerScripts
-- Dependencies: ReplicatedStorage, TweenService, MarketplaceService, HttpService
-- Public API: None (Listens to ShopRemotes)
-- Networking: BaseUpgradeTransaction (Client -> Server)
-- Security: UI visual logic. Validations happen on the server.
-- Performance: Preloads sounds, caches UI states.
-- Notes: Contains aggressive debugging for the GiftButton click failure.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local SoundService = game:GetService("SoundService") 
local ContentProvider = game:GetService("ContentProvider") 

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")

-- üì° NETWORKING
local OpenEvent = Remotes:WaitForChild("OpenBaseUpgrade")
local TransactionFunc = Remotes:WaitForChild("BaseUpgradeTransaction")

-- üì¶ REQUIRE KIT
local Kit
pcall(function()
	Kit = require(ReplicatedStorage:WaitForChild("ShopFrontendKit", 5))
end)
local BaseSkinStats = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ‚öôÔ∏è CONFIGURATION
local UI_NAME = "BaseUpgradeUI"
local FRAME_NAME = "MainFrame"
local SCROLLER_NAME = "UpgradeScroller" 
local CLOSE_BTN_NAME = "CloseButton"
local FEEDBACK_LBL_NAME = "Indicator-purchase"
local BLUR_SIZE = 24 

-- üéµ SOUND PRE-LOADING
local Sounds = {}
local SFX_IDs = {
	Success = "rbxassetid://2619623062", 
	Fail = "rbxassetid://1526487928",
	Equip = "rbxassetid://6895079853" 
}

for name, id in pairs(SFX_IDs) do
	local s = Instance.new("Sound")
	s.Name = name
	s.SoundId = id
	s.Volume = 2
	s.Parent = SoundService
	Sounds[name] = s
end

-- üõ°Ô∏è STATE TRACKING
local hiddenGuis = {} 
local hiddenObjects = {} 
local currentBlur = nil 
local feedbackDebounce = false 

-- ============================================================================
-- üîä SOUND ENGINE
-- ============================================================================
local function PlaySound(name)
	local s = Sounds[name]
	if s then s:Play() end
end

-- ============================================================================
-- üé® FEEDBACK SYSTEM
-- ============================================================================
local function ShowFeedback(message, isSuccess)
	local gui = PlayerGui:FindFirstChild(UI_NAME)
	if not gui then return end
	local frame = gui:FindFirstChild(FRAME_NAME)
	if not frame then return end

	local feedbackLbl = frame:FindFirstChild(FEEDBACK_LBL_NAME, true) -- Recursive search
	if not feedbackLbl then return end 

	if isSuccess then
		feedbackLbl.TextColor3 = Color3.fromRGB(85, 255, 127) 
		PlaySound("Success") 
	else
		feedbackLbl.TextColor3 = Color3.fromRGB(255, 85, 85) 
		PlaySound("Fail")    
	end

	feedbackDebounce = true
	feedbackLbl.Text = message
	feedbackLbl.TextTransparency = 1
	feedbackLbl.Visible = true
	feedbackLbl.ZIndex = 10

	local fadeIn = TweenService:Create(feedbackLbl, TweenInfo.new(0.3), {TextTransparency = 0})
	fadeIn:Play()
	fadeIn.Completed:Wait()

	task.wait(1.5)

	local fadeOut = TweenService:Create(feedbackLbl, TweenInfo.new(0.5), {TextTransparency = 1})
	fadeOut:Play()
	fadeOut.Completed:Connect(function()
		feedbackLbl.Visible = false
		feedbackDebounce = false
	end)
end

-- ============================================================================
-- üíé ROBUX PURCHASE LISTENER
-- ============================================================================
MarketplaceService.PromptProductPurchaseFinished:Connect(function(userId, productId, isPurchased)
	if userId ~= player.UserId then return end

	local isBaseSkin = false
	for _, skinData in pairs(BaseSkinStats) do
		if skinData.ProductId == productId then
			isBaseSkin = true
			break
		end
	end

	if isBaseSkin then
		if isPurchased then
			ShowFeedback("Purchase Successful!", true)
		else
			ShowFeedback("Purchase Cancelled", false)
		end
	end
end)

-- ============================================================================
-- üõ†Ô∏è HELPER FUNCTIONS
-- ============================================================================
local function setBlur(enable)
	if enable then
		if not currentBlur then
			currentBlur = Instance.new("BlurEffect")
			currentBlur.Size = 0
			currentBlur.Parent = Lighting
			currentBlur.Name = "UpgradeBlur"
		end
		TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = BLUR_SIZE}):Play()
	else
		if currentBlur then
			local t = TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = 0})
			t:Play()
			t.Completed:Connect(function()
				if currentBlur then currentBlur:Destroy() currentBlur = nil end
			end)
		end
	end
end

local function toggleNamedGuiObjects(shouldHide, objectName)
	if shouldHide then
		for _, obj in pairs(PlayerGui:GetDescendants()) do
			if obj:IsA("GuiObject") and obj.Name == objectName and obj.Visible then
				obj.Visible = false
				table.insert(hiddenObjects, obj)
			end
		end
	else
		for _, obj in pairs(hiddenObjects) do
			if obj and obj.Parent and obj:IsA("GuiObject") then
				obj.Visible = true
			end
		end
		hiddenObjects = {}
	end
end

local function toggleOtherGuis(shouldHide)
	local myGui = PlayerGui:FindFirstChild(UI_NAME)
	if shouldHide then
		hiddenGuis = {}
		for _, otherGui in pairs(PlayerGui:GetChildren()) do
			if otherGui:IsA("ScreenGui") 
				and otherGui ~= myGui 
				and otherGui.Enabled == true 
				and otherGui.Name ~= "Balance Indicator"
				and otherGui.Name ~= "TouchGui"
				and otherGui.Name ~= "Chat"
			then
				otherGui.Enabled = false
				table.insert(hiddenGuis, otherGui)
			end
		end
	else
		for _, otherGui in pairs(hiddenGuis) do
			if otherGui and otherGui.Parent then
				otherGui.Enabled = true
			end
		end
		hiddenGuis = {}
	end
end

local function setMovement(active)
	local char = player.Character
	if char and char:FindFirstChild("Humanoid") then
		if not active then
			char.Humanoid.WalkSpeed = 0
			char.Humanoid.JumpPower = 0
		else
			char.Humanoid.WalkSpeed = 16
			char.Humanoid.JumpPower = 50
		end
	end
end

-- ============================================================================
-- üõçÔ∏è CARD LOGIC (BUY / EQUIP / UNEQUIP / GIFT)
-- ============================================================================

local function resolveGuiButton(target)
	if not target then return nil end
	if target:IsA("GuiButton") then return target end
	for _, descendant in ipairs(target:GetDescendants()) do
		if descendant:IsA("GuiButton") then
			return descendant
		end
	end
	return nil
end

local function UpdateCardVisuals(cardFrame, skinName)
	local buyFrame = cardFrame:FindFirstChild("BuyFrame", true)
	if not buyFrame then return end

	-- üõ°Ô∏è RECURSIVE SEARCH: Fixes issues where buttons are inside sub-frames
	local btnCash = buyFrame:FindFirstChild("BuyForCash", true)
	local btnRobux = buyFrame:FindFirstChild("BuyForRobux", true)
	local obtainedIndicator = buyFrame:FindFirstChild("ObtainedIndicator", true)

	local btnEquip = buyFrame:FindFirstChild("Equip", true)
	local btnUnequip = buyFrame:FindFirstChild("Unequip", true)

	local ownedRaw = player:GetAttribute("OwnedBaseSkins") or "[]"
	local ownedTable = {}
	pcall(function() ownedTable = HttpService:JSONDecode(ownedRaw) end)

	local isOwned = table.find(ownedTable, skinName)
	local currentEquip = player:GetAttribute("EquippedSkin")

	if isOwned then
		if btnCash then btnCash.Visible = false end
		if btnRobux then btnRobux.Visible = false end
		if obtainedIndicator then obtainedIndicator.Visible = false end 

		if currentEquip == skinName then
			if btnEquip then btnEquip.Visible = false end
			if btnUnequip then btnUnequip.Visible = true end
		else
			if btnEquip then btnEquip.Visible = true end
			if btnUnequip then btnUnequip.Visible = false end
		end
	else
		if btnCash then btnCash.Visible = true end
		if btnRobux then btnRobux.Visible = true end
		if btnEquip then btnEquip.Visible = false end
		if btnUnequip then btnUnequip.Visible = false end
		if obtainedIndicator then obtainedIndicator.Visible = false end
	end
end

local function ConnectCard(cardFrame, skinName)
	UpdateCardVisuals(cardFrame, skinName)

	player:GetAttributeChangedSignal("OwnedBaseSkins"):Connect(function()
		UpdateCardVisuals(cardFrame, skinName)
	end)
	player:GetAttributeChangedSignal("EquippedSkin"):Connect(function()
		UpdateCardVisuals(cardFrame, skinName)
	end)

	local buyFrame = cardFrame:FindFirstChild("BuyFrame", true)
	if not buyFrame then 
		warn("‚ùå CRITICAL: BuyFrame not found inside " .. cardFrame.Name)
		return 
	end

	-- üõ°Ô∏è RECURSIVE SEARCH FOR ALL BUTTONS
	local btnCash = resolveGuiButton(buyFrame:FindFirstChild("BuyForCash", true))
	local btnRobux = resolveGuiButton(buyFrame:FindFirstChild("BuyForRobux", true))
	local btnEquip = resolveGuiButton(buyFrame:FindFirstChild("Equip", true))
	local btnUnequip = resolveGuiButton(buyFrame:FindFirstChild("Unequip", true))
	local giftNode = buyFrame:FindFirstChild("GiftButton", true)
	local btnGift = resolveGuiButton(giftNode)

	-- 1. BUY CASH
	if btnCash then
		local function onBuyCash()
			if feedbackDebounce then return end 
			local success, msg = TransactionFunc:InvokeServer(skinName, "Cash")
			if success then ShowFeedback("Purchase Successful!", true)
			else ShowFeedback(msg or "Purchase Failed", false) end
		end

		if Kit and Kit.Tween then Kit.Tween:SetupButton(btnCash, onBuyCash)
		else btnCash.MouseButton1Click:Connect(onBuyCash) end
	end

	-- 2. BUY ROBUX
	if btnRobux then
		local function onBuyRobux()
			TransactionFunc:InvokeServer(skinName, "Robux") 
		end

		if Kit and Kit.Tween then Kit.Tween:SetupButton(btnRobux, onBuyRobux)
		else btnRobux.MouseButton1Click:Connect(onBuyRobux) end
	end

	-- 3. EQUIP BUTTON
	if btnEquip then
		local function onEquip()
			TransactionFunc:InvokeServer(skinName, "Equip")
			PlaySound("Equip")
		end

		if Kit and Kit.Tween then Kit.Tween:SetupButton(btnEquip, onEquip)
		else btnEquip.MouseButton1Click:Connect(onEquip) end
	end

	-- 4. UNEQUIP BUTTON
	if btnUnequip then
		local function onUnequip()
			TransactionFunc:InvokeServer(skinName, "Unequip")
			PlaySound("Equip")
		end

		if Kit and Kit.Tween then Kit.Tween:SetupButton(btnUnequip, onUnequip)
		else btnUnequip.MouseButton1Click:Connect(onUnequip) end
	end

	-- 5. üéÅ GIFT BUTTON (WITH AGGRESSIVE DEBUGGING)
	if btnGift then
		print("‚úÖ Found GiftButton for " .. skinName .. "! Class type: " .. btnGift.ClassName)
		
		btnGift.Activated:Connect(function()
			print("üñ±Ô∏è CLICK REGISTERED ON: " .. skinName .. " Gift Button!")
			
			local skinData = BaseSkinStats[skinName]

			if skinData and skinData.ProductId then
				print("üì¶ Product ID found: " .. tostring(skinData.ProductId))
				
				if not _G.OpenGiftMenu then
					warn("‚ö†Ô∏è Gift Controller hasn't loaded yet. Retrying...")
					local attempts = 0
					while not _G.OpenGiftMenu and attempts < 10 do
						task.wait(0.2)
						attempts += 1
					end
				end

				if _G.OpenGiftMenu then
					print("üöÄ Launching _G.OpenGiftMenu!")
					_G.OpenGiftMenu(skinData.ProductId)
				else
					warn("‚ùå CRITICAL: Gift Menu function (_G.OpenGiftMenu) is missing.")
				end
			else
				warn("‚ùå No Product ID found for " .. skinName)
			end
		end)
	else
		local nodeClass = giftNode and giftNode.ClassName or "nil"
		warn("‚ùå btnGift NOT FOUND for " .. skinName .. " (GiftButton node class: " .. nodeClass .. ")")
	end
end

local function SetupShop()
	local gui = PlayerGui:WaitForChild(UI_NAME, 5)
	if not gui then return end
	local scroller = gui:FindFirstChild(SCROLLER_NAME, true) 
	if not scroller then return end 

	local cardSilver = scroller:FindFirstChild("Card0.1", true)
	if cardSilver then ConnectCard(cardSilver, "Silver") else warn("‚ö†Ô∏è Card0.1 (Silver) not found") end

	local card1 = scroller:FindFirstChild("Card1", true)
	if card1 then ConnectCard(card1, "Gold") else warn("‚ö†Ô∏è Card1 (Gold) not found") end

	local card2 = scroller:FindFirstChild("Card2", true)
	if card2 then ConnectCard(card2, "Diamond") else warn("‚ö†Ô∏è Card2 (Diamond) not found") end

	local card3 = scroller:FindFirstChild("Card3", true)
	if card3 then ConnectCard(card3, "Rainbow") else warn("‚ö†Ô∏è Card3 (Rainbow) not found") end
end

-- ============================================================================
-- üîÑ VISIBILITY & INIT
-- ============================================================================
local function setVisible(isOpen)
	local gui = PlayerGui:WaitForChild(UI_NAME, 5)
	if not gui then return end
	local frame = gui:FindFirstChild(FRAME_NAME, true)
	if not frame then return end

	if isOpen then
		toggleOtherGuis(true)
		toggleNamedGuiObjects(true, "FriendBoost") 
		setBlur(true)                              
		setMovement(false)                         
		SetupShop()
		gui.Enabled = true
		frame.Visible = true
		if Kit and Kit.Sound then Kit.Sound:Play("Open") end
	else
		gui.Enabled = false
		frame.Visible = false
		setBlur(false)
		toggleOtherGuis(false)
		toggleNamedGuiObjects(false, "FriendBoost")
		setMovement(true) 
	end
end

OpenEvent.OnClientEvent:Connect(function() setVisible(true) end)

task.spawn(function()
	local gui = PlayerGui:WaitForChild(UI_NAME, 10)
	if not gui then return end
	gui.Enabled = false 
	local frame = gui:WaitForChild(FRAME_NAME, 10)
	if frame then frame.Visible = false end

	local closeBtn = gui:FindFirstChild(CLOSE_BTN_NAME, true)
	if not closeBtn then return end

	if Kit and Kit.Tween and Kit.Tween.SetupButton then
		Kit.Tween:SetupButton(closeBtn, function() setVisible(false) end)
	else
		closeBtn.MouseButton1Click:Connect(function() setVisible(false) end)
	end
	SetupShop()
end)
