-- Purpose: Settings UI + Music Toggle + Center Pop Open / Instant Close
-- Runs on: Client
-- Location: StarterGui/SettingsGui
-- Dependencies: SoundService, TweenService, Debris, UserInputService
-- Public API: None (Internal Logic)
-- Networking: None (Client-side UI logic only)
-- Security: Client-side visuals only; no server validation needed.
-- Performance: Tweens used for open animation only.
-- Notes: Close animation removed per request. Open animation retained. Initial music state synced on startup.

local Players = game:GetService("Players")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ðŸ› ï¸ REFERENCES
local screenGui = script.Parent
local openButton = screenGui:WaitForChild("OpenButton")
local window = screenGui:WaitForChild("SettingsWindow")
local closeButton = window:WaitForChild("CloseButton")

-- ðŸŽµ MUSIC BUTTONS
local btnMusicOn = window:WaitForChild("MusicOnButton")
local btnMusicOff = window:WaitForChild("MusicOffButton")

-- ðŸ”Š MUSIC TARGET
local gameTheme = SoundService:WaitForChild("GameTheme", 5)

-- âš™ï¸ CONFIG
local CONFIG = {
	Colors = {
		Hover = Color3.fromRGB(210, 210, 210),
		Normal = Color3.fromRGB(255, 255, 255)
	},
	Sounds = {
		Open  = "rbxassetid://9083627113",
		Click = "rbxassetid://9083627113",
	},
	DefaultVolume = 0.5,

	-- Animation Settings
	Anim = {
		OpenTime = 1.0,   -- [KEPT] 1 Second fade in
		StartScale = 0.0, -- Starts at 0 size
		EasingStyle = Enum.EasingStyle.Exponential,
	},
}

-- ðŸ”Š SFX HELPER
local function playUiSound(name)
	local id = CONFIG.Sounds[name]
	if not id then return end

	local s = Instance.new("Sound")
	s.SoundId = id
	s.Volume = 0.5
	s.Parent = SoundService
	s:Play()
	Debris:AddItem(s, 2)
end

-- âœ… ENSURE UISCALE EXISTS
local uiScale = window:FindFirstChildOfClass("UIScale")
if not uiScale then
	uiScale = Instance.new("UIScale")
	uiScale.Parent = window
end

-- âœ… FORCE CENTER ANCHORING
window.AnchorPoint = Vector2.new(0.5, 0.5)
window.Position = UDim2.new(0.5, 0, 0.5, 0)

-- ðŸŸ¢ HIDE/RESTORE OTHER GUIS
local function setOtherGuisEnabled(enabled)
	for _, gui in ipairs(playerGui:GetChildren()) do
		if gui:IsA("ScreenGui") and gui ~= screenGui and gui.Name ~= "TouchGui" then
			if enabled == false then
				if gui:GetAttribute("WasEnabled") == nil then
					gui:SetAttribute("WasEnabled", gui.Enabled)
				end
				gui.Enabled = false
			else
				local was = gui:GetAttribute("WasEnabled")
				if was ~= nil then
					gui.Enabled = was
					gui:SetAttribute("WasEnabled", nil)
				end
			end
		end
	end
end

-- ðŸŸ¢ WINDOW VISIBILITY (Centered Pop Open / Instant Close)
local currentTween = nil

local function setWindowVisible(isOpen)
	-- Cancel any running animation immediately
	if currentTween then 
		currentTween:Cancel() 
		currentTween = nil
	end

	local A = CONFIG.Anim

	if isOpen then
		-- >> OPENING LOGIC (ANIMATED) <<

		-- 1. Setup Initial State
		window.Visible = true
		openButton.Visible = false
		uiScale.Scale = A.StartScale -- Reset to 0 so it can pop up
		playUiSound("Open")
		setOtherGuisEnabled(false)

		-- 2. Animate Scale to 1
		local info = TweenInfo.new(A.OpenTime, A.EasingStyle, Enum.EasingDirection.Out)
		currentTween = TweenService:Create(uiScale, info, { Scale = 1 })
		currentTween:Play()

	else
		-- >> CLOSING LOGIC (INSTANT) <<

		playUiSound("Click")

		-- 1. Instant Cleanup (No Tween)
		window.Visible = false
		openButton.Visible = true
		uiScale.Scale = 1 -- Reset scale just in case

		-- 2. Restore other GUIs immediately
		setOtherGuisEnabled(true)
	end
end

-- ðŸŽµ MUSIC TOGGLE LOGIC
local function setMusicMuted(shouldBeMuted)
	btnMusicOn.Visible = not shouldBeMuted
	btnMusicOff.Visible = shouldBeMuted

	local vol = shouldBeMuted and 0 or CONFIG.DefaultVolume
	if gameTheme then gameTheme.Volume = vol end

	local shopMusic = SoundService:FindFirstChild("ShopMusic_Internal")
	if shopMusic then shopMusic.Volume = vol end

	-- Only play sound if the window is actually visible (prevents spam on init)
	if window.Visible then
		playUiSound("Click")
	end
end

-- ðŸ–±ï¸ BUTTON SETUP
local function setupButton(btn, onClick)
	if not btn or not btn:IsA("GuiButton") then return end

	if not UserInputService.TouchEnabled then
		btn.MouseEnter:Connect(function()
			TweenService:Create(btn, TweenInfo.new(0.12), { ImageColor3 = CONFIG.Colors.Hover }):Play()
		end)

		btn.MouseLeave:Connect(function()
			TweenService:Create(btn, TweenInfo.new(0.12), { ImageColor3 = CONFIG.Colors.Normal }):Play()
		end)
	end

	btn.MouseButton1Click:Connect(function()
		if onClick then onClick() end
	end)
end

-- ðŸš€ INITIALIZATION
setupButton(openButton, function() setWindowVisible(true) end)
setupButton(closeButton, function() setWindowVisible(false) end)
setupButton(btnMusicOn, function() setMusicMuted(true) end)
setupButton(btnMusicOff, function() setMusicMuted(false) end)

-- Default State
window.Visible = false
openButton.Visible = true

-- [FIXED] Sync initial music state immediately.
-- This ensures the buttons match the actual game volume right when the player joins,
-- eliminating the "double-click" bug on the first try.
setMusicMuted(false)
