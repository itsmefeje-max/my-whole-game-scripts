-- ( SERVER SCRIPT: SecureClaimHandler - RED EMPTY INDICATOR )
-- Features: Massive Billboard, "Verifying" Delay, K/M/B Suffixes, and Red/Green Status.

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local TycoonFolder = Workspace:WaitForChild("Tycoons")
local ClaimFeedbackEvent = ReplicatedStorage:WaitForChild("ClaimFeedback")

-- âš™ï¸ CONFIGURATION
local CLAIM_PART_NAME = "ClaimEarnings" 
local COOLDOWN_TIME = 3       
local PROMPT_DISTANCE = 10    
local SIGN_DISTANCE = 70      

-- ðŸŽ¨ COLORS
local GOLD_COLOR = Color3.fromRGB(255, 235, 80)   -- Title
local GREEN_COLOR = Color3.fromRGB(85, 255, 127)  -- Money > 0
local RED_COLOR = Color3.fromRGB(255, 85, 85)     -- Money == 0 (Empty)

-- ðŸ“Š ABBREVIATION SYSTEM
local SUFFIXES = {"K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"}

local function formatNumber(n)
	n = tonumber(n)
	if not n then return "0" end
	if n < 1000 then return tostring(math.floor(n)) end
	local i = math.floor(math.log(n, 1000))
	local v = math.pow(1000, i)
	local suffix = SUFFIXES[i] or "?"
	return string.format("%.2f%s", n / v, suffix)
end

-- ðŸ›¡ï¸ STATE MANAGEMENT
local debounce = {} -- [userId][claimPart] = lastTime

-- ðŸ› ï¸ SETUP FUNCTION
local function setupClaimPart(plot)
	local claimPart = plot:WaitForChild(CLAIM_PART_NAME, 5) 
	if not claimPart then return end

	-- 1. Create Prompt (Interaction)
	if claimPart:FindFirstChild("ClaimPrompt") then claimPart.ClaimPrompt:Destroy() end

	local prompt = Instance.new("ProximityPrompt")
	prompt.Name = "ClaimPrompt"
	prompt.ActionText = "Collect Earnings"
	prompt.ObjectText = "Earnings"
	prompt.HoldDuration = 0.5 
	prompt.MaxActivationDistance = PROMPT_DISTANCE
	prompt.RequiresLineOfSight = false
	prompt.Parent = claimPart

	-- 2. Create Billboard (Visuals)
	if claimPart:FindFirstChild("ClaimGUI") then claimPart.ClaimGUI:Destroy() end

	local bb = Instance.new("BillboardGui")
	bb.Name = "ClaimGUI"
	bb.Adornee = claimPart
	bb.Size = UDim2.new(15, 0, 6, 0) 
	bb.StudsOffset = Vector3.new(0, 6.5, 0) 
	bb.AlwaysOnTop = true
	bb.MaxDistance = SIGN_DISTANCE 
	bb.Parent = claimPart

	local titleTxt = Instance.new("TextLabel")
	titleTxt.Name = "Title"
	titleTxt.Parent = bb
	titleTxt.Size = UDim2.new(1, 0, 0.4, 0) 
	titleTxt.BackgroundTransparency = 1 
	titleTxt.Text = "TOTAL EARNINGS"
	titleTxt.TextColor3 = GOLD_COLOR
	titleTxt.TextStrokeTransparency = 0.6 
	titleTxt.Font = Enum.Font.FredokaOne 
	titleTxt.TextScaled = true 

	local moneyTxt = Instance.new("TextLabel")
	moneyTxt.Name = "MoneyDisplay"
	moneyTxt.Parent = bb
	moneyTxt.Size = UDim2.new(1, 0, 0.6, 0) 
	moneyTxt.Position = UDim2.new(0, 0, 0.35, 0)
	moneyTxt.BackgroundTransparency = 1 
	moneyTxt.Text = "$ 0"
	moneyTxt.TextColor3 = RED_COLOR -- Default to Red
	moneyTxt.TextStrokeTransparency = 0.6 
	moneyTxt.Font = Enum.Font.FredokaOne 
	moneyTxt.TextScaled = true 

	-- 3. Live Money Update (The Logic)
	local pendingVal = plot:WaitForChild("PendingEarnings", 5)

	local function updateDisplay()
		if pendingVal then
			moneyTxt.Text = "$ " .. formatNumber(pendingVal.Value)

			-- ðŸ”´ RED vs ðŸŸ¢ GREEN Logic
			if pendingVal.Value <= 0 then
				moneyTxt.TextColor3 = RED_COLOR
			else
				moneyTxt.TextColor3 = GREEN_COLOR
			end
		end
	end

	if pendingVal then
		pendingVal.Changed:Connect(updateDisplay)
		updateDisplay() -- Run once immediately
	end

	-- 4. Interaction Logic
	prompt.Triggered:Connect(function(player)
		local userId = player.UserId

		-- Cooldown
		debounce[userId] = debounce[userId] or {}
		local lastUse = debounce[userId][claimPart]
		if lastUse and (os.time() - lastUse) < COOLDOWN_TIME then return end
		debounce[userId][claimPart] = os.time()

		-- Feedback: Verifying...
		ClaimFeedbackEvent:FireClient(player, "Verifying", 0)
		task.wait(2) -- Fake Delay

		-- Security Check
		local ownerVal = plot:FindFirstChild("Owner")
		if not ownerVal or ownerVal.Value ~= player.Name then
			ClaimFeedbackEvent:FireClient(player, "Error", 0) 
			return 
		end

		-- Earnings Check
		if not pendingVal or pendingVal.Value <= 0 then 
			ClaimFeedbackEvent:FireClient(player, "NoEarnings", 0) 
			return 
		end

		-- Give Money
		local amountToGive = pendingVal.Value
		pendingVal.Value = 0 

		local leaderstats = player:FindFirstChild("leaderstats")
		if leaderstats then
			local cash = leaderstats:FindFirstChild("Cash")
			if cash then
				cash.Value += amountToGive
				ClaimFeedbackEvent:FireClient(player, "Success", amountToGive)
			end
		end
	end)
end

-- ðŸ”„ Initialization Loop
for _, plot in pairs(TycoonFolder:GetChildren()) do
	task.spawn(function() setupClaimPart(plot) end)
end

TycoonFolder.ChildAdded:Connect(function(plot)
	task.spawn(function() setupClaimPart(plot) end)
end)
