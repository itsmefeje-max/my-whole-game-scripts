-- [[ SERVER SCRIPT: TransactionHandler (Step 1: Bank -> NPC Holding) ]]
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ‚ö†Ô∏è Ensure "WithdrawFunction" exists in ReplicatedStorage (RemoteFunction)
local withdrawFunc = ReplicatedStorage:WaitForChild("WithdrawFunction")

-- [[ CORE TRANSFER LOGIC ]]
local function TransferToManager(player, rawAmount)
	print("üè¶ [BANK DEBUG] Transferring to NPC for " .. player.Name)

	-- 1. Validate Input
	if not player or typeof(rawAmount) ~= "number" or rawAmount ~= rawAmount then
		return false, "System Error (Invalid Data)"
	end

	local amount = math.floor(rawAmount)
	if amount <= 0 then return false, "Invalid Amount" end

	-- 2. Validate Funds
	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return false, "Missing Leaderstats" end

	local bank = leaderstats:FindFirstChild("Cash")        -- The Bank
	local atmBal = leaderstats:FindFirstChild("ATMBalance") -- The NPC Holding

	if not bank or not atmBal then return false, "Missing Bank/ATM Values" end

	print("   > Current Bank: " .. bank.Value .. " | Sending to ATM: " .. amount)

	if bank.Value >= amount then
		-- THE SWAP
		bank.Value = bank.Value - amount      -- Remove from Digital Bank
		atmBal.Value = atmBal.Value + amount  -- Add to NPC Manager Holding

		print("‚úÖ [BANK DEBUG] Success. NPC now holds: " .. atmBal.Value)
		return true, "Sent to ATM Manager! Visit him to collect."
	else
		return false, "Insufficient Bank Funds"
	end
end

-- [[ SERVER LISTENER ]]
withdrawFunc.OnServerInvoke = function(player, amount)
	-- No distance check. This is a digital transfer.
	return TransferToManager(player, amount)
end
