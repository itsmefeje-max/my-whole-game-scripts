-- [[ SERVER SCRIPT: ReceiptRouter ]]
-- Centralizes MarketplaceService.ProcessReceipt for the entire game.

local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage")

-- ‚öôÔ∏è PRODUCT IDs
local TABLET_2X_ID = 3509697462 -- Your Tablet ID
local SHOP_REROLL_ID = 3520990584 -- ‚úÖ Your Reroll ID

-- üöó CAR PRODUCT IDs (Add these when you create them!)
-- Format: [Product_ID] = "CarName"
local CAR_PRODUCT_IDS = {
	[0000001] = "Delta",   -- ‚ö†Ô∏è REPLACE 0000001 WITH REAL ID
	[0000002] = "Iva",     -- ‚ö†Ô∏è REPLACE 0000002 WITH REAL ID
	[0000003] = "Atom",    -- ‚ö†Ô∏è REPLACE 0000003 WITH REAL ID
	[0000004] = "Windsor", -- ‚ö†Ô∏è REPLACE 0000004 WITH REAL ID
	[0000005] = "Senator", -- ‚ö†Ô∏è REPLACE 0000005 WITH REAL ID
	[0000006] = "Riva"     -- ‚ö†Ô∏è REPLACE 0000006 WITH REAL ID
}

-- üîó REFERENCES
local TycoonFolder = Workspace:WaitForChild("Tycoons")
-- Look for the LocalShopService Bindable
local ShopServiceScript = game.ServerScriptService:WaitForChild("LocalShopService")
local ShopRerollFunc = ShopServiceScript:WaitForChild("ShopRerollFunction")

MarketplaceService.ProcessReceipt = function(receiptInfo)
	local player = Players:GetPlayerByUserId(receiptInfo.PlayerId)

	-- 1. Handle Player Leaving/Crashing
	if not player then return Enum.ProductPurchaseDecision.NotProcessedYet end

	local pid = receiptInfo.ProductId

	-- ====================================================
	-- PRODUCT: TABLET 2X EARNINGS
	-- ====================================================
	if pid == TABLET_2X_ID then
		local myPlotName = player:GetAttribute("OccupiedPlot")
		local plot = TycoonFolder:FindFirstChild(myPlotName or "")

		-- If plot isn't loaded yet, retry later
		if not plot or not plot:FindFirstChild("PendingEarnings") then 
			return Enum.ProductPurchaseDecision.NotProcessedYet 
		end

		local pendingVal = plot.PendingEarnings
		local amount = pendingVal.Value

		-- Logic: Reset pending, add 2x to cash
		if amount > 0 then
			pendingVal.Value = 0
			local ls = player:FindFirstChild("leaderstats")
			if ls and ls:FindFirstChild("Cash") then
				ls.Cash.Value += (amount * 2)
			end
			return Enum.ProductPurchaseDecision.PurchaseGranted
		else
			-- Edge case: 0 earnings, grant anyway to avoid infinite retry loop
			return Enum.ProductPurchaseDecision.PurchaseGranted
		end

		-- ====================================================
		-- PRODUCT: SHOP REROLL (Restock)
		-- ====================================================
	elseif pid == SHOP_REROLL_ID then
		if ShopRerollFunc then
			ShopRerollFunc:Invoke(player) -- Call LocalShopService
			return Enum.ProductPurchaseDecision.PurchaseGranted
		end

		-- ====================================================
		-- PRODUCT: BUY CAR WITH ROBUX
		-- ====================================================
	elseif CAR_PRODUCT_IDS[pid] then
		local carName = CAR_PRODUCT_IDS[pid]
		local CarTools = ServerStorage:FindFirstChild("CarTools")

		-- Try finding the tool by exact name or with " Item" suffix
		local tool = CarTools and (CarTools:FindFirstChild(carName) or CarTools:FindFirstChild(carName.." Item"))

		if tool then
			-- Grant the car directly to Backpack and StarterGear
			local newTool = tool:Clone()
			newTool:SetAttribute("IssuedByServer", true)
			newTool:SetAttribute("IssuedAt", os.time())
			newTool:SetAttribute("ToolId", tool.Name)
			newTool.Parent = player.Backpack

			local gearClone = newTool:Clone()
			gearClone.Parent = player.StarterGear

			print("‚úÖ Gave Robux Car: " .. carName .. " to " .. player.Name)
			return Enum.ProductPurchaseDecision.PurchaseGranted
		else
			warn("‚ùå Critical: Player bought " .. carName .. " but the Tool is missing in ServerStorage!")
			return Enum.ProductPurchaseDecision.NotProcessedYet -- Retry until you fix the tool name
		end
	end

	-- Unknown Product
	return Enum.ProductPurchaseDecision.NotProcessedYet
end
