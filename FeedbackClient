-- ( CLIENT SIDE: Feedback System - PERFECTED )
-- Features: Pulse VFX, Sound, Spam Protection, and Anti-Overlap Logic.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")

local ClaimFeedbackEvent = ReplicatedStorage:WaitForChild("ClaimFeedback")
local ScreenGui = script.Parent

-- ‚ö†Ô∏è ENSURE ALL 4 IMAGES EXIST IN YOUR GUI:
local SuccessImage = ScreenGui:WaitForChild("SuccessImage")
local ErrorImage = ScreenGui:WaitForChild("ErrorImage")
local VerifyingImage = ScreenGui:WaitForChild("VerifyingImage")
local NoEarningsImage = ScreenGui:WaitForChild("NoEarningsImage")

-- üîä SOUND CONFIG
local CASH_SOUND_ID = "rbxassetid://128506762153961"
local ERROR_SOUND_ID = "rbxassetid://3779045779"
local EMPTY_SOUND_ID = "rbxassetid://17620645740"

-- ‚è≥ COOLDOWN CONFIG
local NO_EARNINGS_COOLDOWN = 3 -- Seconds
local lastNoEarningsTime = 0

-- üõ°Ô∏è STATE MANAGEMENT (The Fix for Overlapping)
local currentJobId = 0 -- Tracks the latest action to cancel old ones
local currentTween = nil -- Tracks the active tween to cancel it

-- üõ†Ô∏è HELPER: Reset Everything
-- This runs before ANY new icon shows up. It forces the screen to be clean.
local function resetVisuals()
	-- 1. Increment Job ID (Invalidates any waiting tasks)
	currentJobId = currentJobId + 1
	
	-- 2. Cancel active Tweens
	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end

	-- 3. Hide ALL Images instantly
	SuccessImage.Visible = false
	ErrorImage.Visible = false
	NoEarningsImage.Visible = false
	
	VerifyingImage.Visible = false
	VerifyingImage.ImageTransparency = 0 -- Reset from pulse
	VerifyingImage.Rotation = 0
	
	-- Reset others to opaque just in case
	SuccessImage.ImageTransparency = 0
	ErrorImage.ImageTransparency = 0
	NoEarningsImage.ImageTransparency = 0
end

local function playSound(soundId)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = 1
	sound.Parent = Players.LocalPlayer.PlayerGui 
	sound:Play()
	game.Debris:AddItem(sound, 3) 
end

-- üåÄ VFX: Verifying (Pulse)
local function startVerifying()
	resetVisuals() -- Clean screen first!

	VerifyingImage.Visible = true
	VerifyingImage.ImageTransparency = 1 

	local pulseInfo = TweenInfo.new(0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	currentTween = TweenService:Create(VerifyingImage, pulseInfo, {ImageTransparency = 0})
	currentTween:Play()
end

-- üñºÔ∏è VFX: Show Result (Success / Error / etc)
local function showResult(imageObject, soundId)
	resetVisuals() -- Clean screen first!
	
	-- 1. Play Sound
	playSound(soundId)
	
	-- 2. Show Image
	imageObject.Visible = true
	imageObject.ImageTransparency = 0
	
	-- 3. Capture the current Job ID
	local myJob = currentJobId
	
	-- 4. Wait 3 Seconds (But watch for interruptions!)
	task.wait(3)
	
	-- ‚ö†Ô∏è CRITICAL CHECK:
	-- If 'currentJobId' changed while we were waiting, it means a NEW event happened.
	-- So we STOP here and don't try to fade out (because we are already hidden).
	if currentJobId ~= myJob then return end

	-- 5. Fade Out (Only if we are still the active job)
	currentTween = TweenService:Create(imageObject, TweenInfo.new(0.5), {ImageTransparency = 1})
	currentTween:Play()
	currentTween.Completed:Wait()
	
	-- Final cleanup check
	if currentJobId == myJob then
		imageObject.Visible = false
	end
end

-- üì° MAIN EVENT LISTENER
ClaimFeedbackEvent.OnClientEvent:Connect(function(status, amount)

	if status == "Verifying" then
		startVerifying()

	elseif status == "Success" then
		showResult(SuccessImage, CASH_SOUND_ID)

	elseif status == "Error" then
		showResult(ErrorImage, ERROR_SOUND_ID)

	elseif status == "NoEarnings" then
		-- üõë Spam Check
		local currentTime = os.time()
		if (currentTime - lastNoEarningsTime) < NO_EARNINGS_COOLDOWN then
			resetVisuals() -- Hide verifying if they spam, but don't play error sound again
			return 
		end
		lastNoEarningsTime = currentTime
		
		showResult(NoEarningsImage, EMPTY_SOUND_ID)
	end
end)
