-- [[ LOCAL SCRIPT: LocalShopController ]]
-- UPDATED: Removed double sounds and success toast.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local Kit = require(ReplicatedStorage:WaitForChild("ShopFrontendKit"))

-- âš™ï¸ CONFIGURATION
local REROLL_PRODUCT_ID = 3520990584 
local SHOP_CARS = {"Delta", "Iva", "Atom", "Windsor", "Senator", "Riva"}
local DEFAULT_LIMIT = 2

local ROBUX_PRODUCTS = {
	Delta = 0000001, Iva = 0000002, Atom = 0000003, 
	Windsor = 0000004, Senator = 0000005, Riva = 0000006
}

-- ðŸ“¡ REMOTES
local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")
local RemoteOpen = Remotes:WaitForChild("OpenLocalShop")
local RemoteUpdate = Remotes:WaitForChild("ShopUpdate")
local FuncGetState = Remotes:WaitForChild("GetShopState")
local FuncBuyCar = Remotes:WaitForChild("BuyLocalCar")

-- ðŸ›¡ï¸ STATE
local currentState = nil
local purchaseDebounce = {} 

-- ðŸ›‘ UI REFERENCES
local function getUI()
	local gui = PlayerGui:WaitForChild("LocalShopUI")
	local mainFrame = gui:WaitForChild("MainFrame")
	return gui, mainFrame, mainFrame:WaitForChild("ScrollingFrame"), mainFrame:WaitForChild("TimerLabel"), mainFrame:WaitForChild("RerollButton"), mainFrame:WaitForChild("CloseButton")
end

-- ============================================================================
-- ðŸ§  RENDER LOGIC
-- ============================================================================
local function RenderCard(card, carName, state)
	local buyBtn = card:FindFirstChild("BuyButton")
	local robuxBtn = card:FindFirstChild("RobuxButton")
	local carImage = card:FindFirstChild("CarImage")
	local statusLabel = card:FindFirstChild("StatusLabel")

	if carImage and state.Image then carImage.Image = state.Image end

	if statusLabel then
		statusLabel.Visible = true
		statusLabel.Text = state.StatusText
		statusLabel.TextColor3 = state.StatusColor
	end

	if buyBtn then
		if state.IsPurchasing then
			buyBtn.Text = "..."
			buyBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
			buyBtn.Active = false
		elseif not state.CanBuy then
			buyBtn.Text = state.BuyText
			buyBtn.BackgroundColor3 = state.BuyColor
			buyBtn.Active = false
		else
			buyBtn.Text = "$" .. state.Price
			buyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
			buyBtn.Active = true
		end
	end

	if robuxBtn then robuxBtn.Visible = state.CanRobux end
end

local function UpdateDisplay(scrollFrame)
	if not currentState then return end
	local limit = player:GetAttribute("LocalCarLimit") or DEFAULT_LIMIT

	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:FindFirstChild(carName)
		if card then
			local data = CarStats.Cars[carName]
			local myCount = Kit.Inventory:GetCount(carName)
			local isFeatured = currentState.Featured[carName]
			local isBought = currentState.Purchased[carName]
			local isPurchasing = purchaseDebounce[carName]

			local vm = {
				Image = data.Image,
				Price = data.Price,
				IsPurchasing = isPurchasing,
				CanBuy = false,
				CanRobux = true,
				StatusText = "",
				StatusColor = Color3.new(1,1,1),
				BuyText = "",
				BuyColor = Color3.fromRGB(80, 80, 80)
			}

			if not isFeatured or isBought then
				vm.StatusText = "No stock"
				vm.StatusColor = Color3.fromRGB(150, 150, 150)
				vm.BuyText = "No stock"
				vm.CanRobux = not isBought
			else
				vm.StatusText = "ON STOCK"
				vm.StatusColor = Color3.fromRGB(80, 255, 120)
				if myCount >= limit then
					vm.BuyText = "Limit Reached"
					vm.BuyColor = Color3.fromRGB(150, 0, 0)
					vm.CanRobux = false
				else
					vm.CanBuy = true
				end
			end
			RenderCard(card, carName, vm)
		end
	end
end

-- ============================================================================
-- ðŸ›’ ACTIONS
-- ============================================================================
local function AttemptBuy(carName, scrollFrame)
	if purchaseDebounce[carName] then return end
	
	purchaseDebounce[carName] = true
	UpdateDisplay(scrollFrame)
	Kit.Sound:Play("Click")
	
	task.spawn(function()
		local success, msg = FuncBuyCar:InvokeServer(carName)
		purchaseDebounce[carName] = false
		
		if success then
			Kit.Sound:Play("BuySuccess")
			-- REMOVED: Success Toast
		else
			Kit.Sound:Play("BuyFail")
			Kit.Toast:Show(msg, Color3.fromRGB(255, 80, 80))
			local card = scrollFrame:FindFirstChild(carName)
			if card then Kit.Tween:Shake(card) end
		end
		UpdateDisplay(scrollFrame)
	end)
end

-- ============================================================================
-- ðŸš€ INIT
-- ============================================================================
local function init()
	local gui, mainFrame, scrollFrame, timerLabel, rerollBtn, closeBtn = getUI()
	
	Kit.Inventory:Init(SHOP_CARS)

	-- 1. Setup Main Buttons
	Kit.Tween:SetupButton(rerollBtn, function()
		-- REMOVED: Kit.Sound:Play("Reroll") (Fixed Double Sound)
		MarketplaceService:PromptProductPurchase(player, REROLL_PRODUCT_ID)
	end)

	Kit.Tween:SetupButton(closeBtn, function()
		-- REMOVED: Kit.Sound:Play("Close") (Fixed Double Sound)
		gui.Enabled = false
	end)

	-- 2. Setup Cards
	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:WaitForChild(carName, 5)
		if card then
			local buyBtn = card:FindFirstChild("BuyButton")
			if buyBtn then
				buyBtn.MouseButton1Click:Connect(function()
					if buyBtn.Active then AttemptBuy(carName, scrollFrame) end
				end)
			end
			
			local robuxBtn = card:FindFirstChild("RobuxButton")
			if robuxBtn then
				Kit.Tween:SetupButton(robuxBtn, function()
					local pid = ROBUX_PRODUCTS[carName]
					if pid then MarketplaceService:PromptProductPurchase(player, pid) end
				end)
			end
		end
	end

	-- 3. Timer & Restock
	local isSyncing = false
	task.spawn(function()
		while true do
			task.wait(1)
			if gui.Enabled and currentState then
				local left = math.max(0, currentState.NextRestock - os.time())
				timerLabel.Text = string.format("Restock: %02d:%02d", math.floor(left/60), left%60)

				if left == 0 and not isSyncing then
					isSyncing = true
					Kit.Sound:Play("Restock")
					Kit.Toast:Show("SHOP RESTOCKED!", Color3.fromRGB(255, 255, 0))
					
					task.delay(1, function() 
						currentState = FuncGetState:InvokeServer()
						UpdateDisplay(scrollFrame)
						isSyncing = false
					end)
				end
			end
		end
	end)

	-- 4. Remotes
	RemoteOpen.OnClientEvent:Connect(function()
		Kit.Sound:Play("Open")
		gui.Enabled = true
		currentState = FuncGetState:InvokeServer()
		UpdateDisplay(scrollFrame)
	end)

	RemoteUpdate.OnClientEvent:Connect(function(newState)
		currentState = newState
		UpdateDisplay(scrollFrame)
	end)
end

if player.Character then init() else player.CharacterAdded:Wait(); init() end
