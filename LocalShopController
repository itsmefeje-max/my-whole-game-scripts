-- [[ LOCAL SCRIPT: LocalShopController ]]
-- UPDATED: Fixed Robux Button visibility (Always shows for Delta/Configured Cars)
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- üõë IMMEDIATE HIDE
local gui = PlayerGui:WaitForChild("LocalShopUI")
local mainFrame = gui:WaitForChild("MainFrame")
mainFrame.Visible = true 
gui.Enabled = false 

local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local Kit = require(ReplicatedStorage:WaitForChild("ShopFrontendKit"))

-- ‚öôÔ∏è CONFIGURATION
local REROLL_PRODUCT_ID = 3520990584 
local SHOP_CARS = {"Delta", "Iva", "Atom", "Windsor", "Senator", "Riva"}

-- üî¥ IMPORTANT: REPLACE THESE NUMBERS WITH YOUR REAL DEVELOPER PRODUCT IDS
local ROBUX_PRODUCTS = {
	Delta   = 0000000, -- Replace with REAL ID (Button will now show even if this is 0)
	Iva     = 1111111, -- Replace with REAL ID
	Atom    = 2222222, -- Replace with REAL ID
	Windsor = 3333333, -- Replace with REAL ID
	Senator = 4444444, -- Replace with REAL ID
	Riva    = 5555555  -- Replace with REAL ID
}

-- üì° REMOTES
local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")
local RemoteOpen = Remotes:WaitForChild("OpenLocalShop")
local RemoteUpdate = Remotes:WaitForChild("ShopUpdate")
local FuncGetState = Remotes:WaitForChild("GetShopState")
local FuncBuyCar = Remotes:WaitForChild("BuyLocalCar")

-- üõ°Ô∏è STATE
local currentState = nil
local purchaseDebounce = {} 
local isProcessingPurchase = false 

-- üõë UI REFERENCES
local function getUI()
	return gui, mainFrame, mainFrame:WaitForChild("ScrollingFrame"), mainFrame:WaitForChild("TimerLabel"), 
	mainFrame:WaitForChild("RerollButton"), mainFrame:WaitForChild("CloseButton")
end

-- ============================================================================
-- üß† RENDER LOGIC
-- ============================================================================
local function RenderCard(card, carName, state)
	local carImage = card:FindFirstChild("CarImage")
	local stockLabel = card:FindFirstChild("StockInformation") 
	local buyBtn = card:FindFirstChild("BuyButton")
	local robuxBtn = card:FindFirstChild("RobuxButton") 
	
	-- üÜï NEW: Find the NoStockIndicator
	local noStockInd = card:FindFirstChild("NoStockIndicator")

	if carImage and state.Image then carImage.Image = state.Image end

	-- ‚úÖ STOCK TEXT LOGIC
	if stockLabel then
		stockLabel.Visible = true
		if state.StockAmount and state.StockAmount > 0 then
			stockLabel.Text = "On Stock x " .. state.StockAmount
			stockLabel.TextColor3 = Color3.fromRGB(85, 255, 127) -- Green
		else
			stockLabel.Text = "No Stock"
			stockLabel.TextColor3 = Color3.fromRGB(255, 80, 80) -- Red
		end
	end

	-- 1. CASH BUTTON & NO STOCK INDICATOR LOGIC
	if buyBtn then
		buyBtn.ZIndex = 20 
		
		if state.CanBuy then
			-- ‚úÖ CASE: IN STOCK
			buyBtn.Visible = true
			buyBtn.Active = true
			if noStockInd then noStockInd.Visible = false end -- Hide Indicator

			-- Update Button Visuals
			if buyBtn:IsA("TextButton") then
				if state.IsPurchasing then
					buyBtn.Text = "..."
					buyBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
				else
					buyBtn.Text = "$" .. state.Price
					buyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
				end
			end
			if buyBtn:IsA("ImageButton") then
				buyBtn.ImageColor3 = Color3.new(1,1,1)
			end
			
		else
			-- ‚ùå CASE: OUT OF STOCK
			buyBtn.Visible = false -- Hide Button
			buyBtn.Active = false
			if noStockInd then noStockInd.Visible = true end -- Show Indicator
		end
	end

	-- 2. ROBUX BUTTON (Always Visible if Configured)
	if robuxBtn then 
		-- We force visibility if CanRobux is true (which is now always true if in list)
		robuxBtn.Visible = state.CanRobux 
		robuxBtn.ZIndex = 25 -- [FIX] Increased ZIndex to ensure it sits above everything
		robuxBtn.Active = true 
	end
end

local function UpdateDisplay(scrollFrame)
	if not currentState then return end

	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:FindFirstChild(carName)
		if card then
			local data = CarStats.Cars[carName]
			local isFeatured = currentState.Featured[carName] 
			local currentStock = currentState.Stock and currentState.Stock[carName] or 0
			local isPurchasing = purchaseDebounce[carName]

			local vm = {
				Image = data.Image,
				Price = data.Price,
				IsPurchasing = isPurchasing,
				StockAmount = currentStock,
				CanBuy = false,
				CanRobux = false
			}

			-- 1. Cash Buying Logic (Depends on Stock)
			if isFeatured then
				vm.CanBuy = (currentStock > 0)
				vm.StockAmount = currentStock
			else
				vm.CanBuy = false
				vm.StockAmount = 0
			end

			-- 2. Robux Buying Logic (FIXED: Always Available if in list)
			-- We removed the "> 0" check so the button appears even for placeholders
			if ROBUX_PRODUCTS[carName] then
				vm.CanRobux = true 
			else
				vm.CanRobux = false
			end
			
			RenderCard(card, carName, vm)
		end
	end
end

local function AttemptBuy(carName, scrollFrame)
	if purchaseDebounce[carName] then return end
	purchaseDebounce[carName] = true
	isProcessingPurchase = true 
	UpdateDisplay(scrollFrame)

	task.spawn(function()
		local success, msg = FuncBuyCar:InvokeServer(carName)
		purchaseDebounce[carName] = false
		isProcessingPurchase = false 

		if success then
			Kit.Sound:Play("BuySuccess")
		else
			Kit.Sound:Play("BuyFail")
			Kit.Toast:Show(msg, Color3.fromRGB(255, 80, 80))
			local card = scrollFrame:FindFirstChild(carName)
			if card then Kit.Tween:Shake(card) end
		end
		UpdateDisplay(scrollFrame)
	end)
end

-- ============================================================================
-- üöÄ INIT
-- ============================================================================
local function init()
	local gui, mainFrame, scrollFrame, timerLabel, rerollBtn, closeBtn = getUI()
	gui.Enabled = false 
	Kit.Inventory:Init(SHOP_CARS)

	Kit.Tween:SetupButton(rerollBtn, function()
		MarketplaceService:PromptProductPurchase(player, REROLL_PRODUCT_ID)
	end)

	Kit.Tween:SetupButton(closeBtn, function()
		gui.Enabled = false
	end)

	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:WaitForChild(carName, 5)
		if card then
			-- SETUP CASH BUY BUTTON
			local buyBtn = card:FindFirstChild("BuyButton")
			if buyBtn then
				Kit.Tween:SetupButton(buyBtn, function()
					if buyBtn.Visible and buyBtn.Active then AttemptBuy(carName, scrollFrame) end
				end)
			end

			-- SETUP ROBUX BUTTON
			local robuxBtn = card:FindFirstChild("RobuxButton")
			if robuxBtn then
				Kit.Tween:SetupButton(robuxBtn, function()
					local pid = ROBUX_PRODUCTS[carName]
					if pid and pid > 0 then 
						MarketplaceService:PromptProductPurchase(player, pid) 
					else
						-- [WARN] Helpful print for you if you forget to set the ID
						warn("‚ö†Ô∏è You clicked the Robux Button for " .. carName .. " but the ID is 0! Please update ROBUX_PRODUCTS in LocalShopController.")
					end
				end)
			end
		end
	end

	task.spawn(function()
		while true do
			task.wait(1)
			if gui.Enabled then
				local now = os.time()
				local secondsLeft = 300 - (now % 300)
				timerLabel.Text = string.format("New Cars will restock at : %02d:%02d", math.floor(secondsLeft/60), secondsLeft%60)
			end
		end
	end)

	RemoteOpen.OnClientEvent:Connect(function()
		Kit.Sound:Play("Open")
		gui.Enabled = true 
		currentState = FuncGetState:InvokeServer()
		UpdateDisplay(scrollFrame)
	end)

	RemoteUpdate.OnClientEvent:Connect(function(newState)
		currentState = newState
		UpdateDisplay(scrollFrame)
		if not isProcessingPurchase then Kit.Sound:Play("Restock") end
	end)
end

if player.Character then init() else player.CharacterAdded:Wait(); init() end
