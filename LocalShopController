-- [[ LOCAL SCRIPT: LocalShopController ]]
-- UPDATED: Fixes "Insufficient Money" error when spamming buy button.
-- NOW: Correctly identifies "Slow down" vs "No Funds".
-- UI UPDATE: Supports CarImageContainer & Removed Wiggle Effect.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local SoundService = game:GetService("SoundService")
local Debris = game:GetService("Debris")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- üõë IMMEDIATE HIDE
local gui = PlayerGui:WaitForChild("LocalShopUI")
local mainFrame = gui:WaitForChild("MainFrame")
mainFrame.Visible = true 
gui.Enabled = false 

local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local Kit = require(ReplicatedStorage:WaitForChild("ShopFrontendKit"))

-- ‚öôÔ∏è CONFIGURATION
local REROLL_PRODUCT_ID = 3520990584 
local SHOP_CARS = {"Delta", "Iva", "Atom", "Windsor", "Senator", "Riva"}
local SPECIAL_SFX_ID = "rbxassetid://140072726814802" 
local BLUR_SIZE = 24 

-- üé® FEEDBACK CONFIGURATION
local FEEDBACK_COLORS = {
	Success = Color3.fromRGB(80, 200, 120),   -- Soft Mint Green
	FailRobux = Color3.fromRGB(255, 95, 95),  -- Soft Coral Red
	FailCash = Color3.fromRGB(255, 170, 60),  -- Soft Amber
	TooFast = Color3.fromRGB(255, 200, 50)    -- ‚ö†Ô∏è New: Yellow/Orange for spamming
}

-- üî¥ ROBUX IDS
local ROBUX_PRODUCTS = {
	Delta   = 3524326648, 
	Iva     = 3524327150, 
	Atom    = 3524327478, 
	Windsor = 3524327780, 
	Senator = 3524328208, 
	Riva    = 3524328713
}

-- üì° REMOTES
local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")
local RemoteOpen = Remotes:WaitForChild("OpenLocalShop")
local RemoteUpdate = Remotes:WaitForChild("ShopUpdate")
local FuncGetState = Remotes:WaitForChild("GetShopState")
local FuncBuyCar = Remotes:WaitForChild("BuyLocalCar")

-- üõ°Ô∏è STATE
local currentState = nil
local purchaseDebounce = {} 
local isProcessingPurchase = false 
local hiddenGuis = {} 
local hiddenObjects = {} -- Tracks GuiObjects (e.g. FriendBoost labels) hidden during shop focus
local currentBlur = nil 
local feedbackTween = nil 

-- üõë UI REFERENCES
local function getUI()
	return gui, mainFrame, mainFrame:WaitForChild("ScrollingFrame"), mainFrame:WaitForChild("TimerLabel"), 
	mainFrame:WaitForChild("RerollButton"), mainFrame:WaitForChild("CloseButton"), mainFrame:WaitForChild("Indicator-purchase", 5)
end

-- ============================================================================
-- üëÅÔ∏è FEEDBACK LOGIC
-- ============================================================================
local function showFeedback(text, color)
	local _, _, _, _, _, _, indicator = getUI()

	if not indicator then 
		warn("‚ö†Ô∏è 'Indicator-purchase' not found in MainFrame!") 
		return 
	end

	if feedbackTween then feedbackTween:Cancel() end
	indicator.Visible = true
	indicator.TextTransparency = 0
	indicator.Text = text
	indicator.TextColor3 = color

	task.delay(1.5, function()
		if indicator.Text == text and indicator.Visible then
			local t = TweenService:Create(indicator, TweenInfo.new(0.5), {TextTransparency = 1})
			t:Play()
			feedbackTween = t

			t.Completed:Connect(function()
				if indicator.TextTransparency >= 0.95 then
					indicator.Visible = false
				end
			end)
		end
	end)
end

-- ============================================================================
-- üëÅÔ∏è FOCUS MODE (BLUR + HIDE UI)
-- ============================================================================
local function setBlur(enable)
	if enable then
		if not currentBlur then
			currentBlur = Instance.new("BlurEffect")
			currentBlur.Size = 0
			currentBlur.Parent = Lighting
			currentBlur.Name = "ShopBlur"
		end
		TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = BLUR_SIZE}):Play()
	else
		if currentBlur then
			local t = TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = 0})
			t:Play()
			t.Completed:Connect(function()
				if currentBlur then currentBlur:Destroy() currentBlur = nil end
			end)
		end
	end
end

local function toggleNamedGuiObjects(shouldHide, objectName)
	if shouldHide then
		for _, obj in pairs(PlayerGui:GetDescendants()) do
			if obj:IsA("GuiObject") and obj.Name == objectName and obj.Visible then
				obj.Visible = false
				table.insert(hiddenObjects, obj)
			end
		end
	else
		for _, obj in pairs(hiddenObjects) do
			if obj and obj.Parent and obj:IsA("GuiObject") then
				obj.Visible = true
			end
		end
		hiddenObjects = {}
	end
end

local function toggleOtherGuis(shouldHide)
	if shouldHide then
		hiddenGuis = {}
		for _, otherGui in pairs(PlayerGui:GetChildren()) do
			if otherGui:IsA("ScreenGui") 
				and otherGui ~= gui 
				and otherGui.Enabled == true 
				and otherGui.Name ~= "Balance Indicator" then

				otherGui.Enabled = false
				table.insert(hiddenGuis, otherGui)
			end
		end
	else
		for _, otherGui in pairs(hiddenGuis) do
			if otherGui and otherGui.Parent then
				otherGui.Enabled = true
			end
		end
		hiddenGuis = {}
	end
end

local function setFocusMode(active)
	setBlur(active)
	toggleOtherGuis(active)
	toggleNamedGuiObjects(active, "FriendBoost")

	local char = player.Character
	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = active and 0 or 16
		char.Humanoid.JumpPower = active and 0 or 50
	end
end

-- ============================================================================
-- üß† RENDER LOGIC
-- ============================================================================
local function RenderCard(card, carName, state)
	local carImage = card:FindFirstChild("CarImage")
	local stockLabel = card:FindFirstChild("StockInformation") 
	local buyBtn = card:FindFirstChild("BuyButton")
	local robuxBtn = card:FindFirstChild("RobuxButton") 
	local noStockInd = card:FindFirstChild("NoStockIndicator")

	if carImage and state.Image then carImage.Image = state.Image end

	if stockLabel then
		stockLabel.Visible = true
		if state.CanBuy then
			stockLabel.Text = "On Stock x " .. state.StockAmount
			stockLabel.TextColor3 = Color3.fromRGB(85, 255, 127) 
		else
			stockLabel.Text = "No Stock"
			stockLabel.TextColor3 = Color3.fromRGB(255, 80, 80) 
		end
	end

	if buyBtn then
		if state.CanBuy then
			buyBtn.Visible = true; buyBtn.Active = true
			if noStockInd then noStockInd.Visible = false end 

			if buyBtn:IsA("TextButton") then
				if state.IsPurchasing then
					buyBtn.Text = "..."
					buyBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
				else
					buyBtn.Text = "$" .. state.Price
					buyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
				end
			end
			if buyBtn:IsA("ImageButton") then buyBtn.ImageColor3 = Color3.new(1,1,1) end
		else
			buyBtn.Visible = false; buyBtn.Active = false
			if noStockInd then noStockInd.Visible = true end 
		end
	end

	if robuxBtn then 
		robuxBtn.Visible = state.CanRobux 
		robuxBtn.Active = true 
	end
end

local function UpdateDisplay(scrollFrame)
	if not currentState then return end

	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:FindFirstChild(carName)
		if card then
			local data = CarStats.Cars[carName]
			local isFeatured = currentState.Featured[carName] == true
			local currentStock = currentState.Stock and currentState.Stock[carName] or 0
			local isPurchasing = purchaseDebounce[carName]

			local vm = {
				Image = data.Image,
				Price = data.Price,
				IsPurchasing = isPurchasing,
				IsFeatured = isFeatured,
				StockAmount = currentStock,
				CanBuy = (isFeatured and currentStock > 0),
				CanRobux = (ROBUX_PRODUCTS[carName] ~= nil)
			}
			RenderCard(card, carName, vm)
		end
	end
end

-- ‚úÖ THE FIX IS HERE (Updated Logic)
local function AttemptBuy(carName, scrollFrame)
	if purchaseDebounce[carName] then return end
	purchaseDebounce[carName] = true
	isProcessingPurchase = true 
	UpdateDisplay(scrollFrame)

	task.spawn(function()
		local success, msg = FuncBuyCar:InvokeServer(carName)
		purchaseDebounce[carName] = false
		isProcessingPurchase = false 

		if success then
			Kit.Sound:Play("BuySuccess")
			showFeedback("Purchase Success", FEEDBACK_COLORS.Success)
		else
			Kit.Sound:Play("BuyFail")
			Kit.Toast:Show(msg, Color3.fromRGB(255, 80, 80))
			local card = scrollFrame:FindFirstChild(carName)
			if card then Kit.Tween:Shake(card) end

			-- üß† SMART ERROR HANDLING
			if msg == "Slow down" or msg == "Purchase in progress" then
				showFeedback("Too Fast!", FEEDBACK_COLORS.TooFast) -- Orange/Yellow Warning
			elseif msg == "Insufficient Cash (Withdraw from ATM)" or msg == "Wallet Not Found" then
				showFeedback("Insufficient money", FEEDBACK_COLORS.FailCash) -- Red Warning
			elseif msg == "Out of Stock" then
				showFeedback("Out of Stock!", FEEDBACK_COLORS.FailCash)
			else
				-- Fallback for weird errors
				showFeedback(msg, FEEDBACK_COLORS.FailCash)
			end
		end
		UpdateDisplay(scrollFrame)
	end)
end

-- ============================================================================
-- üöÄ INIT & EVENTS
-- ============================================================================
local function init()
	local gui, mainFrame, scrollFrame, timerLabel, rerollBtn, closeBtn, indicatorLabel = getUI()

	if indicatorLabel then indicatorLabel.Visible = false end

	gui.Enabled = false 
	Kit.Inventory:Init(SHOP_CARS)

	Kit.Tween:SetupButton(rerollBtn, function()
		MarketplaceService:PromptProductPurchase(player, REROLL_PRODUCT_ID)
	end)

	Kit.Tween:SetupButton(closeBtn, function() 
		setFocusMode(false) 
		gui.Enabled = false 
	end)

	for _, carName in ipairs(SHOP_CARS) do
		local card = scrollFrame:WaitForChild(carName, 5)
		if card then
			-- 1. Look for Container first (New Structure)
			local container = card:FindFirstChild("CarImageContainer")
			local imageButton = nil

			if container then
				-- 2. Find CarImage inside container
				imageButton = container:FindFirstChild("CarImage")
			else
				-- 3. Fallback: Old structure (Direct child)
				local specificImageName = carName .. "-Image"
				imageButton = card:FindFirstChild(specificImageName)
				if not imageButton then imageButton = card:FindFirstChild("CarImage") end
			end

			-- (Removed SetupWiggle call here)

			local buyBtn = card:FindFirstChild("BuyButton")
			if buyBtn then
				Kit.Tween:SetupButton(buyBtn, function()
					if buyBtn.Visible and buyBtn.Active then AttemptBuy(carName, scrollFrame) end
				end)
			end

			local robuxBtn = card:FindFirstChild("RobuxButton")
			if robuxBtn then
				Kit.Tween:SetupButton(robuxBtn, function()
					local pid = ROBUX_PRODUCTS[carName]
					if pid and pid > 0 then 
						MarketplaceService:PromptProductPurchase(player, pid) 
					else
						warn("‚ö†Ô∏è Robux ID is 0 for " .. carName)
					end
				end)
			end

			local noStockBtn = card:FindFirstChild("NoStockIndicator")
			if noStockBtn then
				Kit.Tween:SetupButton(noStockBtn)
			end
		end
	end

	MarketplaceService.PromptProductPurchaseFinished:Connect(function(userId, productId, isPurchased)
		if userId ~= player.UserId then return end

		local isRelevant = false
		if productId == REROLL_PRODUCT_ID then isRelevant = true end
		for _, id in pairs(ROBUX_PRODUCTS) do
			if id == productId then isRelevant = true; break end
		end

		if not isRelevant then return end

		if isPurchased then
			if productId == REROLL_PRODUCT_ID then
				-- ‚úÖ REROLL SUCCESS
				showFeedback("Successfully Restocked", FEEDBACK_COLORS.Success)
				Kit.Sound:Play("PaidReroll") 
			else
				-- ‚úÖ CAR PURCHASE SUCCESS
				showFeedback("Purchase Success", FEEDBACK_COLORS.Success)

				local s = Instance.new("Sound")
				s.Name = "CarPurchaseSFX"
				s.SoundId = SPECIAL_SFX_ID
				s.Volume = 1.5 
				s.Pitch = 1.0
				s.Parent = SoundService
				s:Play()
				Debris:AddItem(s, 5)
			end
		else
			-- ‚ùå ROBUX FAIL/CANCEL
			Kit.Sound:Play("BuyFail") 

			if productId == REROLL_PRODUCT_ID then
				showFeedback("Restock Failed", FEEDBACK_COLORS.FailRobux)
			else
				showFeedback("Purchase Failed", FEEDBACK_COLORS.FailRobux)
			end
		end
	end)

	task.spawn(function()
		while true do
			task.wait(1)
			if gui.Enabled then
				local now = os.time()
				local target = currentState and currentState.NextRestock
				if target then
					local secondsLeft = math.max(target - now, 0)
					timerLabel.Text = string.format(
						"New Cars will restock at : %02d:%02d",
						math.floor(secondsLeft / 60),
						secondsLeft % 60
					)
				end
			end
		end
	end)

	RemoteOpen.OnClientEvent:Connect(function()
		setFocusMode(true) 
		Kit.Sound:Play("Open")
		gui.Enabled = true 

		currentState = {Featured = {}, Stock = {}, StockLimit = {}, Purchased = {}}
		UpdateDisplay(scrollFrame)

		local realState = FuncGetState:InvokeServer()
		currentState = realState
		UpdateDisplay(scrollFrame)
	end)

	RemoteUpdate.OnClientEvent:Connect(function(newState)
		currentState = newState
		UpdateDisplay(scrollFrame)
		if not isProcessingPurchase then Kit.Sound:Play("Restock") end
	end)
end

if player.Character then init() else player.CharacterAdded:Wait(); init() end
